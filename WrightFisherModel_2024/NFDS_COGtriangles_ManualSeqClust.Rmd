---
title: "NFDS model with COGtriangles and manual sequence clusters"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
#library(devtools)
#install_github("mrc-ide/dust")
# install.packages("drat") # -- if you don't have drat installed
# drat:::add("ncov-ic")
# or manually download the dust repo, then install from source
# install.packages("/Users/llorenz/Downloads/dust-master", repos = NULL, type="source")
#install.packages("odin.dust",repos = c("https://mrc-ide.r-universe.dev", "https://cloud.r-project.org"))
library(odin.dust)
#install.packages("mcstate")
library(mcstate)
# Package for derivative-free fitting in R:
library(dfoptim)
```

# import data sets from data processing:
```{r}
Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
intermed_gene_presence_absence_consensus <- readRDS(file = "intermed_gene_presence_absence_consensus.rds")
intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
model_start_pop <- readRDS(file = "model_start_pop.rds")
delta_ranking <- readRDS(file = "delta_ranking.rds")
inv_delta_ranking <- readRDS(file = "inv_delta_ranking.rds")
mass_cluster_freq_1 <- readRDS(file = "mass_cluster_freq_1.rds")
mass_cluster_freq_2 <- readRDS(file = "mass_cluster_freq_2.rds")
mass_cluster_freq_3 <- readRDS(file = "mass_cluster_freq_3.rds")
mass_VT <- readRDS(file = "mass_VT.rds")
```


```{r}
WF_nG_h_vP <- odin.dust::odin_dust("NFDS_Model.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)

params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)

params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1789665082, sigma_w = 0.0006039627, prop_f = 0.3669067334 , delta = delta_ranking, m = 0.0078524723 , migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1103623064, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
# try using dfoptim with likelihood
ll_pois <- function(obs, model) {
  exp_noise <- 1e6

  if (is.na(obs)) {
    # Creates vector of zeros in ll with same length, if no data
    ll_obs <- numeric(length(model))
  } else {
    lambda <- model + rexp(n = length(model), rate = exp_noise)
    ll_obs <- dpois(x = obs, lambda = lambda, log = TRUE)
  }
  ll_obs
}

combined_compare <- function(state, observed, pars = NULL) {
  result <- 0
  #data_size <- sum(mass_cluster_freq_1)
  #model_size = 15000
  data_size <- sum(observed)
  model_size = sum(state)
  
  for (i in 1:length(observed)){
    result <- result + ll_pois(observed[i], state[i]/model_size * data_size)
  }
  result
}

#combined_compare <- function(state, observed, pars = NULL) {
#  result <- 0
  #data_size <- sum(mass_cluster_freq_1)
  #model_size = 15000
#  data_size <- sum(observed)
#  model_size = sum(state)
  
#  for (i in 1:length(observed)){
#    result <- result + ll_pois((observed[i]/data_size)*100, (state[i]/model_size)*100)
#  }
#  result
#}

fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}

```

```{r}
optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.326448072 0.001129911 0.384818488 0.011920907 0.187427953

#$value
#[1] -193.3568
```


```{r}
end_params <- rep(0,5)
end_error <- 3
for (i in 1:10) {
  start_params <- runif(5)
  optim_fit <- nmkb(start_params, fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
  if(optim_fit$value < end_error){
    end_error <- optim_fit$value
    end_params <- optim_fit$par
  }
}

#> end_error
#[1] -367.9466
#> end_params
#[1] 0.8745946 0.9441601 0.3326991 0.8484669 0.6790299

# these are not great values --> maybe this fitting does not work as well as hoped and gets stuck in local optimum
```

### prev version COGtriangles gene clusters for comparison
# these are the pre-processed data files that I was using last summer

# import data sets from data processing:
```{r}
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
prev_intermed_gene_presence_absence_consensus_matrix <- sapply(prev_intermed_gene_presence_absence_consensus[,-1],as.double)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
```

#define parameters for the model:
```{r}
prev_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = prev_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
prev_WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = prev_params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
prev_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = prev_delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}
```

```{r}
prev_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), prev_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.091127278 0.001265479 0.133685351 0.008260285 0.035640495

#$value
#[1] -205.9497
```


### PopPUNK

# import PopPUNK data sets

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
PP_intermed_gene_presence_absence_consensus <- readRDS(file = "PP_intermed_gene_presence_absence_consensus.rds")
PP_intermed_gene_presence_absence_consensus_matrix <- sapply(PP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
```

```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)
```

```{r}
WF_PP <- odin.dust::odin_dust("NFDS_Model.R")
```

```{r}
PP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
}
```

```{r}
PP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), PP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.30823650 0.04393502 0.33582177 0.12021641 0.35791045


#$value
#[1] -294.1526
```


### ggCaller with manual Sequence Clusters
# import data sets from data processing:
```{r}
Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
ggC_intermed_gene_presence_absence_consensus <- readRDS(file = "ggC_intermed_gene_presence_absence_consensus.rds")
ggC_intermed_gene_presence_absence_consensus_matrix <- sapply(ggC_intermed_gene_presence_absence_consensus[-1,-1],as.double)
model_start_pop <- readRDS(file = "model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
ggC_inv_delta_ranking <- readRDS(file = "ggC_inv_delta_ranking.rds")
mass_cluster_freq_1 <- readRDS(file = "mass_cluster_freq_1.rds")
mass_cluster_freq_2 <- readRDS(file = "mass_cluster_freq_2.rds")
mass_cluster_freq_3 <- readRDS(file = "mass_cluster_freq_3.rds")
mass_VT <- readRDS(file = "mass_VT.rds")
```

```{r}
WF_ggC <- odin.dust::odin_dust("NFDS_Model.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)

params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = ggC_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
ggC_WFmodel <- WF_ggC$new(pars = params_ggC,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
ggC_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_ggC$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}

```

```{r}
ggC_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggC_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.21366993 0.00176741 0.19665062 0.00977433 0.14496577

#$value
#[1] -184.6705

#better value than COGtriangles + manual seq clusters and COGtriangles + PopPUNK clusters!
```

### ggCaller + PopPUNK

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
ggCPP_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
ggCPP_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
```

```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)
```

# Fitting the model:

```{r}
ggCPP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_ggC$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
}
```

```{r}
ggCPP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggCPP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.138193890 0.008439717 0.199494193 0.024378998 0.155166177

#$value
#[1] -263.3126

# A little worse than ggCaller + manual seq clusters
# but might not be comparable
```

### Visualise Fits:

```{r}
source("CreateLollipopPlot.R")
```

```{r}

#fit_params <- c(2.400584e-01, 9.981659e-05, 2.948024e-01, 7.317635e-03, 9.683020e-02)
#better_fit_params <- c(2.400549e-01, 9.981205e-05, 2.948120e-01, 7.317485e-03, 9.683313e-02)
fit_params <- optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], delta = delta_ranking, m = fit_params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = fit_params[5], vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
model_val1 <- x[,1,1]
model_val2 <- x[,1,37]
model_val3 <- x[,1,73]

model1_VT <- model_val1[which(mass_VT==1)]
model1_NVT <- model_val1[which(mass_VT==0)]
model2_VT <- model_val2[which(mass_VT==1)]
model2_NVT <- model_val2[which(mass_VT==0)]
model3_VT <- model_val3[which(mass_VT==1)]
model3_NVT <- model_val3[which(mass_VT==0)]


### COGtriangles and manual sequence clusters
lollipop_cluster_freqs(plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==1)]/sum(mass_cluster_freq_1), data2 = mass_cluster_freq_2[which(mass_VT==1)]/sum(mass_cluster_freq_2), data3= mass_cluster_freq_3[which(mass_VT==1)]/sum(mass_cluster_freq_3), model1 = model1_VT/sum(model_val1), model2 = model2_VT/sum(model_val2), model3 = model3_VT/sum(model_val3))
lollipop_cluster_freqs(plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==0)]/sum(mass_cluster_freq_1), data2 = mass_cluster_freq_2[which(mass_VT==0)]/sum(mass_cluster_freq_2), data3= mass_cluster_freq_3[which(mass_VT==0)]/sum(mass_cluster_freq_3), model1 = model1_NVT/sum(model_val1), model2 = model2_NVT/sum(model_val2), model3 = model3_NVT/sum(model_val3))
```

```{r}
### COGtriangles and PopPUNK clusters
PP_fit_params <- PP_optim_fit$par
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = PP_fit_params[1], sigma_w = PP_fit_params[2], prop_f = PP_fit_params[3], delta = delta_ranking, m = PP_fit_params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = PP_fit_params[5], vacc_time = 0)
WFmodel_PP <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_PP$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_PP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
PP_model_val1 <- x[,1,1]
PP_model_val2 <- x[,1,37]
PP_model_val3 <- x[,1,73]

PP_model1_VT <- PP_model_val1[which(PP_mass_VT==1)]
PP_model1_NVT <- PP_model_val1[which(PP_mass_VT==0)]
PP_model2_VT <- PP_model_val2[which(PP_mass_VT==1)]
PP_model2_NVT <- PP_model_val2[which(PP_mass_VT==0)]
PP_model3_VT <- PP_model_val3[which(PP_mass_VT==1)]
PP_model3_NVT <- PP_model_val3[which(PP_mass_VT==0)]

### COGtriangles and manual sequence clusters
lollipop_cluster_freqs(plot_title = "Vaccine Types, PopPUNK Clusters", data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_1), data2 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), data3= PP_mass_cluster_freq_3[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_3), model1 = PP_model1_VT/sum(PP_model_val1), model2 = PP_model2_VT/sum(PP_model_val2), model3 = PP_model3_VT/sum(PP_model_val3))
lollipop_cluster_freqs(plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_1), data2 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), data3= PP_mass_cluster_freq_3[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_3), model1 = PP_model1_NVT/sum(PP_model_val1), model2 = PP_model2_NVT/sum(PP_model_val2), model3 = PP_model3_NVT/sum(PP_model_val3))
```

#ggC plot data

```{r}

ggC_fit_params <- ggC_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggC_fit_params[1], sigma_w = ggC_fit_params[2], prop_f = ggC_fit_params[3], delta = ggC_delta_ranking, m = ggC_fit_params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = ggC_fit_params[5], vacc_time = 0)
ggC_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggC_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggC_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggC_model_val1 <- x[,1,1]
ggC_model_val2 <- x[,1,37]
ggC_model_val3 <- x[,1,73]

ggC_model1_VT <- ggC_model_val1[which(mass_VT==1)]
ggC_model1_NVT <- ggC_model_val1[which(mass_VT==0)]
ggC_model2_VT <- ggC_model_val2[which(mass_VT==1)]
ggC_model2_NVT <- ggC_model_val2[which(mass_VT==0)]
ggC_model3_VT <- ggC_model_val3[which(mass_VT==1)]
ggC_model3_NVT <- ggC_model_val3[which(mass_VT==0)]

```

#ggCPP plot data

```{r}

ggCPP_fit_params <- ggCPP_optim_fit$par
ggCPP_fit_params <- c(0.138193890,0.008439717, 0.199494193, 0.024378998, 0.155166177)


all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggCPP_fit_params[1], sigma_w = ggCPP_fit_params[2], prop_f = ggCPP_fit_params[3], delta = ggC_delta_ranking, m = ggCPP_fit_params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = ggCPP_fit_params[5], vacc_time = 0)
ggCPP_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggCPP_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggCPP_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggCPP_model_val1 <- x[,1,1]
ggCPP_model_val2 <- x[,1,37]
ggCPP_model_val3 <- x[,1,73]

ggCPP_model1_VT <- ggCPP_model_val1[which(PP_mass_VT==1)]
ggCPP_model1_NVT <- ggCPP_model_val1[which(PP_mass_VT==0)]
ggCPP_model2_VT <- ggCPP_model_val2[which(PP_mass_VT==1)]
ggCPP_model2_NVT <- ggCPP_model_val2[which(PP_mass_VT==0)]
ggCPP_model3_VT <- ggCPP_model_val3[which(PP_mass_VT==1)]
ggCPP_model3_NVT <- ggCPP_model_val3[which(PP_mass_VT==0)]

```

```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==0)]/sum(mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = model1_NVT/sum(model_val1), model_name_2 = "ggCaller", model2 = ggC_model1_NVT/sum(ggC_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_2[which(mass_VT==0)]/sum(mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = model2_NVT/sum(model_val2), model_name_2 = "ggCaller", model2 = ggC_model2_NVT/sum(ggC_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_3[which(mass_VT==0)]/sum(mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = model3_NVT/sum(model_val3), model_name_2 = "ggCaller", model2 = ggC_model3_NVT/sum(ggC_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==1)]/sum(mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = model1_VT/sum(model_val1), model_name_2 = "ggCaller", model2 = ggC_model1_VT/sum(ggC_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_2[which(mass_VT==1)]/sum(mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = model2_VT/sum(model_val2), model_name_2 = "ggCaller", model2 = ggC_model2_VT/sum(ggC_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_3[which(mass_VT==1)]/sum(mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = model3_VT/sum(model_val3), model_name_2 = "ggCaller", model2 = ggC_model3_VT/sum(ggC_model_val3))
```

### PopPUNK clusters:
```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = PP_model1_NVT/sum(PP_model_val1), model_name_2 = "ggCaller", model2 = ggCPP_model1_NVT/sum(ggCPP_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model2_NVT/sum(PP_model_val2), model_name_2 = "ggCaller", model2 = ggCPP_model2_NVT/sum(ggCPP_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model3_NVT/sum(PP_model_val3), model_name_2 = "ggCaller", model2 = ggCPP_model3_NVT/sum(ggCPP_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = PP_model1_VT/sum(PP_model_val1), model_name_2 = "ggCaller", model2 = ggCPP_model1_VT/sum(ggCPP_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model2_VT/sum(PP_model_val2), model_name_2 = "ggCaller", model2 = ggCPP_model2_VT/sum(ggCPP_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model3_VT/sum(PP_model_val3), model_name_2 = "ggCaller", model2 = ggCPP_model3_VT/sum(ggCPP_model_val3))
```

### Plot VTs and NVT together in one plot
```{r}
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = ggCPP_model_val1/sum(ggCPP_model_val1), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = ggCPP_model_val2/sum(ggCPP_model_val2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = ggCPP_model_val3/sum(ggCPP_model_val3), PP_mass_VT)
```



### THOUGHTS ABOUT THE COMPARABILITY OF LIKELIHOODS
# Question: Does the likelihood decrease with the number of clusters?
# Answer: 

# these two are not the same
# dpois(x = 10, lambda = 11) + dpois(x = 10, lambda = 9)
#dpois(x = 10, lambda = 11, log = TRUE) + dpois(x = 5, lambda = 4, log = TRUE) + dpois(x = 4, lambda = 4, log = TRUE)
# these two are:
# sum(abs(10-11)+sum(9-10))
# sum(abs(10-11)+sum(abs(5-4))+sum(abs(4-4)))


# sum(abs(model_val2/sum(model_val2) - mass_cluster_freq_2/sum(mass_cluster_freq_2))) + sum(abs(model_val3/sum(model_val3) - mass_cluster_freq_3/sum(mass_cluster_freq_3)))
#[1] 0.9182114
#sum(abs(PP_model_val2/sum(PP_model_val2) - PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))) + sum(abs(PP_model_val3/sum(PP_model_val3) - PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3)))
# [1] 0.9997534
#sum(abs(ggCPP_model_val2/sum(ggCPP_model_val2) - PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))) + sum(abs(ggCPP_model_val3/sum(ggCPP_model_val3) - PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3)))
# [1] 0.846745
# sum(abs(ggC_model_val2/sum(ggC_model_val2) - mass_cluster_freq_2/sum(mass_cluster_freq_2))) + sum(abs(ggC_model_val3/sum(ggC_model_val3) - mass_cluster_freq_3/sum(mass_cluster_freq_3)))
# [1] 0.7446736


### filter PopPUNK clusters for max(size(cluster))>1
```{r}
filt_PP_mass_cluster_freq_1 <- readRDS(file = "filt_PP_mass_cluster_freq_1.rds")
filt_PP_mass_cluster_freq_2 <- readRDS(file = "filt_PP_mass_cluster_freq_2.rds")
filt_PP_mass_cluster_freq_3 <- readRDS(file = "filt_PP_mass_cluster_freq_3.rds")
filt_PP_intermed_gene_presence_absence_consensus <- readRDS(file = "filt_PP_intermed_gene_presence_absence_consensus.rds")
filt_PP_intermed_gene_presence_absence_consensus_matrix <-sapply(filt_PP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
filt_PP_mass_VT <- readRDS( file = "filt_PP_mass_VT.rds")
filt_PP_model_start_pop <- readRDS(file = "filt_PP_model_start_pop.rds")
filt_PP_mass_clusters <- length(filt_PP_mass_cluster_freq_1)
filt_PP_avg_cluster_freq <- PP_avg_cluster_freq[apply(matrix(c(PP_mass_cluster_freq_1,PP_mass_cluster_freq_2, PP_mass_cluster_freq_3),nrow=3,ncol=length(PP_mass_cluster_freq_1),byrow = TRUE),2,max)>1]
```

```{r}
filt_PP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}
```

```{r}
filt_PP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), filt_PP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.299432553 0.002611058 0.410155291 0.131020909 0.216579505

#$value
#[1] -276.0369

# slight improvement over unfiltered PopPUNK + COGtriangles
```

# ggCaller with filtered PopPUNK
```{r}
filt_ggCPP_intermed_gene_presence_absence_consensus <-readRDS(file = "filt_ggCPP_intermed_gene_presence_absence_consensus.rds")
filt_ggCPP_intermed_gene_presence_absence_consensus_matrix <-sapply(filt_ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
```

```{r}
filt_ggCPP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}
```

```{r}
filt_ggCPP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), filt_ggCPP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.052109427 0.001694954 0.497849841 0.069497537 0.148361001

#$value
#[1] -278.0763

# not an improvement compared to unfiltered PopPUNK + ggCaller
```

```{r}
### COGtriangles and PopPUNK clusters
filt_PP_fit_params <- filt_PP_optim_fit$par
all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = filt_PP_fit_params[1], sigma_w = filt_PP_fit_params[2], prop_f = filt_PP_fit_params[3], delta = delta_ranking, m = filt_PP_fit_params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = filt_PP_fit_params[5], vacc_time = 0)
WFmodel_PP <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_PP$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_PP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
filt_PP_model_val1 <- x[,1,1]
filt_PP_model_val2 <- x[,1,37]
filt_PP_model_val3 <- x[,1,73]

filt_PP_model1_VT <- filt_PP_model_val1[which(filt_PP_mass_VT==1)]
filt_PP_model1_NVT <- filt_PP_model_val1[which(filt_PP_mass_VT==0)]
filt_PP_model2_VT <- filt_PP_model_val2[which(filt_PP_mass_VT==1)]
filt_PP_model2_NVT <- filt_PP_model_val2[which(filt_PP_mass_VT==0)]
filt_PP_model3_VT <- filt_PP_model_val3[which(filt_PP_mass_VT==1)]
filt_PP_model3_NVT <- filt_PP_model_val3[which(filt_PP_mass_VT==0)]
```

#filtered ggCPP plot data

```{r}

filt_ggCPP_fit_params <- filt_ggCPP_optim_fit$par
all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = filt_ggCPP_fit_params[1], sigma_w = filt_ggCPP_fit_params[2], prop_f = filt_ggCPP_fit_params[3], delta = ggC_delta_ranking, m = filt_ggCPP_fit_params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = filt_ggCPP_fit_params[5], vacc_time = 0)
ggCPP_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggCPP_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggCPP_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
filt_ggCPP_model_val1 <- x[,1,1]
filt_ggCPP_model_val2 <- x[,1,37]
filt_ggCPP_model_val3 <- x[,1,73]

filt_ggCPP_model1_VT <- filt_ggCPP_model_val1[which(filt_PP_mass_VT==1)]
filt_ggCPP_model1_NVT <- filt_ggCPP_model_val1[which(filt_PP_mass_VT==0)]
filt_ggCPP_model2_VT <- filt_ggCPP_model_val2[which(filt_PP_mass_VT==1)]
filt_ggCPP_model2_NVT <- filt_ggCPP_model_val2[which(filt_PP_mass_VT==0)]
filt_ggCPP_model3_VT <- filt_ggCPP_model_val3[which(filt_PP_mass_VT==1)]
filt_ggCPP_model3_NVT <- filt_ggCPP_model_val3[which(filt_PP_mass_VT==0)]

```

### filtered PopPUNK clusters:
```{r}
# Plot NVTs
lollipop_cluster_freqs_3points(year = "2001", plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_1[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = filt_PP_model1_NVT/sum(filt_PP_model_val1), model_name_2 = "ggCaller", model2 = filt_ggCPP_model1_NVT/sum(filt_ggCPP_model_val1))
lollipop_cluster_freqs_3points(year = "2004",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model2_NVT/sum(filt_PP_model_val2), model_name_2 = "ggCaller", model2 = filt_ggCPP_model2_NVT/sum(filt_ggCPP_model_val2))
lollipop_cluster_freqs_3points(year = "2007",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model3_NVT/sum(filt_PP_model_val3), model_name_2 = "ggCaller", model2 = filt_ggCPP_model3_NVT/sum(filt_ggCPP_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_3points(year = "2001", plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_1[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = filt_PP_model1_VT/sum(filt_PP_model_val1), model_name_2 = "ggCaller", model2 = filt_ggCPP_model1_VT/sum(filt_ggCPP_model_val1))
lollipop_cluster_freqs_3points(year = "2004",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model2_VT/sum(filt_PP_model_val2), model_name_2 = "ggCaller", model2 = filt_ggCPP_model2_VT/sum(filt_ggCPP_model_val2))
lollipop_cluster_freqs_3points(year = "2007",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model3_VT/sum(filt_PP_model_val3), model_name_2 = "ggCaller", model2 = filt_ggCPP_model3_VT/sum(filt_ggCPP_model_val3))
```


## data exploration: how much do the vt-frequencies within clusters change?
```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
meanPP_VT_2001 <- rep(0, PP_mass_clusters)
meanPP_VT_2004 <- rep(0, PP_mass_clusters)
meanPP_VT_2007 <- rep(0, PP_mass_clusters)
for (i in 1:PP_mass_clusters){
     meanPP_VT_2001[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2001 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
for (i in 1:PP_mass_clusters){
     meanPP_VT_2004[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2004 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
for (i in 1:PP_mass_clusters){
     meanPP_VT_2007[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2007 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
plot(meanPP_VT_2001)
points(meanPP_VT_2004, col = "#E69F00")
points(meanPP_VT_2007, col = "#56B4E9")
```

```{r}
# checking the ones that are somewhere btw 0 and 1 in 2001:
meanPP_VT_2001
meanPP_VT_2001[2]
meanPP_VT_2004[2]
meanPP_VT_2007[2]
meanPP_VT_2001[22]
meanPP_VT_2004[22]
meanPP_VT_2007[22]

# so, at least for the PopPUNK clusters there are really only two sequence clusters that start at intermediate VT-frequency. 
# it might be interesting to see whether the fit improves if I am trying to pay respect to these two clusters, but I am not expecting to get a fit that is that much better
```

# similarly for the manSeqClusters"
```{r}
meanManSQ_VT_2001 <- rep(0, mass_clusters)
meanManSQ_VT_2004 <- rep(0, mass_clusters)
meanManSQ_VT_2007 <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
     meanManSQ_VT_2001[i] <- mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2001,"Vaccine Type"]=="VT"))
}
for (i in 1:mass_clusters){
     meanManSQ_VT_2004[i] <- mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2004,"Vaccine Type"]=="VT"))
}
for (i in 1:mass_clusters){
     meanManSQ_VT_2007[i] <- mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2007,"Vaccine Type"]=="VT"))
}

# there are 3 clusters that begin with intermediate-VT frequency
meanManSQ_VT_2001[1]
meanManSQ_VT_2004[1]
meanManSQ_VT_2007[1]
meanManSQ_VT_2001[2]
meanManSQ_VT_2004[2]
meanManSQ_VT_2007[2]
meanManSQ_VT_2001[10]
meanManSQ_VT_2004[10]
meanManSQ_VT_2007[10]
```




### Investigate serotype vs. sequence clusters

# check serotypes and manual sequence clusters - how much overlap is there between them?
```{r}
length(unique(Mass_Samples_accCodes$Serotype)) # 32
length(unique(Mass_Samples_accCodes$SequenceCluster)) # 41
serotype_diversity <- rep(0, mass_clusters)
for (i in 1:mass_clusters) {
  serotype_diversity[i] <- length(unique(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster==i-1,]$Serotype))
}
# serotype_diversity
# [1] 8 3 1 2 1 4 3 1 4 4 1 1 1 3 1 2 1 2 3 1 1 2 1 2 1 2 2 1 1 1 2 1 1 1 2 1 1 1 1 3 1
# so, the clusters consist of 1 - 8 different serotypes
cluster_diversity <- rep(0, length(unique(Mass_Samples_accCodes$Serotype)))
for (i in 1:length(unique(Mass_Samples_accCodes$Serotype))) {
  cluster_diversity[i] <- length(unique(Mass_Samples_accCodes[Mass_Samples_accCodes$Serotype==unique(Mass_Samples_accCodes$Serotype)[i],]$SequenceCluster))
}
# cluster_diversity
# [1] 3 2 2 2 5 3 2 8 1 1 1 1 4 2 2 2 1 2 4 3 6 4 4 1 1 1 1 2 1 1 2 1
# the serotypes consist of 1-8 sequence clusters
```

```{r}
# first impression is that serotype and cluster definitions are quite different
# install.packages("Polychrome")
library(Polychrome)
# build-in color palette
Glasbey = glasbey.colors(32)
#swatch(Glasbey)
names(Glasbey) <- unique(Mass_Samples_accCodes$Serotype)


ggplot(Mass_Samples_accCodes, aes(fill=Serotype, y=1, x=SequenceCluster)) + 
  geom_bar(position='stack', stat='identity')


ggplot(Mass_Samples_accCodes, aes(fill=SequenceCluster, y=1, x=Serotype)) + 
  geom_bar(position='stack', stat='identity')
```

# now use the serotypes instead of clusters
# import data sets from data processing:
```{r}
#Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
Sero_intermed_gene_presence_absence_consensus <- readRDS(file = "Sero_intermed_gene_presence_absence_consensus.rds")
Sero_intermed_gene_presence_absence_consensus_matrix <- sapply(Sero_intermed_gene_presence_absence_consensus[-1,-1],as.double)
Sero_model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
Sero_freq_1 <- readRDS(file = "Sero_freq_1.rds")
Sero_freq_2<- readRDS(file = "Sero_freq_2.rds")
Sero_freq_3 <- readRDS(file = "Sero_freq_3.rds")
Sero_mass_VT <- readRDS(file = "Sero_mass_VT.rds")
```

#define parameters for the model:
```{r}
mass_serotypes <- length(unique(Mass_Samples_accCodes$Serotype))
avg_sero_freq <- rep(1/mass_serotypes, mass_serotypes)

params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.1321567425, vacc_time = 0)
```

```{r}
sero_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],Sero_freq_2) + combined_compare(x[,1,73],Sero_freq_3) 
}

```

```{r}
sero_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), sero_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.38251173 0.00518133 0.31922936 0.03974063 0.23900668

#$value
#[1] -205.9478
```

```{r}

sero_fit_params <- sero_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = sero_fit_params[1], sigma_w = sero_fit_params[2], prop_f = sero_fit_params[3], delta = delta_ranking, m = sero_fit_params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = sero_fit_params[5], vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
sero_model_val1 <- x[,1,1]
sero_model_val2 <- x[,1,37]
sero_model_val3 <- x[,1,73]

sero_model1_VT <- sero_model_val1[which(Sero_mass_VT==1)]
sero_model1_NVT <- sero_model_val1[which(Sero_mass_VT==0)]
sero_model2_VT <- sero_model_val2[which(Sero_mass_VT==1)]
sero_model2_NVT <- sero_model_val2[which(Sero_mass_VT==0)]
sero_model3_VT <- sero_model_val3[which(Sero_mass_VT==1)]
sero_model3_NVT <- sero_model_val3[which(Sero_mass_VT==0)]
```

### ggCaller and serotypes:

```{r}
#Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
ggCsero_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCsero_intermed_gene_presence_absence_consensus.rds")
ggCsero_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCsero_intermed_gene_presence_absence_consensus[-1,-1],as.double)
Sero_model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
#Sero_freq_1 <- readRDS(file = "Sero_freq_1.rds")
#Sero_freq_2<- readRDS(file = "Sero_freq_2.rds")
#Sero_freq_3 <- readRDS(file = "Sero_freq_3.rds")
#Sero_mass_VT <- readRDS(file = "Sero_mass_VT.rds")
```

# import data sets from data processing:
```{r}
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
```

#define parameters for the model:
```{r}
ggCsero_params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = ggC_delta_ranking, m = 0.0052207254, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.1321567425, vacc_time = 0)
```


```{r}
ggCsero_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],Sero_freq_2) + combined_compare(x[,1,73],Sero_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}

```

```{r}
ggCsero_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggCsero_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.413061811 0.006497421 0.099712391 0.062105898 0.323338547


#$value
#[1] -209.249

#better value than COGtriangles + manual seq clusters and COGtriangles + PopPUNK clusters!
```

#ggCsero plot data

```{r}
ggCsero_fit_params <- ggCsero_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggCsero_fit_params[1], sigma_w = ggCsero_fit_params[2], prop_f = ggCsero_fit_params[3], delta = ggC_delta_ranking, m = ggCsero_fit_params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = ggCsero_fit_params[5], vacc_time = 0)
ggC_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggC_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggC_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggCsero_model_val1 <- x[,1,1]
ggCsero_model_val2 <- x[,1,37]
ggCsero_model_val3 <- x[,1,73]

ggCsero_model1_VT <- ggCsero_model_val1[which(Sero_mass_VT==1)]
ggCsero_model1_NVT <- ggCsero_model_val1[which(Sero_mass_VT==0)]
ggCsero_model2_VT <- ggCsero_model_val2[which(Sero_mass_VT==1)]
ggCsero_model2_NVT <- ggCsero_model_val2[which(Sero_mass_VT==0)]
ggCsero_model3_VT <- ggCsero_model_val3[which(Sero_mass_VT==1)]
ggCsero_model3_NVT <- ggCsero_model_val3[which(Sero_mass_VT==0)]
```

# Create new Lollipop plots that split the COGtriangles and ggCaller into two rows
```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_1[which(Sero_mass_VT==0)]/sum(Sero_freq_1), model_name_1 = "COGtriangles",model1 = sero_model1_NVT/sum(sero_model_val1), model_name_2 = "ggCaller", model2 = ggCsero_model1_NVT/sum(ggCsero_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_2[which(Sero_mass_VT==0)]/sum(Sero_freq_2), model_name_1 = "COGtriangles", model1 = sero_model2_NVT/sum(sero_model_val2), model_name_2 = "ggCaller", model2 = ggCsero_model2_NVT/sum(ggCsero_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_3[which(Sero_mass_VT==0)]/sum(Sero_freq_3), model_name_1 = "COGtriangles", model1 = sero_model3_NVT/sum(sero_model_val3), model_name_2 = "ggCaller", model2 = ggCsero_model3_NVT/sum(ggCsero_model_val3))
```


```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_1[which(Sero_mass_VT==1)]/sum(Sero_freq_1), model_name_1 = "COGtriangles",model1 = sero_model1_VT/sum(sero_model_val1), model_name_2 = "ggCaller", model2 = ggCsero_model1_VT/sum(ggCsero_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_2[which(Sero_mass_VT==1)]/sum(Sero_freq_2), model_name_1 = "COGtriangles", model1 = sero_model2_VT/sum(sero_model_val2), model_name_2 = "ggCaller", model2 = ggCsero_model2_VT/sum(ggCsero_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_3[which(Sero_mass_VT==1)]/sum(Sero_freq_3), model_name_1 = "COGtriangles", model1 = sero_model3_VT/sum(sero_model_val3), model_name_2 = "ggCaller", model2 = ggCsero_model3_VT/sum(ggCsero_model_val3))
```

### create model version with 616 compartments (one per individual sequence)
```{r}
mass_seq_freq_1 <- readRDS("mass_seq_freq_1.rds")
mass_seq_freq_2 <- readRDS("mass_seq_freq_2.rds")
mass_seq_freq_3 <- readRDS("mass_seq_freq_3.rds")
seq_model_start_pop <- readRDS("seq_model_start_pop.rds") 
seq_model_start_pop_2 <- readRDS("seq_model_start_pop_2.rds")
# the two start populations differ in the amount of noise that has been added
# the first one has more than the second 
mass_seq_VT <- readRDS("mass_seq_VT.rds")
```

# COGtriangles version
```{r}
intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence[-1,-1],as.double)
```

```{r}
mass_seqs <- nrow(Mass_Samples_accCodes)
avg_mass_seqs <- rep(1/mass_seqs, mass_seqs)

seq_params_n_vP <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), v = 0.1321567425, vacc_time = 0)

seq_WFmodel <- WF_nG_h_vP$new(pars = seq_params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
Mass_samples_index_dict <- 1:nrow(Mass_Samples_accCodes)
names(Mass_samples_index_dict) <- Mass_Samples_accCodes$`Isolate Name`

# summarize single-sequence clusters into PP clusters
sum_seq_clusters <- function(sequence_clust){
  clustered_seqs <- rep(0, PP_mass_clusters)
  for (i in 1:PP_mass_clusters) {
    clustered_seqs[i] <- sum(sequence_clust[Mass_samples_index_dict[PopPUNK_clusters[PopPUNK_clusters$Cluster==i,]$IsolateName]])
  }
  clustered_seqs
}

#PopPUNK_clusters
PP_combined_compare_616 <- function(state, observed, pars = NULL) {
  result <- 0
  data_size <- sum(observed)
  model_size = sum(state)
  
  # need to summarize the data and the observations into clusters
  clustered_state <- sum_seq_clusters(state)
  clustered_obs <- sum_seq_clusters(observed)
  
  for (i in 1:length(clustered_obs)){
    result <- result + ll_pois(clustered_obs[i], clustered_state[i]/model_size * data_size)
  }
  result
}

NFDS_fitting_closure_616 <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
    params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
    WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
    n_particles <- 10L
    n_times <- 73
    x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

    for (t in seq_len(n_times)) {
      x[ , , t] <- WFmodel$run(t)
    }
    time <- x[1, 1, ]
    x <- x[-1, , ]
    PP_combined_compare_616(x[,1,37],data1) + PP_combined_compare_616(x[,1,73],data2) 
  }
}
```

```{r}
COGPP_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, delta = delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

COGPP_fitting_616 <- NFDS_fitting_closure_616(COGPP_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

fit_616 <- nmkb(start_params, COGPP_fitting_616, lower=c(0.055,0,0,0,0), upper=c(1,0.055,1,1,1), control = c(maximize = TRUE, trace = TRUE))

#$par
#[1] 0.10461712 0.05499699 0.12309585 0.72932605 0.97526777

#$value
#[1] -188.9444

start_p <- rep(0,10)
start_w <- rep(0,10)
start_prop <- rep(0,10)
end_p <- rep(0,10)
end_w <- rep(0,10)
end_prop <- rep(0,10)
start_m <- rep(0,10)
start_v <- rep(0,10)
end_m <- rep(0,10)
end_v <- rep(0,10)
end_error <- rep(0,10)
for (i in 1:10) {
  start_params <- runif(5)
  fit_616 <- nmkb(start_params, ggCPP_fitting_616, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE, trace = TRUE))
  end_error[i] <- fit_616$value
  end_p[i] <- fit_616$par[1]
  end_w[i] <- fit_616$par[2]
  end_prop[i] <- fit_616$par[3]
  end_m[i] <- fit_616$par[4]
  end_v[i] <- fit_616$par[5]
  
  start_p[i] <- start_params[1]
  start_w[i] <- start_params[2]
  start_prop[i] <- start_params[3]
  start_m[i] <- start_params[4]
  start_v[i] <- start_params[5]
}
```

```{r}
# only seven runs, which already took an hour or so
#> end_error
# [1] -269.2086 -267.4982 -269.9346 -267.8150 -268.5025 -270.1028 -265.8139    0.0000    0.0000    0.0000
#> end_p
# [1] 0.695418564 0.880586639 0.995642865 0.172117022 0.350358448 0.341518580 0.001895943 0.000000000 0.000000000 0.000000000
#> end_w
# [1] 0.09528001 0.16557455 0.97558824 0.26675343 0.37023268 0.90908575 0.08035755 0.00000000 0.00000000 0.00000000
#> end_prop
# [1] 0.919970171 0.001408166 0.424236528 0.340439155 0.388935327 0.998642027 0.822636697 0.000000000 0.000000000 0.000000000
#> end_m
# [1] 0.9092072 0.7310387 0.9928808 0.8810217 0.9177145 0.9542316 0.7865585 0.0000000 0.0000000 0.0000000
#> end_v
# [1] 0.9944368 0.8493109 0.9018145 0.6526372 0.9294109 0.6186854 0.9969169 0.0000000 0.0000000 0.0000000
#> start_p
# [1] 0.1043812 0.5933345 0.9334867 0.3675858 0.4993742 0.2117662 0.2748254 0.0000000 0.0000000 0.0000000
#> start_w
# [1] 0.52289973 0.32520405 0.70701398 0.34342386 0.08975637 0.82618422 0.31166237 0.00000000 0.00000000 0.00000000
#> start_prop
# [1] 0.49302235 0.03924397 0.34615051 0.24132111 0.68209792 0.96136825 0.87793033 0.00000000 0.00000000 0.00000000
#> start_m
# [1] 0.6302457 0.6323589 0.8953097 0.8982296 0.6935370 0.9034749 0.6929284 0.0000000 0.0000000 0.0000000
#> start_v
# [1] 0.8896970 0.7250780 0.3615256 0.2809701 0.3773499 0.4795797 0.9857552 0.0000000 0.0000000 0.0000000
```

```{r}
plot_end_p <- c(0.695418564, 0.880586639, 0.995642865, 0.172117022, 0.350358448, 0.341518580, 0.001895943)
plot_end_w <- c(0.09528001, 0.16557455, 0.97558824, 0.26675343, 0.37023268, 0.90908575, 0.08035755)
plot_end_prop <- c(0.919970171, 0.001408166, 0.424236528, 0.340439155, 0.388935327, 0.998642027, 0.822636697)
plot_end_m <- c(0.9092072, 0.7310387, 0.9928808, 0.8810217, 0.9177145, 0.9542316, 0.7865585)
plot_end_v <- c(0.9944368, 0.8493109, 0.9018145, 0.6526372, 0.9294109, 0.6186854, 0.9969169)

plot_start_p <- c(0.1043812, 0.5933345, 0.9334867, 0.3675858, 0.4993742, 0.2117662, 0.2748254)
plot_start_w <- c(0.52289973, 0.32520405, 0.70701398, 0.34342386, 0.08975637, 0.82618422, 0.31166237)
plot_start_prop <- c(0.49302235, 0.03924397, 0.34615051, 0.24132111, 0.68209792, 0.96136825, 0.87793033)
plot_start_m <- c(0.6302457, 0.6323589, 0.8953097, 0.8982296, 0.6935370, 0.9034749, 0.6929284)
plot_start_v <- c(0.8896970, 0.7250780, 0.3615256, 0.2809701, 0.3773499, 0.4795797, 0.9857552)
plot(1:7, plot_end_p,  pch = 19)
points(plot_end_w, col = "#E69F00", pch = 19)
points(plot_end_prop, col = "#56B4E9", pch = 19)
points(plot_end_m, col = "#009E73", pch = 19)
points(plot_end_v, col = "#F0E442", pch = 19)
lines(plot_end_p)
lines(plot_end_w, col = "#E69F00",)
lines(plot_end_prop, col = "#56B4E9")
lines(plot_end_m, col = "#009E73")
lines(plot_end_v, col = "#F0E442")
points(plot_start_p, pch = 17)
points(plot_start_w, col = "#E69F00", pch = 17)
points(plot_start_prop, col = "#56B4E9", pch = 17)
points(plot_start_m, col = "#009E73", pch = 17)
points(plot_start_v, col = "#F0E442", pch = 17)
```

# evaluate on manual sequence clusters instead
```{r}
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
  clustered_seqs <- rep(0, mass_clusters)
  for (i in 1:mass_clusters) {
    clustered_seqs[i] <- sum(sequence_clust[which(Mass_Samples_accCodes$SequenceCluster==i)])
  }
  clustered_seqs
}

#manual sequence clusters
combined_compare_616 <- function(state, observed, pars = NULL) {
  result <- 0
  data_size <- sum(observed)
  model_size = sum(state)
  
  # need to summarize the data and the observations into clusters
  clustered_state <- sum_seq_man_clusters(state)
  clustered_obs <- sum_seq_man_clusters(observed)
  
  for (i in 1:length(clustered_obs)){
    result <- result + ll_pois(clustered_obs[i], clustered_state[i]/model_size * data_size)
  }
  result
}

NFDS_fitting_closure_616_man <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
    params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
    WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
    n_particles <- 10L
    n_times <- 73
    x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

    for (t in seq_len(n_times)) {
      x[ , , t] <- WFmodel$run(t)
    }
    time <- x[1, 1, ]
    x <- x[-1, , ]
    combined_compare_616(x[,1,37],data1) + combined_compare_616(x[,1,73],data2) 
  }
}
```

```{r}
COG_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, delta = delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

COG_fitting_616 <- NFDS_fitting_closure_616_man(COG_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

man_fit_616 <- nmkb(start_params, COG_fitting_616, lower=c(0.055,0,0,0,0), upper=c(1,0.055,1,1,1), control = c(maximize = TRUE, trace = TRUE))

#$par
#[1] 0.0607118499 0.0530314041 0.0001057576 0.7724929778 0.9902405314

#$value
#[1] -142.7887
```

# ggCaller version
```{r}
ggC_intermed_gene_presence_absence <- readRDS("ggC_intermed_gene_presence_absence.rds")
ggC_intermed_gene_presence_absence_matrix <- sapply(ggC_intermed_gene_presence_absence[-1,-1],as.double)
```

```{r}
ggCPP_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_matrix, delta = ggC_delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

ggCPP_fitting_616 <- NFDS_fitting_closure_616(ggCPP_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

ggCPP_fit_616 <- nmkb(start_params, ggCPP_fitting_616, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))

#$par
#[1] 0.005014889 0.022394344 0.822039194 0.557391976 0.834516365

#$value
#[1] -187.8815
```

```{r}
gCC_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_matrix, delta = ggC_delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

gCC_fitting_616 <- NFDS_fitting_closure_616_man(gCC_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

gCC_man_fit_616 <- nmkb(start_params, gCC_fitting_616, lower=c(0.055,0,0,0,0), upper=c(1,0.055,1,1,1), control = c(maximize = TRUE, trace = TRUE))

#$par
#[1] 0.0550442470 0.0548071213 0.0000829429 0.6642395068 0.9333139271

#$value
#[1] -141.187
```

### NULL MODEL
```{r}
WF_null <- odin.dust::odin_dust("null_NFDS_Model.R")
```

# Fitting the model:

```{r}
fitting_closure <- function(all_other_params, data1, data2){
  null_fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, m = fit_params[1], v = fit_params[2])
  null_WFmodel <- WF_null$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(null_WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- null_WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0)

fit_null_ggCPP <- fitting_closure(null_ggCPP_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

null_ggCPP_optim_fit <- nmkb(c(0.03, 0.05), fit_null_ggCPP, lower=c(0,0), upper=c(1,1), control = c(maximize = TRUE))
#$par
#[1] 0.01172671 0.01913524

#$value
#[1] -295.7375

# A little worse than ggCaller + PopPUNK non-null (but actually not so much worse...)
```

```{r}
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0)

fit_null_man <- fitting_closure(null_man_params, mass_cluster_freq_2, mass_cluster_freq_3)

null_man_optim_fit <- nmkb(c(0.03, 0.05), fit_null_man, lower=c(0,0), upper=c(1,1), control = c(maximize = TRUE))
#$par
#[1] 0.008636252 0.024126479

#$value
#[1] -239.5123
```

# try simulated annealing instead of dfoptim
```{r}
# install.packages("optimization")
library(optimization)


null_man_sa <- optim_sa(fun = fit_null_man, start = c(0.008636252, 0.024126479), maximization = TRUE, trace = TRUE,lower=c(0,0), upper=c(1,1), control = c(rf = 2))
#$par
#[1] 0.01 0.04

#$function_value
#[1] -252.2131
```

```{r}
start_m <- rep(0,10)
start_v <- rep(0,10)
end_m <- rep(0,10)
end_v <- rep(0,10)
end_error <- rep(0,10)
for (i in 1:10) {
  start_params <- runif(2)
  null_man_sa <- optim_sa(fun = fit_null_man, start = start_params, maximization = TRUE, trace = FALSE,lower=c(0,0), upper=c(1,1), control = c(rf = 3, r = 0.8))
  end_error[i] <- null_man_sa$function_value
  end_m[i] <- null_man_sa$par[1]
  end_v[i] <- null_man_sa$par[2]
  start_m[i] <- start_params[1]
  start_v[i] <- start_params[2]
}

# best:
# -241.3298
# end params
# 0.006305697 0.01630453
# start params
# 0.98630570 0.8363045314
```

```{r}
NFDS_fitting_closure <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
  WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, delta = ggC_delta_ranking, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0)

ggCPP_fitting <- NFDS_fitting_closure(ggCPP_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

null_man_sa <- optim_sa(fun = ggCPP_fitting, start = start_params, maximization = TRUE, trace = TRUE,lower=c(0.05,0,0,0,0), upper=c(1,0.05,1,1,1), control = c(rf = 2, r = 0.6))

# took really long (10 mins?)
# and produced weird results:
# $par
#[1] 0.25 0.01 0.22 0.02 0.24

#$function_value
#[1] -258.0113

# 42 iterations (not so much for so much time?)
# maybe issue with sigma_w and sigma_f? maybe I should force the smaller one to be small

#$par
#[1] 0.12 0.00 0.49 0.04 0.25

#$function_value
#[1] -246.5182
```

# Visualise cluster frequency changes for ggplot / PopPUNK
```{r}
# plot cluster freq coloured by vacc type, non VT and mixed
#create colour-vector based on VT mean info
plot_VT_colours <- rep("black",PP_mass_clusters)
for (i in 1:PP_mass_clusters){
  if(PP_mass_VT[i] ==1){
    plot_VT_colours[i] <- "#E69F00"
  }
  else if(PP_mass_VT[i] ==0){
    plot_VT_colours[i] <- "#56B4E9"
  }
}


par(mfrow=c(1,1))
op <- par(mar = c(5,7,4,2) + 0.1,mgp=c(3,1,0))
plot(PP_mass_cluster_freq_1 / sum(PP_mass_cluster_freq_1), PP_mass_cluster_freq_3 / sum(PP_mass_cluster_freq_3), type = "n", axes = FALSE, ann = FALSE, pch = 19, col = plot_VT_colours, cex = 2.5, ylim = c(0,0.18), xlim = c(0,0.18))
abline(a=0, b=1)
points(PP_mass_cluster_freq_1 / sum(PP_mass_cluster_freq_1), PP_mass_cluster_freq_3 / sum(PP_mass_cluster_freq_3), col = plot_VT_colours, pch = 19, cex = 2.5, ylim = c(0,0.18), xlim = c(0,0.18))
legend("topleft", title = "Clusters", c("VT", "Non-VT"),fill = c("#E69F00", "#56B4E9"), cex = 2)
axis(1,cex.axis = 2.5)
axis(2, cex.axis = 2.5)
title(xlab = "Pre-vaccine cluster frequency", cex.lab=2.5)
title(ylab = "Post-vaccine cluster frequency", cex.lab = 2.5,
      line = 4.5)
box()
par(op)
```

```{r}
### ggCaller
ggCaller_gene_presence_absence_2001 <- readRDS(file = "ggCaller_gene_presence_absence_2001.rds")
ggCaller_gene_presence_absence_2004 <- readRDS(file = "ggCaller_gene_presence_absence_2004.rds")
ggCaller_gene_presence_absence_2007 <- readRDS(file = "ggCaller_gene_presence_absence_2007.rds")

sum_as_int <- function(x){
  sum(as.integer(x))
}

gene_cluster_counts_2001 <- apply(ggCaller_gene_presence_absence_2001[-1,-1],1,sum_as_int)/(ncol(ggCaller_gene_presence_absence_2001)-1)
gene_cluster_counts_2007 <- apply(ggCaller_gene_presence_absence_2007[-1,-1],1,sum_as_int)/(ncol(ggCaller_gene_presence_absence_2007)-1)

par(mar=c(5,6,4,1)+.1)
plot((gene_cluster_counts_2001), gene_cluster_counts_2007, pch = 21, xlab = "Pre-vaccine COG frequency", ylab = "Post-vaccine COG frequency",cex.lab=2.5, cex.axis = 2.5, cex = 1.5, ylim = c(0,1), xlim = c(0,1),col='#000000')
# col='#00000090' for 90% opacity
abline(a=0, b=1)

```

### try out finding the important genes for NFDS for ggCPP
```{r}
# create a vector with randomly distributed zeros and ones of the length of the number of genes and the number of ones determined by prop_f
nfds_gene_bool <- rbinom(nrow(ggC_intermed_gene_presence_absence_consensus)-1,1,0.3)
```

```{r}
WF_findGenes <- odin.dust::odin_dust("NFDS_Model_FindGenes.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

```{r}
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3, delta_bool = as.double(nfds_gene_bool), m = 0.005, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.05, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_findGenes <- WF_findGenes$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
# WFmodel_findGenes$run(10)
```

# maybe try fitting with dfoptim?
# create gene_bool_vectors
# idea: create vectors where 25 percent are 1, the rest 0
# then find the genes that are "on" (=1) in the best fits
# 25 percent for ggCaller are 71 genes (1774/25 ~= 71)
```{r}
find_genes_df <- data.frame(matrix(0,nrow = nrow(ggC_intermed_gene_presence_absence_consensus)-1, ncol = 50))
for (i in 1:25) {
  find_genes_df[,i] <- rep(c(rep(0,24),1),75)[i:(nrow(ggC_intermed_gene_presence_absence_consensus)-2 + i)]
  find_genes_df[,i+25] <- c(rep(0,1703),rep(1,71),rep(0,1703))[(1 + (i-1) * 71) : (nrow(ggC_intermed_gene_presence_absence_consensus)-1 + (i-1) * 71)]
}
```

```{r}
fitting_closure_FindGenes <- function(all_other_params, data1, data2){
  null_fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, sigma_f = fit_params[1], m = fit_params[2], v = fit_params[3])
  WF_findGenes_model <- WF_findGenes$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WF_findGenes_model$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WF_findGenes_model$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
FindGenes_all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3, delta_bool = as.double(nfds_gene_bool), m = 0.005, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.05, vacc_time = 0)

fit_FindGenes_ggCPP <- fitting_closure_FindGenes(FindGenes_all_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

FindGenes_ggCPP_optim_fit <- nmkb(c(0.15, 0.03, 0.05), fit_FindGenes_ggCPP, lower=c(0,0,0), upper=c(1,1,1), control = c(maximize = TRUE))
```

```{r}
for (i in 1:10){
  FindGenes_all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3, delta_bool = as.double(find_genes_df[,i]), m = 0.005, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.05, vacc_time = 0)

fit_FindGenes_ggCPP <- fitting_closure_FindGenes(FindGenes_all_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

FindGenes_ggCPP_optim_fit <- nmkb(c(0.15, 0.03, 0.05), fit_FindGenes_ggCPP, lower=c(0,0,0), upper=c(1,1,1), control = c(maximize = TRUE))
print(FindGenes_ggCPP_optim_fit$par)
print(FindGenes_ggCPP_optim_fit$value)
}
```

### Comparing different models using abs error
```{r}
# COG man seq clusters
params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1789665082, sigma_w = 0.0006039627, prop_f = 0.3669067334 , delta = delta_ranking, m = 0.0078524723 , migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1103623064, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))
# [1] 0.407629
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMean2/sum(simMean2)))
# [1] 0.7558528
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))/mass_clusters
# [1] 0.009942172

### COG PopPUNK
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1764665767, sigma_w = 0.0005367709, prop_f = 0.437293239, delta = delta_ranking, m = 0.0114977275, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1135499700, vacc_time = 0)
WFmodel_PP <- WF_nG_h_vP$new(pars = all_params,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanPP2 <- rowMeans(WFmodel_PP$run(36)[-1,])
simMeanPP3 <- rowMeans(WFmodel_PP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))
# [1] 0.4440668
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanPP2/sum(simMeanPP2)))
# [1] 0.8750077
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))/PP_mass_clusters
# [1] 0.007162368

### ggCaller man seq clusters
params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1882242231, sigma_w = 0.0003669121, prop_f = 0.2161135322, delta = ggC_delta_ranking, m = 0.0059668667, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1377344552, vacc_time = 0)
WFmodel_ggCmanSeqCl <- WF_nG_h_vP$new(pars = params_ggC,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggC2 <- rowMeans(WFmodel_ggCmanSeqCl$run(36)[-1,])
simMeanggC3 <- rowMeans(WFmodel_ggCmanSeqCl$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))
# [1] 0.3908194
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMeanggC2/sum(simMeanggC2)))
# [1] 0.7078664
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))/mass_clusters
# [1] 0.009532182

### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1180783495, sigma_w = 0.0004164005, prop_f = 0.3803173188, delta = ggC_delta_ranking, m = 0.0117180887, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1509501052, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))
# [1] 0.4220826
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanggCPP2/sum(simMeanggCPP2)))
# [1] 0.8474369
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))/PP_mass_clusters
# [1] 0.006807784
```

```{r}
PP_manSeq_clusters_df <- data.frame(matrix(Mass_Samples_accCodes$`Isolate Name`,nrow = nrow(Mass_Samples_accCodes),ncol = 1))
PP_manSeq_clusters_df[,2] <- Mass_Samples_accCodes$SequenceCluster
PP_manSeq_clusters_df[,3] <- PP_Mass_seq_clusters_dict[Mass_Samples_accCodes$`Isolate Name`]
colnames(PP_manSeq_clusters_df) <- c("Isolate_Name","manSeqCl","PP")

# create dictionary to translate between PopPUNK and man seq clusters
PP_to_manSeq_dict <- rep(0,PP_mass_clusters)
for (i in 1:PP_mass_clusters) {
     PP_to_manSeq_dict[i] <- unique(PP_manSeq_clusters_df$manSeqCl[which(PP_manSeq_clusters_df$PP==i)])
}  
names(PP_to_manSeq_dict) <- 1:PP_mass_clusters

# plot man seq cluster composition
PP_manSeqCl_plt_data <- table(PP_manSeq_clusters_df$PP,PP_manSeq_clusters_df$manSeqCl)


#ggplot(PP_manSeq_clusters_df, aes(fill=condition, y=value, x=specie)) + 
#    geom_bar(position="stack", stat="identity")
#library("colorspace")
#install.packages("viridis")
library("viridis") 
barplot(PP_manSeqCl_plt_data, main="PopPUNK cluster distribution in manSeqCl",
   xlab="Manual Sequence CLusters", col = viridis(PP_mass_clusters), legend = rownames(PP_manSeqCl_plt_data),args.legend = c(x = 60, y = 100, ncol=4),ylim = c(0,100), xlim = c(0,60))
```

```{r}
PP_mass_cluster_freq_3_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_mass_cluster_freq_3_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP_mass_cluster_freq_3_asManSeqCl[PP_to_manSeq_dict[i]+1] + PP_mass_cluster_freq_3[i]
}

PP_mass_cluster_freq_2_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_mass_cluster_freq_2_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP_mass_cluster_freq_2_asManSeqCl[PP_to_manSeq_dict[i]+1] + PP_mass_cluster_freq_2[i]
}

PP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP2[i]
}
PP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP3[i]
}

ggCPP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP2[i]
}
ggCPP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP3[i]
}
```

```{r}
# COG man seq clusters
combined_compare(simMean2,mass_cluster_freq_2) + combined_compare(simMean3,mass_cluster_freq_3)
# [1] -192.8827

# COG PopPUNK
combined_compare(PP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(PP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -188.5977

# ggC man seq clusters
combined_compare(simMeanggC2,mass_cluster_freq_2) + combined_compare(simMeanggC3,mass_cluster_freq_3)
#[1] -193.1025

# ggC PopPUNK
combined_compare(ggCPP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + 
  combined_compare(ggCPP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -179.3374
```

### 3-param model
```{r}
# COG man seq clusters
params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.007877661, sigma_w = 0.0, prop_f = 1.0 , delta = delta_ranking, m = 0.008008877, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.048982297, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))
# [1] 0.6136608
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMean2/sum(simMean2)))
# [1] 1.025771
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))/mass_clusters
# [1] 0.01496734

### COG PopPUNK
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.004034883, sigma_w = 0, prop_f = 1, delta = delta_ranking, m = 0.009046951, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.044083001, vacc_time = 0)
WFmodel_PP <- WF_nG_h_vP$new(pars = all_params,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanPP2 <- rowMeans(WFmodel_PP$run(36)[-1,])
simMeanPP3 <- rowMeans(WFmodel_PP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))
# [1] 0.650785
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanPP2/sum(simMeanPP2)))
# [1] 1.155241
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))/PP_mass_clusters
# [1] 0.01049653

### ggCaller man seq clusters
params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01006930, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.01635317, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.08659896, vacc_time = 0)
WFmodel_ggCmanSeqCl <- WF_nG_h_vP$new(pars = params_ggC,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggC2 <- rowMeans(WFmodel_ggCmanSeqCl$run(36)[-1,])
simMeanggC3 <- rowMeans(WFmodel_ggCmanSeqCl$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))
# [1] 0.5759087
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMeanggC2/sum(simMeanggC2)))
# [1] 1.002419
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))/mass_clusters
# [1] 0.01404655

### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01931485, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.15977862, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))
# [1] 0.6169782
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanggCPP2/sum(simMeanggCPP2)))
# [1] 1.151487
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))/PP_mass_clusters
# [1] 0.009951261
```

```{r}

p3_PP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP2[i]
}
p3_PP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP3[i]
}

p3_ggCPP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP2[i]
}
p3_ggCPP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP3[i]
}

```

```{r}
# COG man seq clusters
combined_compare(simMean2,mass_cluster_freq_2) + combined_compare(simMean3,mass_cluster_freq_3)
# [1] -253.8706

# COG PopPUNK
combined_compare(p3_PP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(p3_PP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -250.98

# ggC man seq clusters
combined_compare(simMeanggC2,mass_cluster_freq_2) + combined_compare(simMeanggC3,mass_cluster_freq_3)
#[1] -251.7234

# ggC PopPUNK
combined_compare(p3_ggCPP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(p3_ggCPP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -250.1021
```

### Null model
```{r}
# COG
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0, m = 0.007792041, v = 0.023544605)
# ggCaller
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0, m = 0.007772363, v = 0.023542031)
null_man_WFmodel <- WF_null$new(pars = null_man_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanMan2 <- rowMeans(null_man_WFmodel$run(36)[-1,])
simMeanMan3 <- rowMeans(null_man_WFmodel$run(72)[-1,])
# COG man seq clusters
combined_compare(simMeanMan2,mass_cluster_freq_2) + combined_compare(simMeanMan3,mass_cluster_freq_3)
# [1] -251.8277 # COG
# [1] -247.3254 # ggCaller

# COG
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008116513, v = 0.031218082)
# ggCaller
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008118758 , v = 0.031313422)
null_ggCPP_WFmodel <- WF_null$new(pars = null_ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanggCPP2 <- rowMeans(null_ggCPP_WFmodel$run(36)[-1,])
simMeanggCPP3 <- rowMeans(null_ggCPP_WFmodel$run(72)[-1,])
null_ggCPP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  null_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- null_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP2[i]
}
null_ggCPP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  null_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- null_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP3[i]
}
# ggC PopPUNK
combined_compare(null_ggCPP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(null_ggCPP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
# [1] -260.3223 # COG
#[1] -267.9277 # ggCaller
```

### Serotypes
```{r}
# For serotypes, the mapping won't work as well because there are multiple serotypes in some clusters and multiple clusters in some serotypes...
for (i in 1:mass_clusters-1) {
  print(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
}
serotypes_mass <- unique(Mass_Samples_accCodes$Serotype)
for (i in 1:length(serotypes_mass)) {
  print(Mass_Samples_accCodes$SequenceCluster[which(Mass_Samples_accCodes$Serotype==serotypes_mass[i])])
}

# maybe calculating the absolute error is the best that I can do?
# COG man seq clusters
seroCOG_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.092853976, sigma_w = 0.001272531, prop_f = 0.279026024, delta = delta_ranking, m = 0.003294931, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.104832549, vacc_time = 0)
seroCOG_WFmodel <- WF_nG_h_vP$new(pars = seroCOG_params,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(seroCOG_WFmodel$run(36)[-1,])
simMean3 <- rowMeans(seroCOG_WFmodel$run(72)[-1,])
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))
# [1] 0.4791769
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3))) + sum(abs(Sero_freq_2/sum(Sero_freq_2) - simMean2/sum(simMean2)))
# [1] 0.8189977
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))/mass_serotypes
# [1] 0.01497428

ggCsero_params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.106580510, sigma_w = 0.001225886, prop_f = 0.350827911, delta = ggC_delta_ranking, m = 0.027188726, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.268750983, vacc_time = 0)
seroggC_WFmodel <- WF_nG_h_vP$new(pars = ggCsero_params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(seroggC_WFmodel$run(36)[-1,])
simMean3 <- rowMeans(seroggC_WFmodel$run(72)[-1,])
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))
# [1] 0.546132
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3))) + sum(abs(Sero_freq_2/sum(Sero_freq_2) - simMean2/sum(simMean2)))
# [1] 0.9233974
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))/mass_serotypes
# [1] 0.01706663

```

# 616 compartments
```{r}
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(c616_intermed_gene_presence_absence[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds") 
mass_seq_VT <- readRDS("mass_seq_VT.rds")
c616_ggC_intermed_gene_presence_absence <- readRDS("ggC_intermed_gene_presence_absence.rds")
c616_ggC_intermed_gene_presence_absence_matrix <- sapply(c616_ggC_intermed_gene_presence_absence[-1,-1],as.double)
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
delta_ranking <- readRDS(file = "delta_ranking.rds")

man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
  clustered_seqs <- rep(0, mass_clusters)
  for (i in 1:mass_clusters) {
    clustered_seqs[i] <- sum(sequence_clust[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
  }
  clustered_seqs
}
  
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
  result <- 0
  data_size <- sum(unlist(observed))
  model_size = sum(unlist(state))
    
  # need to summarize the data and the observations into clusters
  clustered_state <- sum_seq_man_clusters(unlist(state))
    
  for (i in 1:mass_clusters){
    result <- result + ll_pois(observed[i], clustered_state[i]/model_size * data_size)
  }
  result
}
```

```{r}
# COG with 616 compartments
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
avg_cluster_freq <- rep(1/nrow(seq_clusters), nrow(seq_clusters))
# COG fitted with man seq cluster likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
# ggC fitted with man seq cluster likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_ggC_intermed_gene_presence_absence_matrix, sigma_f = 0.14764836, sigma_w = 0.02625213, prop_f = 0.27308050, delta = as.double(ggC_delta_ranking), m = 0.14998299, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.14154084, vacc_time = 0)
#COG with 616 compartments - fit created using the PP likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.15123543, sigma_w = 0.00519632, prop_f = 0.30642830, delta = as.double(delta_ranking), m = 0.14821740, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.26090610, vacc_time = 0)
# ggC with 616 compartments - fit created using the PP likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_ggC_intermed_gene_presence_absence_matrix, sigma_f = 0.13579085, sigma_w = 0.01279298, prop_f = 0.13540375, delta = as.double(ggC_delta_ranking), m = 0.16166918, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.19117939, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])

combined_compare_616(simMean2,mass_cluster_freq_2) + combined_compare_616(simMean3,mass_cluster_freq_3)
# COG manSeqCl
# [1] -230.2956
# ggC manSeqCl
# [1] -151.6215
# COGPP
# [1] -146.8129
# ggCPP
# [1] -150.4117

```

#Lollipop for normal model together with NULL model
```{r}
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1180783495, sigma_w = 0.0004164005, prop_f = 0.3803173188, delta = ggC_delta_ranking, m = 0.0117180887, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1509501052, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])

# Null ggCPP
NullsimMeanggCPP2 <- rowMeans(null_ggCPP_WFmodel$run(36)[-1,])
NullsimMeanggCPP3 <- rowMeans(null_ggCPP_WFmodel$run(72)[-1,])

lollipop_cluster_freqs_2x2_VTandNVT(year = "2004", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="NFDS Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), model2 = NullsimMeanggCPP2/sum(NullsimMeanggCPP2), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="NFDS Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT)


# 3-param
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01931485, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.15977862, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
p3_simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
p3_simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_2x2_VTandNVT(year = "2004", plot_title = "3-param Model vs Null Model", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="3-param Model", model1 = p3_simMeanggCPP2/sum(p3_simMeanggCPP2), model2 = NullsimMeanggCPP2/sum(NullsimMeanggCPP2), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "3-param Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="3-param Model", model1 = p3_simMeanggCPP3/sum(p3_simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
```

### Plot ggCPP results in lollipop plot
```{r}
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT)
```

### Model version that respects the VT diversity within clusters
```{r}
WF_VT <- odin.dust::odin_dust("NFDS_Model_VT.R")
```

```{r}
ceil_mass_VT <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  ceil_mass_VT[i] <- ceiling(mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1,"Vaccine Type"]=="VT")))
}
ceil_mass_NVT <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  ceil_mass_NVT[i] <- ceiling(mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1,"Vaccine Type"]=="NVT")))
}
mean_mass_VT_2001 <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  mean_mass_VT_2001[i] <- (mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2001,"Vaccine Type"]=="VT")))
}
mean_mass_VT_2001[is.nan(mean_mass_VT_2001)] <- 0

mean_mass_VT <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  mean_mass_VT[i] <- (mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1,"Vaccine Type"]=="VT")))
}

mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
#VT_mig <- rep(1/mass_clusters, mass_clusters) * ceil_mass_VT * mass_clusters/sum(ceil_mass_NVT + ceil_mass_VT)
#NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT) * mass_clusters/sum(ceil_mass_NVT + ceil_mass_VT)

NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT)
VT_mig <- rep(1/mass_clusters, mass_clusters) * (1-ceil_mass_NVT)

# NVT, VT
VT_model_start_pop <- matrix(as.double(c(model_start_pop * (1-mean_mass_VT_2001),model_start_pop * mean_mass_VT_2001)), byrow = FALSE, nrow = mass_clusters, ncol = 2)

params_VT <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = VT_model_start_pop, Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = cbind(NVT_mig,VT_mig), vT = c(0,1), v = 0.1321567425, vacc_time = 0)
```

```{r}
WFmodel_VT <- WF_VT$new(pars = params_VT,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_VT$run(36)[(1:42),]
WFmodel_VT$run(36)[(2:42),1] # "normal" version, i.e. VT and NVT together
WFmodel_VT$run(36)[(43:83),1] # NVTs
WFmodel_VT$run(36)[-(1:83),1] # VTs
#  WFmodel_VT$run(36)[(43:83),1] + WFmodel_VT$run(36)[-(1:83),1] # should be the same as WFmodel_VT$run(36)[(2:42),1]
```


### PCA
```{r}
pca_results <- prcomp(t(sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)))
summary(pca_results)
```

```{r}
var_explained = pca_results$sdev^2 / sum(pca_results$sdev^2)

#library(ggplot2)
ggplot(data = data.frame( comp = 1:length(var_explained), explained_var = var_explained), aes(y=explained_var, x=comp)) + 
  geom_line() + 
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained") +
  ggtitle("Elbow Plot") +
  ylim(0, 1)
```

```{r}
ggplot(data.frame(pca_results$rotation),aes(PC1, PC2))+ 
  geom_point()
```

```{r}
fviz_eig(pca_results, addlabels = TRUE)
```

### WF model with logistic NFDS function

```{r}
WF_log <- odin.dust::odin_dust("NFDS_Model_logistic.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
log_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, L = 0.3735531590, K = 0.2, x0 = (1-0.3669067334), delta = ggC_inv_delta_ranking, m = 0.0078524723, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v =0.1103623064, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_log <- WF_log$new(pars = log_ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_log$run(72)
```

```{r}
plot(0.1789665082/(1 + exp(- 2 * (ggC_inv_delta_ranking - 1774*0.2))))

# sigma_f, sigma_w step function and possible logistic functions to mimic the values
plot(c(rep(0.0006039627, 1774 * (1-0.3669067334)), rep(0.1789665082, 1774 * 0.3669067334)))
lines(0.1789665082/(1 + exp(- 0.2 * (1:1774 - 1774*(1-0.3669067334)))))
lines(0.1789665082/(1 + exp(- 0.02 * (1:1774 - 1774*(1-0.3669067334)))))
lines(0.1789665082/(1 + exp(- 0.01 * (1:1774 - 1774*(1-0.3669067334)))))

#sigma_f = 0.1789665082, sigma_w = 0.0006039627, prop_f = 0.3669067334
#ggCPP fit results in the following logistic values
ggCPP_log_fit <- 0.11292912/(1 + exp(- 4.95113406 * (1:1774 - 1774*(0.62342733))))
max(ggCPP_log_fit)
plot(ggCPP_log_fit)
length(which(ggCPP_log_fit[which(ggCPP_log_fit<0.99 * max(ggCPP_log_fit))]>0.01))
# so there is just 1 element that has an intermediate value.
# question: do I need the steepness value then?
# is there a similar function that does not need the steepness parameter?
# there is a different definition of the logistic function, which is 1/(1 + exp(-x)), I could use that as 1/(1 + exp(- 1 *(x - x0)) or 1/(1 + exp(x0 - x))
plot(1/(1+exp((1774*(0.62342733)-1:1774))))


# comparison ggC + manSeqCl for step function and logistic function
plot(0.309057542/(1 + exp(- 4.681828437 * (1:1774 - 1774*(0.809096221)))))
lines(c(rep(0.0003669121 , 1774 * (1-0.2161135322)), rep(0.1882242231 , 1774 * 0.2161135322)))

# comparison ggC + PP for step function and logistic function
plot(0.11292912/(1 + exp(- 4.95113406 * (1:1774 - 1774*(0.62342733)))), ylim = c(0, 0.12), main = "Comparison ggCPP for step function and logistic function NFDS", xlab = "Genes", ylab = "Selection Strength")
lines(c(rep(0.0004164005 , 1774 * (1-0.3803173188)), rep(0.1180783495 , 1774 * 0.3803173188)), col = "red")
legend(0, 0.1, legend=c("logistic function", "step function"),
       col=c("black", "red"), lty=1, cex=0.8)
```

```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(0.11292912/(1+exp(4.95113406 *(1774*(0.62342733)-(1:1774)))), main = "Logistic vs Step Function Model Fit with ggCaller and PopPUNK", xlab = "Genes", ylab = "Selection Strength", col = col_clb[1], ylim = c(0, 0.12), cex = 1)
points(0.1144311/(1+exp((1774*(0.6243419)-(1:1774)))), col = col_clb[2], cex = 1)
points(0.03503935/(1+exp(1 *(1774*(0)-(1:1774)))), col = col_clb[3], cex = 1)
points(0.111690097/(1+exp((1774*(0.624229293)-(1:1774)))) + 0.003764143, col = col_clb[4], cex = 1)
points(c(rep(0.0004164005 , 1774 * (1-0.3803173188)), rep(0.1180783495, 1774 * 0.3803173188)), col = col_clb[5], cex = 1)
points(c(rep(0 , 1774 * (1-0.37657870)), rep(0.11313856, 1774 * 0.37657870)), col = col_clb[6], cex = 1)
points(rep(0.01931485 , 1774 * (1)), col = col_clb[7], cex = 1)
legend(0, 0.12, legend=c("Logistic, 5 params", "Logistic, 4 params", "Logistic, 3 params", "Logistic, Y shift","step function, 5 params", "step function, 4 params", "step function, 3 params"),col=col_clb, lty=1, cex=1.2)
```

```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(0.11292912/(1+exp(4.95113406 *(1774*(0.62342733)-(1:1774)))), main = "Logistic vs Step Function Model Fit with ggCaller and PopPUNK", xlab = "Genes", ylab = "Selection Strength", col = col_clb[1], ylim = c(0, 0.12), cex = 1)
points(c(rep(0.0004164005 , 1774 * (1-0.3803173188)), rep(0.1180783495, 1774 * 0.3803173188)), col = col_clb[5], cex = 1)

legend(0, 0.12, legend=c("Logistic, 5 params", "step function, 5 params"),col=col_clb, lty=1, cex=1.2)
```

```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(0.21696863/(1+exp(5.03946007 *(1774*(0.57776473)-(1:1774)))), main = "Logistic vs Step Function Model Fit with COG and PopPUNK", xlab = "Genes", ylab = "Selection Strength", col = col_clb[1], ylim = c(0, 0.22), cex = 1)
points(0.21712951/(1+exp((1774*(0.57739554)-(1:1774)))), col = col_clb[2], cex = 1)
points(0.004120443/(1+exp(1 *(1774*(0)-(1:1774)))), col = col_clb[3], cex = 1)
points(c(rep(0.0006359267 , 1774 * (1-0.4202932608)), rep(0.2169393333, 1774 * 0.4202932608)), col = col_clb[4], cex = 1)
points(c(rep(0 , 1774 * (1-0.4207139)), rep(0.2170153, 1774 * 0.4207139)), col = col_clb[5], cex = 1)
points(rep(0.004034883, 1774 * (1)), col = col_clb[6], cex = 1)
legend(0, 0.12, legend=c("Logistic, 5 params", "Logistic, 4 params", "Logistic, 3 params", "step function, 5 params", "step function, 4 params", "step function, 3 params"),
       col=col_clb, lty=1, cex=0.8)
```


# Likelihood ratio test
#  lambda = -2*(x_1-x_2).
# pvalue_testing_null=1-pchisq(lambda,difference_in_degrees_of_freedom) 
```{r}
LL_4param <- -207.7955
LL_5param <- -207.6401
lambda <- -2 * (LL_4param - LL_5param)
pchisq(lambda, 1,lower.tail = FALSE)

# the model with 5 parameters as compared to the model with 4 parameters is not significantly better
# therefore, having the fifth parameter is not meaningful

#AIC_1 = 2*-207.7955 + 2*4
#AIC_2 = 2*-207.6401 + 2*5
```

```{r}
# Step Function Models (original)
# compare 3-param model to 5-param model
# ggCaller and PopPUNK
step_LL_3param <- -334.3289
step_LL_5param <- -263.4791
step_LL_4param <- -262.268
step_LL_null <- -335.0503
lambda <- -2 * (step_LL_3param - step_LL_5param)
pchisq(lambda, 5-3, lower.tail = FALSE)
# significant!
# the 5-param model is significantly better than the 3-param model
lambda <- -2 * (step_LL_3param - step_LL_4param)
pchisq(lambda, 4-3, lower.tail = FALSE)
# significant!
# the 4-param model is significantly better than the 3-param model
lambda <- -2 * (step_LL_4param - step_LL_5param)
pchisq(lambda, 5-4, lower.tail = FALSE)
# not significant: 5-parameter model not significantly better than 4-parameter model
lambda <- -2 * (step_LL_null - step_LL_3param)
pchisq(lambda, 3-2, lower.tail = FALSE)
# not significant: 3-parameter model not significantly better than 2-parameter model
lambda <- -2 * (step_LL_null - step_LL_4param)
pchisq(lambda, 4-2, lower.tail = FALSE)
# significant: 4-param model better than null model
lambda <- -2 * (step_LL_null - step_LL_5param)
pchisq(lambda, 5-2, lower.tail = FALSE)
# significant: 5-param model better than null model
```

```{r}
#install.packages("lmtest")
#library(lmtest)
#lrtest(step_LL_3param, step_LL_5param)
```

```{r}
# Logistic Function Models
# ggCaller and PopPUNK
log_LL_3param <- -335.3469
log_LL_5param <- -262.2021
log_LL_4param <- -262.2601
log_LL_yshift <- -263.3581 # 5 params
step_LL_null <- -335.0503

lambda <- -2 * (log_LL_3param - log_LL_5param)
pchisq(lambda, 5-3, lower.tail = FALSE)
# significant!
# the 5-param model is significantly better than the 3-param model
lambda <- -2 * (log_LL_3param - log_LL_4param)
pchisq(lambda, 4-3, lower.tail = FALSE)
# significant!
# the 4-param model is significantly better than the 3-param model
lambda <- -2 * (log_LL_4param - log_LL_5param)
pchisq(lambda, 5-4, lower.tail = FALSE)
# not significant: 5-parameter model not significantly better than 4-parameter model
lambda <- -2 * (step_LL_null - log_LL_3param)
pchisq(lambda, 3-2, lower.tail = FALSE)
# not significant: 3-parameter model not significantly better than 2-parameter model
lambda <- -2 * (step_LL_null - log_LL_4param)
pchisq(lambda, 4-2, lower.tail = FALSE)
# significant: 4-param model better than null model
lambda <- -2 * (step_LL_null - log_LL_5param)
pchisq(lambda, 5-2, lower.tail = FALSE)
# significant: 5-param model better than null model

# yshift model:
lambda <- -2 * (log_LL_4param - log_LL_yshift)
pchisq(lambda, 5-4, lower.tail = FALSE)
# yshift model not significantly better than 4-param model
lambda <- -2 * (log_LL_3param - log_LL_yshift)
pchisq(lambda, 5-3, lower.tail = FALSE)
# but yshift model better than 3-param model
lambda <- -2 * (step_LL_null - log_LL_yshift)
pchisq(lambda, 5-2, lower.tail = FALSE)
```

# alternative:
# logistic 3-param model
# == fixing x0=0
# plot(0.305665235/(1+exp(-(1:1774))))


# investigate more details of runs, e.g., effective sample size
```{r}
# path to results: 
results_path_15 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_04_15/"
# saved_det_mcmc2 <- readRDS(paste(results_path, "xxx.rds",sep=""))
# coda::effectiveSize(saved_det_mcmc2)
COGmanSeqCl_det_mcmc2 <- readRDS(paste(results_path_15, "COGtriangles_manSeqClusters_det_mcmc2.rds",sep=""))
coda::effectiveSize(COGmanSeqCl_det_mcmc2)
# log_prior log_likelihood  log_posterior        sigma_f        sigma_w         prop_f 
#       0.00000      432.48728      432.48728      144.33072      323.82097       70.52254 
#            m              v 
#     525.46322      481.06586 

# effective sample size differs a lot between the parameters!
1 - coda::rejectionRate(COGmanSeqCl_det_mcmc2)
# acceptance rate is good
summary(COGmanSeqCl_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(COGmanSeqCl_det_mcmc2[1:20000,-(1:3)]), coda::as.mcmc(COGmanSeqCl_det_mcmc2[20001:40000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[40001:60000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[60001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(COGmanSeqCl_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(COGmanSeqCl_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(COGmanSeqCl_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(COGmanSeqCl_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

parameter_mean_hpd <- apply(COGmanSeqCl_det_mcmc2[c(5001:20000,25001:40000,45001:60000,65001:80000),-(1:3)], 2, mean)
parameter_mean_hpd
```

```{r}
COGPP_det_mcmc2 <- readRDS(paste(results_path_15, "COGtriangles_PopPUNK_det_mcmc2.rds",sep=""))
coda::effectiveSize(COGPP_det_mcmc2)
# much better effective sample size!
1 - coda::rejectionRate(COGPP_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(COGPP_det_mcmc2[1:20000,-(1:3)]), coda::as.mcmc(COGPP_det_mcmc2[20001:40000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[40001:60000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[60001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(COGPP_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(COGPP_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

parameter_mean_hpd <- apply(COGPP_det_mcmc2[,-(1:3)], 2, mean)
parameter_mean_hpd

parameter_mean_hpd <- apply(COGPP_det_mcmc2[c(14001:20000, 34001:40000, 54001:60000, 74001:80000),-(1:3)], 2, mean)
parameter_mean_hpd

# maybe thinning
#COGPP_det_mcmc2_thinned <- coda::mcmc(COGPP_det_mcmc2, thin = 2)
```

```{r}
ggCmanSeqCl_det_mcmc2 <- readRDS(paste(results_path_15, "ggCaller_manSeqClusters_det_mcmc2.rds",sep=""))
coda::effectiveSize(ggCmanSeqCl_det_mcmc2)
# effective sample size better than COGmanSeqCl but could be better
1 - coda::rejectionRate(ggCmanSeqCl_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(ggCmanSeqCl_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(ggCmanSeqCl_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(ggCmanSeqCl_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(ggCmanSeqCl_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)
```

```{r}
ggCPP_det_mcmc2 <- readRDS(paste(results_path_15, "ggCaller_PopPUNK_det_mcmc2.rds",sep=""))
coda::effectiveSize(ggCPP_det_mcmc2)
# effective sample size better than COGmanSeqCl but could be better
1 - coda::rejectionRate(ggCPP_det_mcmc2)

combinedchains = coda::mcmc.list(coda::as.mcmc(ggCPP_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(ggCPP_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(ggCPP_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(ggCPP_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

parameter_mean_hpd <- apply(ggCPP_det_mcmc2[c(1001:20000, 21001:40000, 41001:60000, 61001:80000),-(1:3)], 2, mean)
parameter_mean_hpd
mean(ggCPP_det_mcmc2[c(1001:20000, 21001:40000, 41001:60000, 61001:80000),2])

parameter_mean_hpd <- apply(ggCPP_det_mcmc2[c(5001:20000, 25001:40000, 45001:60000, 65001:80000),-(1:3)], 2, mean)
parameter_mean_hpd
mean(ggCPP_det_mcmc2[c(5001:20000, 25001:40000, 45001:60000, 65001:80000),2])


plot(coda::as.mcmc(ggCPP_det_mcmc2[1001:20000,]))
lines(coda::as.mcmc(ggCPP_det_mcmc2[21001:40000,]))

coda::autocorr.plot(ggCPP_det_mcmc2)


library(tigerstats)
combinedchains2 = coda::mcmc.list(coda::as.mcmc(ggCPP_det_mcmc2[1:20000,-c(1,3)]), coda::as.mcmc(ggCPP_det_mcmc2[20001:40000,-c(1,3)]),coda::as.mcmc(ggCPP_det_mcmc2[40001:60000,-c(1,3)]),coda::as.mcmc(ggCPP_det_mcmc2[60001:80000,-c(1,3)]))
xyplot(combinedchains2)
# --> burn-in of 5000 sensible

# prop_f and sigma_f
plot(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,6], ylab = "prop_f",xlab = "sigma_f")
lines(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,6], col = "grey")
points(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,6])

ggCPP_det_mcmc2_df <- data.frame(cbind(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,6],ggCPP_det_mcmc2[1001:20000,2]))
colnames(ggCPP_det_mcmc2_df) <- c("sigma_f","prop_f","likelihood")

# combine trace plot with 2d contour density plot
v <- ggplot(NULL, aes(sigma_f, prop_f, z = log(-(likelihood))))
v + geom_contour_filled(data = grid_results_df) + labs(fill = "log neg Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 16)) + geom_point(data = ggCPP_det_mcmc2_df, col = "red")

# sigma_w and sigma_f
plot(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,5], xlim = c(0, 0.35))
lines(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,5], col = "grey")
points(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,5])

plot(ggCPP_det_mcmc2[1001:20000,4],ggCPP_det_mcmc2[1001:20000,2], xlim = c(0,0.35))


summary(coda::as.mcmc(ggCPP_det_mcmc2[c(5001:20000,25001:40000,45001:60000,65001:80000),]))
#                     Mean        SD  Naive SE Time-series SE
#log_prior       0.000e+00 0.0000000 0.000e+00      0.0000000
#log_likelihood -2.633e+02 2.1542694 8.795e-03      0.0725237
#log_posterior  -2.633e+02 2.1542694 8.795e-03      0.0725237
#sigma_f         1.109e-01 0.0292186 1.193e-04      0.0009632
#sigma_w         3.823e-04 0.0003979 1.625e-06      0.0000128
#prop_f          3.861e-01 0.0451591 1.844e-04      0.0013191
#m               1.101e-02 0.0043000 1.755e-05      0.0001459
#v               1.466e-01 0.0254677 1.040e-04      0.0008980
summa_ggCPP_run <- summary(coda::as.mcmc(ggCPP_det_mcmc2[c(5001:20000,25001:40000,45001:60000,65001:80000),]))
summa_ggCPP_run_df <- data.frame(summa_ggCPP_run$statistics[-(1:3),])

qplot(x    = factor(rownames(summa_ggCPP_run_df)) ,
      y    = Mean,
      data = summa_ggCPP_run_df) +

geom_errorbar(aes(ymin  = summa_ggCPP_run_df$Mean - summa_ggCPP_run_df$SD,
                   ymax  = summa_ggCPP_run_df$Mean + summa_ggCPP_run_df$SD,
                   width = 0.15))

```

```{r}
results_path_25 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_04_25/"
ggCPP_det_mcmc2_4param <- readRDS(paste(results_path_25, "4param_ggCaller_PopPUNK_det_pmcmc_run2.rds",sep=""))
ggCPP_det_mcmc2_4param_coda <- coda::as.mcmc(cbind(ggCPP_det_mcmc2_4param$probabilities, ggCPP_det_mcmc2_4param$pars))
coda::effectiveSize(ggCPP_det_mcmc2_4param_coda)
# effective sample size better than COGmanSeqCl but could be better
1 - coda::rejectionRate(ggCPP_det_mcmc2_4param_coda)

max(ggCPP_det_mcmc2_4param$probabilities[,2]) # best value in chain

plot(ggCPP_det_mcmc2_4param_coda)
summary(ggCPP_det_mcmc2_4param_coda)
#                     Mean      SD  Naive SE Time-series SE
#log_prior         0.0000 0.00000 0.000e+00      0.0000000
#log_likelihood -261.9913 1.74362 6.165e-03      0.0362201
#log_posterior  -261.9913 1.74362 6.165e-03      0.0362201
#sigma_f          -2.3508 0.30121 1.065e-03      0.0064184
#prop_f            0.3807 0.04316 1.526e-04      0.0009558
#m                -4.7577 0.37118 1.312e-03      0.0072638
#v                 0.1342 0.02311 8.169e-05      0.0004660

library(tigerstats)
combinedchains2 = coda::mcmc.list(coda::as.mcmc(ggCPP_det_mcmc2_4param_coda[1:20000,-c(1,3)]), coda::as.mcmc(ggCPP_det_mcmc2_4param_coda[20001:40000,-c(1,3)]),coda::as.mcmc(ggCPP_det_mcmc2_4param_coda[40001:60000,-c(1,3)]),coda::as.mcmc(ggCPP_det_mcmc2_4param_coda[60001:80000,-c(1,3)]))
xyplot(combinedchains2)
# --> burn-in of 5000 sensible

# prop_f and sigma_f
plot(ggCPP_det_mcmc2_4param_coda[1001:20000,4],ggCPP_det_mcmc2_4param_coda[1001:20000,5], ylab = "prop_f",xlab = "sigma_f")
lines(ggCPP_det_mcmc2_4param_coda[1001:20000,4],ggCPP_det_mcmc2_4param_coda[1001:20000,5], col = "grey")
points(ggCPP_det_mcmc2_4param_coda[1001:20000,4],ggCPP_det_mcmc2_4param_coda[1001:20000,5])

ggCPP_det_mcmc2_4param_df <- data.frame(cbind(exp(ggCPP_det_mcmc2_4param_coda[1001:20000,4]),ggCPP_det_mcmc2_4param_coda[1001:20000,5],ggCPP_det_mcmc2_4param_coda[1001:20000,2]))
colnames(ggCPP_det_mcmc2_4param_df) <- c("sigma_f","prop_f","likelihood")

# combine trace plot with 2d contour density plot
v <- ggplot(NULL, aes(sigma_f, prop_f, z = log(-(likelihood))))
v + geom_contour_filled(data = grid_results_df) + labs(fill = "log neg Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 16)) + geom_point(data = ggCPP_det_mcmc2_4param_df, col = "red")
```



### Log models
```{r}
# 5 params
results_path <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_04_16/"
log_ggCPP_pmcmc2 <- readRDS(paste(results_path, "ggCaller_PopPUNK_log_det_pmcmc_run2.rds",sep=""))
log_ggCPP_det_mcmc2 <- coda::as.mcmc(cbind(log_ggCPP_pmcmc2$probabilities, log_ggCPP_pmcmc2$pars))
coda::effectiveSize(log_ggCPP_det_mcmc2)
# much better effective sample size!
1 - coda::rejectionRate(log_ggCPP_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(log_ggCPP_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(log_ggCPP_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(log_ggCPP_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(log_ggCPP_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

processed_chains <- mcstate::pmcmc_thin(log_ggCPP_pmcmc2, burnin = 5000, thin = 1)
parameter_mean_hpd <- apply(processed_chains$pars, 2, mean)
parameter_mean_hpd

log_summa_ggCPP_run <- summary(coda::as.mcmc(log_ggCPP_det_mcmc2[c(5001:20000,25001:40000,45001:60000,65001:80000),]))
log_summa_ggCPP_run_df <- data.frame(log_summa_ggCPP_run$statistics[-(1:3),])

qplot(x    = factor(rownames(log_summa_ggCPP_run_df)) ,
      y    = Mean,
      data = log_summa_ggCPP_run_df) +

geom_errorbar(aes(ymin  = log_summa_ggCPP_run_df$Mean - log_summa_ggCPP_run_df$SD,
                   ymax  = log_summa_ggCPP_run_df$Mean + log_summa_ggCPP_run_df$SD,
                   width = 0.15))


# 4 params
log4_ggCPP_pmcmc2 <- readRDS(paste(results_path, "ggCaller_PopPUNK_log4_det_pmcmc_run2.rds",sep=""))
log4_ggCPP_det_mcmc2 <- coda::as.mcmc(cbind(log4_ggCPP_pmcmc2$probabilities, log4_ggCPP_pmcmc2$pars))
coda::effectiveSize(log4_ggCPP_det_mcmc2)
# much better effective sample size!
1 - coda::rejectionRate(log4_ggCPP_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(log4_ggCPP_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(log4_ggCPP_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(log4_ggCPP_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(log4_ggCPP_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

processed_chains <- mcstate::pmcmc_thin(log4_ggCPP_pmcmc2, burnin = 5000, thin = 2)
parameter_mean_hpd <- apply(processed_chains$pars, 2, mean)
parameter_mean_hpd

library(tigerstats)
log_combinedchains2 = coda::mcmc.list(coda::as.mcmc(log_ggCPP_det_mcmc2[1001:20000,-c(1,3)]), coda::as.mcmc(log_ggCPP_det_mcmc2[21001:40000,-c(1,3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[41001:60000,-c(1,3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[61001:80000,-c(1,3)]))
xyplot(log_combinedchains2)
```

```{r}
# 5 params
results_path_19 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_04_19/"
log_ggCPP_pmcmc2_FittingExp <- readRDS(paste(results_path_19, "ggCaller_PopPUNK_log_det_pmcmc_run2_FittingExp.rds",sep=""))
#summary(log_ggCPP_pmcmc2_FittingExp)

log_ggCPP_pmcmc2_FittingExp_coda <- coda::as.mcmc(cbind(
  log_ggCPP_pmcmc2_FittingExp$probabilities, log_ggCPP_pmcmc2_FittingExp$pars))

summary(log_ggCPP_pmcmc2_FittingExp_coda)
#                    Mean      SD  Naive SE Time-series SE
#log_prior         0.0000 0.00000 0.000e+00      0.0000000
#log_likelihood -262.0847 1.66200 5.876e-03      0.0331368
#log_posterior  -262.0847 1.66200 5.876e-03      0.0331368
#L                -2.3392 0.29739 1.051e-03      0.0058976
#K                 2.9875 4.01001 1.418e-02      0.0878405
#x0                0.6230 0.04243 1.500e-04      0.0009312
#m                -4.7596 0.36295 1.283e-03      0.0068953
#v                 0.1337 0.02264 8.005e-05      0.0004395
```


# Visualise Serotype Cluster composition
```{r}
# how to get from manual sequence clusters to serotypes: (example for cluster 0)
unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==0)])
# how to get from PP clusters to manual sequence clusters
PP_to_manSeq_dict
# usage together e.g.
unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==PP_to_manSeq_dict[1])])


#PP_serotype_comp <- list()
#for (i in 1:PP_mass_clusters) {
#  PP_serotype_comp[[i]] <- unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==PP_to_manSeq_dict[i])])
#}

#PP_serotype_comp <- rep(0,PP_mass_clusters)
#for (i in 1:PP_mass_clusters) {
#  PP_serotype_comp[i] <- paste(unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==PP_to_manSeq_dict[i])]), collapse = ", ")
#}


### not necessary anymore, I added the Serotype information to the PopPUNK data frame

# use this instead:
#unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==1)])
PP_serotype_comp <- rep(0,PP_mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_serotype_comp[i] <- paste(unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==i)]), collapse = ", ")
}

PP_serotype_comp_vec <- vector(mode = "list", length = (PP_mass_clusters))
for (i in 1:PP_mass_clusters) {
  PP_serotype_comp_vec[[i]] <- c(unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==unique(PopPUNK_clusters$Cluster)[i])]))
}
```

```{r}
source("CreateLollipopPlot.R")

# ggCPP mass fit 24.07.24: -0.4404874  0.1125722 -3.9657678  0.1111540 
# trying out likelihood weighted by cluster size

# ggCPP mass fit (local) 25.07.24 with multinomial likelihood: 
# -1.6970825  0.2478567 -4.0487967  0.1525169 

#with normal likelihood: -1.8680105  0.2718083 -4.5788394  0.1291080 

# with corrected likelihood (26.07.24): -2.0958228  0.3107495 -4.4689789  0.1366157 
# map estimate of this run: map_estimate(Mass_4param_fit$pars[, 1:4])
# -2.11 0.25 -4.41 0.11

# with weighted likelihood (26.07.24): -1.1594852  0.2353541 -4.1434129  0.2214515 

# with multinomial likelihood (25.07.24): -2.1445454  0.3145671 -4.4065733  0.1369317 

### ggCaller PopPUNK
# map
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.11, sigma_w = -1000, prop_f = 0.25, delta = ggC_delta_ranking, m = -4.41, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.11, vacc_time = 0)

params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -0.4404874, sigma_w = -1000, prop_f = 0.1125722, delta = ggC_delta_ranking, m = -3.9657678, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1111540, vacc_time = 0)

params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -1.6970825, sigma_w = -1000, prop_f = 0.1125722, delta = ggC_delta_ranking, m = -4.0487967, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1525169, vacc_time = 0)

#corrected
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.0958228, sigma_w = -1000, prop_f = 0.3107495, delta = ggC_delta_ranking, m = -4.1434129, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1366157, vacc_time = 0)

#weighted
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -1.1594852, sigma_w = -1000, prop_f = 0.2353541, delta = ggC_delta_ranking, m = -4.4689789, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.2214515, vacc_time = 0)

# mult
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.1445454, sigma_w = -1000, prop_f = 0.3145671, delta = ggC_delta_ranking, m = -4.4065733, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1369317, vacc_time = 0)

WF_nG_h_vP <- odin.dust::odin_dust("NFDS_Model.R")
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 0,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)


lollipop_cluster_freqs_VTandNVT_labelSero_shaded(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_log(year = "2007", plot_title = "PopPUNK and ggCaller log scale", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_relative(year = "2007", plot_title = "PopPUNK and ggCaller relative difference", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT, SeroLabel = PP_serotype_comp)


# add null model to plot
# params (08.03.2024): m = 0.008118758, v = 0.031313422 
WF_null <- odin.dust::odin_dust("null_NFDS_Model.R")
null_params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, delta = ggC_delta_ranking, m = 0.008118758, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.031313422, vacc_time = 0)

nullWFmodel_ggCPP <- WF_null$new(pars = null_params_ggCPP,
                                   time = 0,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
NullsimMeanggCPP2 <- rowMeans(nullWFmodel_ggCPP$run(36)[-1,])
NullsimMeanggCPP3 <- rowMeans(nullWFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_2x2_VTandNVT_labelSero_relative(year = "2007", plot_title = "Massachusetts - PopPUNK and ggCaller relative difference", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)


lollipop_cluster_freqs_VTandNVT_labelSero_relative_ModelComp(year = "2007", plot_title = "Massachusetts - relative difference", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)
```

# pair plot
```{r}
# 4 param fit
Mass_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_26/Mass_correctedLikelihood/4param_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Mass_4param_fit_mcmc <- coda::as.mcmc(cbind(Mass_4param_fit$probabilities, Mass_4param_fit$pars))
coda::effectiveSize(Mass_4param_fit_mcmc)
summary(coda::as.mcmc(Mass_4param_fit_mcmc))
plot(Mass_4param_fit_mcmc)

pairs(Mass_4param_fit$pars)

## ggplot version
library(ggplot2)
library(GGally)
ggpairs(Mass_4param_fit$pars, title = "Mass", upper = list(continuous = wrap("cor", size = 7)))

# try to find maximum a posteriori estimate (map)
#install.packages("bayestestR")
library(bayestestR)
map_estimate(Mass_4param_fit$pars[, 2])
```

```{r}
# plot correlation of cluster size and error
data_order <- order(PP_mass_cluster_freq_3)
data_vals <- (PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3))[data_order]
model_vals <- (simMeanggCPP3/sum(simMeanggCPP3))[data_order]
error_vals <- abs(data_vals - model_vals)
sq_error_vals <- (data_vals - model_vals)**2

model <- lm(error_vals ~ PP_mass_cluster_freq_3[order(PP_mass_cluster_freq_3)])
summary(model)


plot(PP_mass_cluster_freq_3[order(PP_mass_cluster_freq_3)],error_vals, ylab = "absolute error", xlab = "Cluster size (data)", main = "Absolute error model vs. data for Mass 2007")
abline(lm(error_vals ~ PP_mass_cluster_freq_3[order(PP_mass_cluster_freq_3)]), col = "red")


model_sqr <- lm(sq_error_vals ~ PP_mass_cluster_freq_3[order(PP_mass_cluster_freq_3)])
summary(model_sqr)

plot(PP_mass_cluster_freq_3[order(PP_mass_cluster_freq_3)],sq_error_vals, ylab = "squared error", xlab = "Cluster size (data)", main = "Squared error model vs. data for Mass 2007")
abline(lm(sq_error_vals ~ PP_mass_cluster_freq_3[order(PP_mass_cluster_freq_3)]), col = "red")
```

```{r}
# ggCPP fit (logistic function model)
WF_log <- odin.dust::odin_dust("NFDS_Model_logistic.R")
log_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, L = 0.11292912, K = 4.95113406
, x0 = 0.62342733, delta = ggC_inv_delta_ranking, m = 0.01107836, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v =0.14464825, vacc_time = 0)
logWFmodel_ggCPP <- WF_log$new(pars = log_ggCPP_params,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2_log <- rowMeans(logWFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3_log <- rowMeans(logWFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

#combined_compare(simMeanggCPP2_log,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3_log,PP_mass_cluster_freq_3)
#combined_compare(simMeanggCPP2,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3,PP_mass_cluster_freq_3)
```

```{r}
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Step Function", model1 = PP_model_start_pop/sum(PP_model_start_pop), model_name_2 ="Logistic Function", model2 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Step Function", model1 = simMeanggCPP2/sum(simMeanggCPP2), model_name_2 ="Logistic Function", model2 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Step Function", model1 = simMeanggCPP3/sum(simMeanggCPP3), model_name_2 ="Logistic Function", model2 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

```

```{r}
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "all time points", plot_title = "Data only", data_name = "2001", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="2004", model1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_2 ="2007", model2 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
# think about delta again
# logistic fit doesn't seem to make much sense
# think about using x^3 or so again (and try to find notes from ~ 22nd of August)
plot(sort(ggC_delta_data3)[1:1500])
lines(((0:200)/10000)^3)
0.2

delta_df <- data.frame(cbind(1:length(ggC_delta_data3), sort(ggC_delta_data3)))

lm(log(X2) ~ X1, data = delta_df)

plot(log(sort(ggC_delta_data3)))
lines(-10.338049 + 0.004083 * (1:length(ggC_delta_data3)))

plot((sort(ggC_delta_data3)))
lines(exp(-10.338049 + 0.004083 *  (1:length(ggC_delta_data3))), col = "red")

plot(((ggC_delta_data3)))
points(exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking))), col = "red")

plot((1 + (ggC_delta_data3)), ylim = c(1,1.01))
points(1 + exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking))), col = "red")
points((1 + (3.237743e-05 * exp(0.004083 *  ((ggC_delta_ranking))))), col = "blue")

# this is a fit that replicates the variation
# but I basically want the invers because the more variation the less selection
# can I just use the ggC_inv_delta_ranking?

# the logistic model for comparison:
#points((0.11292912 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "blue")
#points((1 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "blue")

plot(((ggC_delta_data3)))
points(exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking))), col = "red")

plot((sort(0.5 - ggC_delta_data3)))
points(sort(0.5 - 10 *exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking)))), col = "red")
```

# for future reference: (1+L)^... is an approximation (?) of (1+L)/(1+exp...)
# plot(1 + (0.11292912 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "red")
# points((1+0.11292912)^(1 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "blue")

### WF model with logistic NFDS function

```{r}
WF_exp <- odin.dust::odin_dust("NFDS_Model_exp.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
exp_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, L = 0, x0 = -10, K = 0.004, delta = ggC_delta_ranking, m = 0.0078524723, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v =0.1103623064, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_exp <- WF_exp$new(pars = exp_ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_exp$run(2)
```

### grid search for prop_f and sigma_f
```{r}
# parameters from ggCPP fit with 4 parameter model (15.4.2024)
# but with transformed sigma_f, sigma_w and m because that is the current version of my model
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), sigma_w = -1000, prop_f = 0.37657870, delta = ggC_delta_ranking, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
gridSearch <- function(sigma_f_vals, prop_f_vals){
  likelihood_vals <- data.frame(matrix(0, nrow = length(sigma_f_vals), ncol = length(prop_f_vals)))
  for (i in 1:length(sigma_f_vals)) {
    for (j in 1:length(prop_f_vals)) {
      ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(sigma_f_vals[i]), sigma_w = -1000, prop_f = prop_f_vals[j], delta = ggC_delta_ranking, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)
      WFmodel_ggCPP <- WF_nG_h_vP$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
      n_particles <- 10L
      n_times <- 73
      x <- array(NA, dim = c(WFmodel_ggCPP$info()$len, n_particles, n_times))

      for (t in seq_len(n_times)) {
        x[ , , t] <- WFmodel_ggCPP$run(t)
      }
      time <- x[1, 1, ]
      x <- x[-1, , ]
  
      likelihood_vals[i,j] <- combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
    }
  }
  likelihood_vals
}
```

```{r}
likelihood_grid <- gridSearch(sigma_f_vals = c(0,(1:20)/20), prop_f_vals = c(0,(1:20)/20))
rownames(likelihood_grid) <- c(0,(1:20)/20)
colnames(likelihood_grid) <- c(0,(1:20)/20)
# max: -240.126 for sigma_f_vals = 0.1, prop_f_vals = 0.4
saveRDS(likelihood_grid,"likelihood_grid.rds")
# 2nd largest: -243.5468, sigma_f_vals = 0.35, prop_f_vals = 0.2

# make grid around max values
likelihood_grid2 <- gridSearch(sigma_f_vals = ((10:30)/200), prop_f_vals = ((70:90)/200))
rownames(likelihood_grid2) <- ((10:30)/200)
colnames(likelihood_grid2) <- ((70:90)/200)
# max: -232.2814 for sigma_f_vals = 0.105, prop_f_vals = 0.38
saveRDS(likelihood_grid2,"likelihood_grid2.rds")

# make grid around 2nd max values
likelihood_grid3 <- gridSearch(sigma_f_vals = ((60:80)/200), prop_f_vals = ((30:50)/200))
rownames(likelihood_grid3) <- ((60:80)/200)
colnames(likelihood_grid3) <- ((30:50)/200)
saveRDS(likelihood_grid3,"likelihood_grid3.rds")
# max: -239.1502, sigma_f_vals = 0.35, prop_f_vals = 0.195
```

```{r}
plot(as.numeric(rownames(likelihood_grid)), as.numeric(colnames(likelihood_grid)), xlab = "sigma_f", ylab = "prop_f", xaxt='n')
```

```{r}
library(viridis)
grid_results_df <- data.frame(matrix(0, nrow = 441, ncol = 3))
colnames(grid_results_df) <- c("sigma_f","prop_f","likelihood")
grid_results_df$sigma_f <- rep(c(0,((1:20)/20)),21)
grid_results_df$prop_f <- sort(rep(c(0,((1:20)/20)),21))
grid_results_df$likelihood <- c(likelihood_grid[,1],likelihood_grid[,2],likelihood_grid[,3],likelihood_grid[,4], likelihood_grid[,5],likelihood_grid[,6],likelihood_grid[,7],likelihood_grid[,8], likelihood_grid[,9],likelihood_grid[,10], likelihood_grid[,11],likelihood_grid[,12], likelihood_grid[,13],likelihood_grid[,14], likelihood_grid[,15],likelihood_grid[,16], likelihood_grid[,17],likelihood_grid[,18], likelihood_grid[,19],likelihood_grid[,20],likelihood_grid[,21])

ggplot(grid_results_df, aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(color = likelihood, size = likelihood)) +
  scale_size_continuous(range = c(3, 7)) +
  scale_color_viridis(option = "D")

ggplot(grid_results_df, aes(x=sigma_f, y=likelihood) ) +
  geom_point(aes(color = prop_f, size = 2)) +
  scale_color_viridis(option = "D")

ggplot(grid_results_df, aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(size = log(abs(likelihood)),color = log(abs(likelihood)))) +
  scale_size_continuous(range = c(3, 7)) +
  scale_color_viridis(option = "D")

ggplot(grid_results_df[1:200,], aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(color = likelihood)) 


ggplot(grid_results_df, aes(sigma_f, prop_f)) +
  geom_density_2d()

v <- ggplot(grid_results_df, aes(sigma_f, prop_f, z = -likelihood))
v + geom_contour_filled() + labs(fill = "- Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 16))

v <- ggplot(grid_results_df, aes(sigma_f, prop_f, z = log(-(likelihood))))
v + geom_contour_filled() + labs(fill = "log neg Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 16))

v <- ggplot(grid_results_df, aes(sigma_f, prop_f, z = log(-(likelihood))))
v + geom_contour_filled() + labs(fill = "log neg Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 16)) + geom_point(aes(x=0.1, y=0.4), colour="red", size = 3) + geom_point(aes(x= 0.35, y=0.2), colour="orange", size = 3)
```

```{r}
grid_results_df2 <- data.frame(matrix(0, nrow = 441, ncol = 3))
colnames(grid_results_df2) <- c("sigma_f","prop_f","likelihood")
grid_results_df2$sigma_f <- rep(((10:30)/200),21)
grid_results_df2$prop_f <- sort(rep(((70:90)/200),21))
grid_results_df2$likelihood <- c(likelihood_grid2[,1],likelihood_grid2[,2],likelihood_grid2[,3],likelihood_grid2[,4], likelihood_grid2[,5],likelihood_grid2[,6],likelihood_grid2[,7],likelihood_grid2[,8], likelihood_grid2[,9],likelihood_grid2[,10], likelihood_grid2[,11],likelihood_grid2[,12], likelihood_grid2[,13],likelihood_grid2[,14], likelihood_grid2[,15],likelihood_grid2[,16], likelihood_grid2[,17],likelihood_grid2[,18], likelihood_grid2[,19],likelihood_grid2[,20], likelihood_grid2[,21])

ggplot(grid_results_df2, aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(color = likelihood)) 

ggplot(grid_results_df2, aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(size = (likelihood),color = (likelihood))) +
  scale_size_continuous(range = c(3, 7)) +
  scale_color_viridis(option = "D")

v <- ggplot(grid_results_df2, aes(sigma_f, prop_f, z = -likelihood)) + scale_x_continuous(breaks = (unique(grid_results_df2$sigma_f))) + scale_y_continuous(breaks = (unique(grid_results_df2$prop_f)))
v + geom_contour_filled() + labs(fill = "- Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 12))
```

```{r}
grid_results_df3 <- data.frame(matrix(0, nrow = 441, ncol = 3))
colnames(grid_results_df3) <- c("sigma_f","prop_f","likelihood")
grid_results_df3$sigma_f <- rep(((60:80)/200),21)
grid_results_df3$prop_f <- sort(rep(((30:50)/200),21))
grid_results_df3$likelihood <- c(likelihood_grid3[,1],likelihood_grid3[,2],likelihood_grid3[,3],likelihood_grid3[,4], likelihood_grid3[,5],likelihood_grid3[,6],likelihood_grid3[,7],likelihood_grid3[,8], likelihood_grid3[,9],likelihood_grid3[,10], likelihood_grid3[,11],likelihood_grid3[,12], likelihood_grid3[,13],likelihood_grid3[,14], likelihood_grid3[,15],likelihood_grid3[,16], likelihood_grid3[,17],likelihood_grid3[,18], likelihood_grid3[,19],likelihood_grid3[,20], likelihood_grid3[,21])

#ggplot(grid_results_df3, aes(x=sigma_f, y=prop_f) ) +
#  geom_point(aes(color = likelihood)) 

ggplot(grid_results_df3, aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(size = (likelihood),color = (likelihood))) +
  scale_size_continuous(range = c(3, 7)) +
  scale_color_viridis(option = "D")

v <- ggplot(grid_results_df3, aes(sigma_f, prop_f, z = -likelihood)) + scale_x_continuous(breaks = (unique(grid_results_df3$sigma_f))) + scale_y_continuous(breaks = (unique(grid_results_df3$prop_f)))
v + geom_contour_filled() + labs(fill = "- Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 12))
```


```{r}
grid_results_df4 <- data.frame(matrix(0, nrow = 2009, ncol = 3))
colnames(grid_results_df4) <- c("sigma_f","prop_f","likelihood")
grid_results_df4$sigma_f <- rep(((0:40)/100),49)
grid_results_df4$prop_f <- sort(rep((12:60)/100,41))

# make larger grid around max
likelihood_grid4 <- gridSearch(sigma_f_vals = (0:40)/100, prop_f_vals = (12:60)/100)
rownames(likelihood_grid4) <- (0:40)/100
colnames(likelihood_grid4) <- (12:60)/100
saveRDS(likelihood_grid4,"likelihood_grid4.rds")

grid_results_df4$likelihood <- c(likelihood_grid4[,1],likelihood_grid4[,2],likelihood_grid4[,3],likelihood_grid4[,4], likelihood_grid4[,5],likelihood_grid4[,6],likelihood_grid4[,7],likelihood_grid4[,8], likelihood_grid4[,9],likelihood_grid4[,10], likelihood_grid4[,11],likelihood_grid4[,12], likelihood_grid4[,13],likelihood_grid4[,14], likelihood_grid4[,15],likelihood_grid4[,16], likelihood_grid4[,17],likelihood_grid4[,18], likelihood_grid4[,19],likelihood_grid4[,20], likelihood_grid4[,21],
likelihood_grid4[,22],likelihood_grid4[,23],likelihood_grid4[,24],likelihood_grid4[,25], likelihood_grid4[,26],likelihood_grid4[,27],likelihood_grid4[,28],likelihood_grid4[,29], likelihood_grid4[,30],likelihood_grid4[,31],
likelihood_grid4[,32], likelihood_grid4[,33],likelihood_grid4[,34], likelihood_grid4[,35],likelihood_grid4[,36], likelihood_grid4[,37],likelihood_grid4[,38], likelihood_grid4[,39],likelihood_grid4[,40], likelihood_grid4[,41],likelihood_grid4[,42],likelihood_grid4[,43],likelihood_grid4[,44],likelihood_grid4[,45], likelihood_grid4[,46],likelihood_grid4[,47],likelihood_grid4[,48],likelihood_grid4[,49])

ggplot(grid_results_df4, aes(x=sigma_f, y=prop_f) ) +
  geom_point(aes(size = (likelihood),color = -log(-(likelihood)))) +
  scale_size_continuous(range = c(3, 7)) +
  scale_color_viridis(option = "D")

v <- ggplot(grid_results_df4, aes(sigma_f, prop_f, z = -likelihood)) + scale_x_continuous(breaks = (unique(grid_results_df4$sigma_f))) + scale_y_continuous(breaks = (unique(grid_results_df4$prop_f)))
v + geom_contour_filled() + labs(fill = "- Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 12))

# do log!
v <- ggplot(grid_results_df4, aes(sigma_f, prop_f, z = log(-(likelihood))))
v + geom_contour_filled() + labs(fill = "log neg Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 12))

```


```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.05", type = "l", ylim = c(-500, -240), xlab = "sigma_f", ylab = "likelihood", xaxt='n')
axis(1,at=(1:20)/20)
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.1", col = col_clb[2])
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.15", col = col_clb[3])
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.2", col = col_clb[4])
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.25", col = col_clb[5])
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.3", col = col_clb[6])
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.35", col = col_clb[7])
lines(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.4", col = col_clb[8])
legend(0, -400, legend=c("prop_f 0.05", "prop_f 0.1", "prop_f 0.15", "prop_f 0.2", "prop_f 0.25", "prop_f 0.3", "prop_f 0.35", "prop_f 0.4"),
       col=col_clb, lty=1, cex=0.8)
```

```{r}
plot(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.05", ylim = c(-500, -240), xlab = "sigma_f", ylab = "likelihood", xaxt='n')
axis(1,at=(1:20)/20)
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.1", col = col_clb[2])
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.15", col = col_clb[3])
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.2", col = col_clb[4])
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.25", col = col_clb[5])
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.3", col = col_clb[6])
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.35", col = col_clb[7])
points(as.numeric(rownames(likelihood_grid)),likelihood_grid$"0.4", col = col_clb[8])
legend(0, -400, legend=c("prop_f 0.05", "prop_f 0.1", "prop_f 0.15", "prop_f 0.2", "prop_f 0.25", "prop_f 0.3", "prop_f 0.35", "prop_f 0.4"),
       col=col_clb, lty=1, cex=0.8)
```

# check convergence to some equilibrium
```{r fig.height=5, fig.width=7}
# parameters from ggCPP fit with 4 parameter model (15.4.2024)
# but with transformed sigma_f, sigma_w and m because that is the current version of my model
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), sigma_w = -1000, prop_f = 0.37657870, delta = ggC_delta_ranking, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
par(mfrow=c(1,1))
n_times <- 1800
n_times <- 73*4
x <- array(NA, dim = c(WFmodel_ggCPP$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_ggCPP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]



par(mar = c(4.1, 5.1, 0.5, 0.5), las = 1)
if (length(x[,1,1]) <= 8){
  cols <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors
} else {
  cols <- rainbow(length(x[,1,1]))
}


library(dplyr)
library(zoo)
par(ask = FALSE)
matplot(time,(x[1,1 , ]), type = "l",
         xlab = "Time", ylab = "Number of individuals",
         col = cols[1], lty = 1, ylim = range(x))
for (species in 2:length(x[,1,1])) {
  matlines(time, (x[species,1 , ]), col = cols[species], lty = 1)
}


legend("bottomright", lwd = 1, col = cols[1:length(x[,1,1])], legend = 1:length(x[,1,1]), bty = "n")

# yes, looks like we're reaching some sort of an equilibrium (with random variation and migration effects)
```

# check behaviour for v=0
```{r fig.height=5, fig.width=7}
# parameters from ggCPP fit with 4 parameter model (15.4.2024)
# but with transformed sigma_f, sigma_w and m because that is the current version of my model
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), sigma_w = -1000, prop_f = 0.37657870, delta = ggC_delta_ranking, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
par(mfrow=c(1,1))

n_times <- 73
x <- array(NA, dim = c(WFmodel_ggCPP$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_ggCPP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]



par(mar = c(4.1, 5.1, 0.5, 0.5), las = 1)
if (length(x[,1,1]) <= 8){
  cols <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors
} else {
  cols <- rainbow(length(x[,1,1]))
}


library(dplyr)
library(zoo)
par(ask = FALSE)
matplot(time,(x[1,1 , ]), type = "l",
         xlab = "Time", ylab = "Number of individuals",
         col = cols[1], lty = 1, ylim = range(x))
for (species in 2:length(x[,1,1])) {
  matlines(time, (x[species,1 , ]), col = cols[species], lty = 1)
}


legend("bottomright", lwd = 1, col = cols[1:length(x[,1,1])], legend = 1:length(x[,1,1]), bty = "n")

# yes, looks like we're staying in the equilibrium, as expected. No major changes in frequencies. Good.
```

# try different values for vacc_time and check likelihood

```{r fig.height=5, fig.width=7}
# parameters from ggCPP fit with 4 parameter model (15.4.2024)
# but with transformed sigma_f, sigma_w and m because that is the current version of my model

vacc_time_like <- rep(0, 73)
for (i in 0:72) {
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), sigma_w = -1000, prop_f = 0.37657870, delta = ggC_delta_ranking, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = i)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
par(mfrow=c(1,1))
n_times <- 73
x <- array(NA, dim = c(WFmodel_ggCPP$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_ggCPP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
vacc_time_like[i+1] <- combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
} 

# vacc_time = 0
# -252.3514
# vacc_time=1
# -271.0356
# vacc_time=2
# -372.3324
# vacc_time = 36
# -384.2878

# in this case, using vacc_time=0 is optimal. But all the parameters were fitting based on this. So it might be different if I fit vacc_time...?
```


```{r}

ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), sigma_w = -1000, prop_f = 0.37657870, delta = ggC_delta_ranking, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_ggCPP$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_ggCPP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)

# post-pre
# [1] -252.3691
# peri_post - pre
# [1] -252.3514

# maybe concerning that it does not change anything even though the ordering is quite different?
```

### try directly using delta values
```{r}
WF_delta <- odin.dust::odin_dust("NFDS_Model_directDelta.R")
```

```{r}
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), delta = ggC_delta_data2, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)
WFmodel_delta <- WF_delta$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_delta$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_delta$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
```

```{r}
sigma_f_vals <- (201:300)/200
sigma_f_likelihoods <- rep(0,100)
for (i in 1:100) {
  ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(sigma_f_vals[i]), delta = ggC_delta_data2, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)
WFmodel_delta <- WF_delta$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_delta$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_delta$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
sigma_f_likelihoods[i] <- combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
}

max(sigma_f_likelihoods)
# -1025.874
# -1093.985
# -1007.493
sigma_f_vals[which.max(sigma_f_likelihoods)]
# 0.085
# 0.78
# 1.03
plot(sigma_f_vals,sigma_f_likelihoods)

# really weird distribution for best sigma_f values and all maxima are quite bad compared to the ones with the other models
```

```{r}
library(ggplot2)
library(viridis)

library(gtools)

library(dplyr)

mixedsort(unique(PopPUNK_clusters$Serotype))
mixedorder(unique(PopPUNK_clusters$Serotype))

PopPUNK_clusters$Serotype= factor(PopPUNK_clusters$Serotype,levels=mixedsort(unique(PopPUNK_clusters$Serotype)))
ggplot(data = PopPUNK_clusters, aes(x = Cluster)) + geom_bar(stat = "count", aes(fill = Serotype))  + 
  scale_x_continuous("Cluster", labels = as.character(PopPUNK_clusters$Cluster), breaks = PopPUNK_clusters$Cluster) + 
  scale_fill_viridis(option = "D", discrete = TRUE) +
  ggtitle("PopPUNK clusters coloured by Serotype")


ggplot(data = PopPUNK_clusters[which(PopPUNK_clusters$SeqYear=="2001"),], aes(x = Cluster)) + geom_bar(stat = "count", aes(fill = Serotype))  + 
  scale_x_continuous("Cluster", labels = as.character(PopPUNK_clusters$Cluster), breaks = PopPUNK_clusters$Cluster) + 
  scale_fill_viridis(option = "D", discrete = TRUE) +
  ggtitle("PopPUNK clusters coloured by Serotype 2001")
ggplot(data = PopPUNK_clusters[which(PopPUNK_clusters$SeqYear=="2004"),], aes(x = Cluster)) + geom_bar(stat = "count", aes(fill = Serotype))  + 
  scale_x_continuous("Cluster", labels = as.character(PopPUNK_clusters$Cluster), breaks = PopPUNK_clusters$Cluster) + 
  scale_fill_viridis(option = "D", discrete = TRUE) +
  ggtitle("PopPUNK clusters coloured by Serotype 2004")
ggplot(data = PopPUNK_clusters[which(PopPUNK_clusters$SeqYear=="2007"),], aes(x = Cluster)) + geom_bar(stat = "count", aes(fill = Serotype))  + 
  scale_x_continuous("Cluster", labels = as.character(PopPUNK_clusters$Cluster), breaks = PopPUNK_clusters$Cluster) + 
  scale_fill_viridis(option = "D", discrete = TRUE) +
  ggtitle("PopPUNK clusters coloured by Serotype 2007")


# PopPUNK clusters coloured by BAPS clusters (confusing)
ggplot(data = PopPUNK_clusters, aes(x = Cluster)) + geom_bar(stat = "count", aes(fill = as.factor(PP_to_manSeq_dict[Cluster]))) +
  scale_x_continuous("Cluster", labels = as.character(PopPUNK_clusters$Cluster), breaks = PopPUNK_clusters$Cluster) + 
  scale_fill_viridis(option = "D", discrete = TRUE)

# BAPS clusters coloured by serotype
ggplot(data = Mass_Samples_accCodes, aes(x = SequenceCluster)) + geom_bar(stat = "count", aes(fill = Serotype))  + 
  scale_x_continuous("Cluster", labels = as.character(Mass_Samples_accCodes$SequenceCluster), breaks = Mass_Samples_accCodes$SequenceCluster) + ggtitle("PopPUNK clusters coloured by Serotype") + scale_fill_viridis(option = "D", discrete = TRUE)

ggplot(data = Mass_Samples_accCodes, aes(x = SequenceCluster)) + geom_bar(stat = "count", aes(fill = as.factor(SequenceCluster))) +
  scale_x_continuous("Clusters (BAPS)", labels = as.character(Mass_Samples_accCodes$SequenceCluster), breaks = Mass_Samples_accCodes$SequenceCluster) + scale_fill_viridis(option = "D", discrete = TRUE)

ggplot(data = PopPUNK_clusters, aes(x = factor(Cluster, level = (1:62)[order(PP_to_manSeq_dict[1:62])]))) + geom_bar(stat = "count", aes(fill = as.factor(PP_to_manSeq_dict[Cluster]))) + scale_fill_viridis(option = "D", discrete = TRUE) + scale_x_discrete("Clusters (BAPS)", labels = as.character(sort(PP_to_manSeq_dict[1:62])),breaks = (1:62)[order(PP_to_manSeq_dict[1:62])])

ggplot(data = PopPUNK_clusters, aes(x = factor(Cluster, level = (1:62)[order(PP_to_manSeq_dict[1:62])]))) + geom_bar(stat = "count", aes(fill = as.factor(PP_to_manSeq_dict[Cluster]))) + scale_fill_viridis(option = "D", discrete = TRUE) + scale_x_discrete("Clusters (PopPUNK)", labels = as.character((1:62)[order(PP_to_manSeq_dict[1:62])]),breaks = (1:62)[order(PP_to_manSeq_dict[1:62])])


ggplot(data = PopPUNK_clusters, aes(x = Cluster)) + geom_bar(stat = "count", aes(fill = Serotype))

ggplot(grid_results_df, aes(sigma_f, prop_f, z = -likelihood))
v + geom_contour_filled() + labs(fill = "- Likelihood") + theme(legend.title = element_text(size = 16),legend.text = element_text(size = 16), axis.title = element_text(size = 16),axis.text = element_text(size = 16))
```

# create super clusters that allow for comparing serotypes and cluster likelihoods
```{r}
for (i in 1:mass_clusters) {
  print(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
}

for (i in 1:length(unique(Mass_Samples_accCodes$Serotype))) {
  st <- unique(Mass_Samples_accCodes$Serotype)[i]
  print(st)
  print(Mass_Samples_accCodes$SequenceCluster[which(Mass_Samples_accCodes$Serotype==st)])
}

merged_mass_clusters <- c()
merged_mass_clusters["0"] <- 0
merged_mass_clusters["1"] <- 0
merged_mass_clusters["2"] <- 0
merged_mass_clusters["3"] <- 0
merged_mass_clusters["5"] <- 0
merged_mass_clusters["6"] <- 0
merged_mass_clusters["8"] <- 0
merged_mass_clusters["9"] <- 0
merged_mass_clusters["10"] <- 0
merged_mass_clusters["11"] <- 0
merged_mass_clusters["12"] <- 0
merged_mass_clusters["13"] <- 0
merged_mass_clusters["14"] <- 0
merged_mass_clusters["15"] <- 0
merged_mass_clusters["17"] <- 0
merged_mass_clusters["18"] <- 0
merged_mass_clusters["20"] <- 0
merged_mass_clusters["21"] <- 0
merged_mass_clusters["23"] <- 0
merged_mass_clusters["24"] <- 0
merged_mass_clusters["25"] <- 0
merged_mass_clusters["26"] <- 0
merged_mass_clusters["28"] <- 0
merged_mass_clusters["29"] <- 0
merged_mass_clusters["31"] <- 0
merged_mass_clusters["32"] <- 0
merged_mass_clusters["34"] <- 0
merged_mass_clusters["35"] <- 0
merged_mass_clusters["36"] <- 0
merged_mass_clusters["37"] <- 0
merged_mass_clusters["39"] <- 0
merged_mass_clusters["40"] <- 0

merged_mass_clusters["4"] <- 1

merged_mass_clusters["7"] <- 2
merged_mass_clusters["30"] <- 2
merged_mass_clusters["33"] <- 2

merged_mass_clusters["16"] <- 3

merged_mass_clusters["19"] <- 4

merged_mass_clusters["22"] <- 5

merged_mass_clusters["27"] <- 6

merged_mass_clusters["38"] <- 7


# checking that each serotype correspond to only one super cluster
for (i in 1:length(unique(Mass_Samples_accCodes$Serotype))) {
  st <- unique(Mass_Samples_accCodes$Serotype)[i]
  print(st)
  print(merged_mass_clusters[as.character(Mass_Samples_accCodes$SequenceCluster[which(Mass_Samples_accCodes$Serotype==st)])])
}

#saveRDS(merged_mass_clusters, "merged_mass_clusters.rds")

sero_to_mergedClust <- rep(0, length(unique(Mass_Samples_accCodes$Serotype)))
names(sero_to_mergedClust) <- (unique(Mass_Samples_accCodes$Serotype))
for (i in 1:length(unique(Mass_Samples_accCodes$Serotype))) {
  sero_to_mergedClust[i] <- merged_mass_clusters[as.character(Mass_Samples_accCodes$SequenceCluster[which(Mass_Samples_accCodes$Serotype==names(sero_to_mergedClust)[i])])][1]
}
#saveRDS(sero_to_mergedClust, "sero_to_mergedClust.rds")
```

```{r}
merged_mass_clusters <- readRDS("merged_mass_clusters.rds")
# aggregate data to super clusters as well
merged_cluster_freq_2 <- rep(0,length(unique(merged_mass_clusters)))
merged_cluster_freq_3 <- rep(0,length(unique(merged_mass_clusters)))
for (i in 1:length(unique(merged_mass_clusters))) {
  merged_cluster_freq_2[i] <- sum(mass_cluster_freq_2[as.integer(names(which(merged_mass_clusters==i-1)))+1])
  merged_cluster_freq_3[i] <- sum(mass_cluster_freq_3[as.integer(names(which(merged_mass_clusters==i-1)))+1])
}





all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.092853976), sigma_w = log(0.001272531), prop_f = (0.279026024), delta = delta_ranking, m = log(0.003294931), migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = (0.104832549), vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMean2 <- rowMeans(WFmodel$run(36)[-1,])
simMean3 <- rowMeans(WFmodel$run(72)[-1,])

simMean2_merged <- rep(0, length(unique(merged_mass_clusters)))
simMean3_merged <- rep(0, length(unique(merged_mass_clusters)))
for (i in 1:length(names(sero_to_mergedClust))) {
  simMean2_merged[sero_to_mergedClust[i]+1] <- simMean2_merged[sero_to_mergedClust[i]+1] + simMean2[i]
  simMean3_merged[sero_to_mergedClust[i]+1] <- simMean3_merged[sero_to_mergedClust[i]+1] + simMean3[i]
}

# COG + serotypes
combined_compare(simMean2_merged,merged_cluster_freq_2) + combined_compare(simMean3_merged,merged_cluster_freq_3)
# [1] -44.67209


params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.5725576970), sigma_w = log(0.0006811699), prop_f = 0.2041288111 , delta = delta_ranking, m = log(0.0057202667) , migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1204141788, vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMean2 <- rowMeans(WFmodel$run(36)[-1,])
simMean3 <- rowMeans(WFmodel$run(72)[-1,])

simMean2_merged <- rep(0, length(unique(merged_mass_clusters)))
simMean3_merged <- rep(0, length(unique(merged_mass_clusters)))
for (i in 1:length(unique(merged_mass_clusters))) {
  simMean2_merged[i] <- sum(simMean2[as.integer(names(which(merged_mass_clusters==i-1)))+1])
  simMean3_merged[i] <- sum(simMean3[as.integer(names(which(merged_mass_clusters==i-1)))+1])
}

# COG + BAPS
combined_compare(simMean2_merged,merged_cluster_freq_2) + combined_compare(simMean3_merged,merged_cluster_freq_3)
# -43.32019

all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.2169393333), sigma_w = log(0.0006359267), prop_f = 0.4202932608, delta = delta_ranking, m = log(0.0123196210), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1176109076, vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMean2 <- rowMeans(WFmodel$run(36)[-1,])
simMean3 <- rowMeans(WFmodel$run(72)[-1,])

simMean2_merged <- rep(0, length(unique(merged_mass_clusters)))
simMean3_merged <- rep(0, length(unique(merged_mass_clusters)))
for (i in 1:length(names(PP_to_manSeq_dict))) {
  simMean2_merged[merged_mass_clusters[as.character(PP_to_manSeq_dict[i])]+1] <- simMean2_merged[merged_mass_clusters[as.character(PP_to_manSeq_dict[i])]+1] + simMean2[i]
  simMean3_merged[merged_mass_clusters[as.character(PP_to_manSeq_dict[i])]+1] <- simMean3_merged[merged_mass_clusters[as.character(PP_to_manSeq_dict[i])]+1] + simMean3[i]
}


# COG + PopPUNK
combined_compare(simMean2_merged,merged_cluster_freq_2) + combined_compare(simMean3_merged,merged_cluster_freq_3)
# -43.46789

# for comparison: 3-param model
params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.007877661), sigma_w = (-1000), prop_f = 1 , delta = delta_ranking, m = log(0.008008877) , migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.048982297, vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMean2 <- rowMeans(WFmodel$run(36)[-1,])
simMean3 <- rowMeans(WFmodel$run(72)[-1,])

simMean2_merged <- rep(0, length(unique(merged_mass_clusters)))
simMean3_merged <- rep(0, length(unique(merged_mass_clusters)))
for (i in 1:length(unique(merged_mass_clusters))) {
  simMean2_merged[i] <- sum(simMean2[as.integer(names(which(merged_mass_clusters==i-1)))+1])
  simMean3_merged[i] <- sum(simMean3[as.integer(names(which(merged_mass_clusters==i-1)))+1])
}

# COG + BAPS
combined_compare(simMean2_merged,merged_cluster_freq_2) + combined_compare(simMean3_merged,merged_cluster_freq_3)
# -46.67963

```

#PPxSero for Mass has been moved to Mass_data_processing

```{r}
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")
```

```{r}
PPxSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop2, Pop_eq = as.double(rowSums(PPsero_startpop2)), capacity = sum(PPsero_startpop2), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.14), prop_f = 0.38, delta = ggC_delta_ranking, m = log(0.011), migVec = PPxSero_matrix_prob, vaccTypes = SeroVT, v = 0.15, vacc_time = 0)
WFmodel_ppxSero <- WF_PPxSero$new(pars = PPxSero_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
WFmodel_ppxSero$run(1)

# test index function for PPxSero model
# index(WFmodel_ppxSero$info())$run
```

```{r}
WFmodel_ppxSero <- WF_PPxSero$new(pars = PPxSero_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
x <- array(NA, dim = c(WFmodel_ppxSero$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel_ppxSero$run(t)
  }
time <- x[1, 1, ]
x <- x[-1, , ]
combined_compare(x[1:PP_mass_clusters,1,37],PP_mass_cluster_freq_2) + combined_compare(x[1:PP_mass_clusters,1,73],PP_mass_cluster_freq_3)


combined_compare(WFmodel_ppxSero$run(1)[2:(PP_mass_clusters+1),1],PP_mass_cluster_freq_1)
# [1] -102.253
combined_compare(ggCPP_WFmodel$run(1)[2:(PP_mass_clusters+1),1],PP_mass_cluster_freq_1)
# [1] -55.15877

# hmm, the start likelihood is already almost twice as high. that's not great. So I think I need to change how I generate the start population for the PPxSero model. Since the likelihood definition did not change, the likelihood also shouldn't change.

# now, with the new start population definition (PPsero_startpop2), the likelihoods are very similar
combined_compare(WFmodel_ppxSero$run(1)[2:(PP_mass_clusters+1),1],PP_mass_cluster_freq_1)
#[1] -55.1599
```

```{r}
# ggCPP fit 
fitPPxSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop2, Pop_eq = as.double(rowSums(PPsero_startpop2)), capacity = sum(PPsero_startpop2), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -1.6952228, prop_f = 0.3875749, delta = ggC_delta_ranking, m = -3.5522149, migVec = PPxSero_matrix_prob, vaccTypes = SeroVT, v = 0.2403443, vacc_time = 0)
WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanggCPP2_log <- rowMeans(WFmodel_ppxSero$run(36)[2:(PP_mass_clusters+1),])
simMeanggCPP3_log <- rowMeans(WFmodel_ppxSero$run(72)[2:(PP_mass_clusters+1),])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

#combined_compare(simMeanggCPP2_log,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3_log,PP_mass_cluster_freq_3)
#combined_compare(simMeanggCPP2,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3,PP_mass_cluster_freq_3)
```

```{r}
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Standard Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), model_name_2 ="Sero Sub-comp.", model2 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Standard Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model_name_2 ="Sero Sub-comp.", model2 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

```

```{r}
library("viridis") 
# create stacked barplot to investigate within cluster changes:
WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
#PP_cl <- sort(rep((1:PP_mass_clusters),length(serotypes_mass)))
#Sero <- rep((1:length(serotypes_mass)), PP_mass_clusters)
#SeroLabel = PP_serotype_comp

PP_cl <-rep((1:PP_mass_clusters),length(serotypes_mass))
Sero <-  sort(rep((1:length(serotypes_mass)), PP_mass_clusters))
time1 <- WFmodel_ppxSero$run(1)[-(1:(PP_mass_clusters+1)),1]/sum(WFmodel_ppxSero$run(1)[-(1:(PP_mass_clusters+1)),1])
time2 <- WFmodel_ppxSero$run(36)[-(1:(PP_mass_clusters+1)),1]/sum(WFmodel_ppxSero$run(36)[-(1:(PP_mass_clusters+1)),1])
time3 <- WFmodel_ppxSero$run(72)[-(1:(PP_mass_clusters+1)),1]/sum(WFmodel_ppxSero$run(72)[-(1:(PP_mass_clusters+1)),1])
barplot_PPxSero_data <- data.frame(PP_cl,Sero,time1, time2, time3)

ggplot(barplot_PPxSero_data, aes(fill=as.factor(Sero), y=time1, x=PP_cl)) + 
    geom_bar(position="stack", stat="identity") + scale_fill_viridis(option = "D", discrete = TRUE, name = "Serotype") + theme(legend.position = c(.8,.6),legend.text = element_text(size = 20),legend.title = element_text(size = 20)) 

ggplot(barplot_PPxSero_data, aes(fill=IndexToSerotype_dict[as.factor(Sero)], y=time1, x=PP_cl)) + coord_flip()+ 
    geom_bar(position="stack", stat="identity") + scale_fill_viridis(option = "D", discrete = TRUE, name = "Serotype") +
  ggtitle("2001") + ylab("Frequency") + xlab("Clusters") + theme(legend.position = c(.8,.6),legend.text = element_text(size = 20),legend.title = element_text(size = 20)) +
  scale_x_continuous(breaks = 1:62, sec.axis = dup_axis(name = "Serotypes", labels = PP_serotype_comp))
ggplot(barplot_PPxSero_data, aes(fill=IndexToSerotype_dict[as.factor(Sero)], y=time2, x=PP_cl)) +  coord_flip()+
    geom_bar(position="stack", stat="identity") + scale_fill_viridis(option = "D", discrete = TRUE, name = "Serotype") +
  ggtitle("2004") + ylab("Frequency") + xlab("Clusters") + theme(legend.position = c(.8,.6),legend.text = element_text(size = 20),legend.title = element_text(size = 20)) +
  scale_x_continuous(breaks = 1:62, sec.axis = dup_axis(name = "Serotypes", labels = PP_serotype_comp))
ggplot(barplot_PPxSero_data, aes(fill=IndexToSerotype_dict[as.factor(Sero)], y=time3, x=PP_cl)) +  coord_flip()+
    geom_bar(position="stack", stat="identity") + scale_fill_viridis(option = "D", discrete = TRUE, name = "Serotype") +
  ggtitle("2007") + ylab("Frequency") + xlab("Clusters") + theme(legend.position = c(.8,.6),legend.text = element_text(size = 20),legend.title = element_text(size = 20)) +
  scale_x_continuous(breaks = 1:62, sec.axis = dup_axis(name = "Serotypes", labels = PP_serotype_comp))
```

```{r}
PP_data_2007 <- rep(0, (length(serotypes_mass) * PP_mass_clusters))

for (i in which(PopPUNK_clusters$SeqYear=="2007")) {
  PP_data_2007[((SerotypeToIndex_dict[PopPUNK_clusters$Serotype[i]] -1) * PP_mass_clusters) + PopPUNK_clusters$Cluster[i]] <- 
  PP_data_2007[((SerotypeToIndex_dict[PopPUNK_clusters$Serotype[i]] -1) * PP_mass_clusters) + PopPUNK_clusters$Cluster[i]] + 1
}  

PP_data_2007 <- PP_data_2007/ sum(PP_data_2007)
barplot_PPxSero_data$PPdata_2007 <- PP_data_2007
  
ggplot(barplot_PPxSero_data, aes(fill=IndexToSerotype_dict[as.factor(Sero)], y=PPdata_2007, x=PP_cl)) +  coord_flip()+
    geom_bar(position="stack", stat="identity") + scale_fill_viridis(option = "D", discrete = TRUE, name = "Serotype") +
  ggtitle("2007 DATA") + ylab("Frequency") + xlab("Clusters") + theme(legend.position = c(.8,.6),legend.text = element_text(size = 20),legend.title = element_text(size = 20))+
  scale_x_continuous(breaks = 1:62, sec.axis = dup_axis(name = "Serotypes", labels = PP_serotype_comp))
```

```{r}
barplot_PPxSero_data2 <- data.frame(rep(PP_cl,2), rep(Sero,2),c(time3, PP_data_2007))
barplot_PPxSero_data2$category <- c(rep(0,length(PP_cl)),rep(1,length(PP_cl)))
colnames(barplot_PPxSero_data2) <- c("Cluster","Serotype","Value","category")


  ggplot(barplot_PPxSero_data2, aes(fill=IndexToSerotype_dict[as.factor(Serotype)], y=Value, x=(category))) +  
    geom_bar(position="stack", stat="identity") + scale_fill_viridis(option = "D", discrete = TRUE, name = "Serotype") +
  ggtitle("2007") + ylab("Frequency") + xlab("Clusters") + theme(legend.position = c(.8,.6),legend.text = element_text(size = 20),legend.title = element_text(size = 20)) +
  facet_grid( ~ Cluster) + scale_x_continuous("Model / Data", labels = c("M","D"), breaks = c(0,1))
```

### check results 
```{r}
# path to results: 
results_path_22 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_05_22/"
ga_results <- readRDS(paste(results_path_22, "FindGenesGA_results.rds",sep = ""))

plot(ga_results)
summary(ga_results)
as.vector(t(apply(ga_results@solution, 1, decode2)))
sum(as.vector(t(apply(ga_results@solution, 1, decode2))))/length(best_best_vec)

# all values between 0.3 and 0.65
plot(as.vector(ga_results@solution))
plot(sort(as.vector(ga_results@solution)))

ga_results_dict <- as.vector(ga_results@solution)
names(ga_results_dict) <- 1:length(as.vector(ga_results@solution))

ggC_delta_data3_newNames <- ggC_delta_data3
names(ggC_delta_data3_newNames) <- 1:length(ggC_delta_data3)

plot((ga_results_dict)[(names(sort(ggC_delta_data3_newNames)))])
```

# try running model with Nepal data
#define parameters for the model:
```{r}
Nepal_ggCaller_intermed_consensus_matrix <- sapply(Nepal_ggCaller_intermed_consensus[-1,-1],as.double)
Nepal_avg_cluster_freq <- rep(1/no_Nepal_PP, no_Nepal_PP)

params_Nepal <- list(dt = 1/12, species_no = no_Nepal_PP,  gene_no = nrow(Nepal_ggCaller_intermed_consensus)-1, Pop_ini = as.double(Nepal_model_start_pop), Pop_eq = as.double(Nepal_model_start_pop), capacity = sum(Nepal_model_start_pop), Genotypes = Nepal_ggCaller_intermed_consensus_matrix, sigma_f = log(0.1133391187), sigma_w = log(0.0003826182), prop_f = 0.3803189582, delta = Nepal_delta_ranking, m = log(0.0108386117) , migVec = Nepal_avg_cluster_freq, vaccTypes = Nepal_VT, v = 0.1441624728, vacc_time = 9)

```

# Note to myself: time points for nepal are 2005 2006 2007 2008 2009 2011 2012 2013 2014 2015 2016 2017 2018
# 2010 is missing --> that is an issue for odin.dust/mcstate I think, so I should probably pad that

### Running the model:
```{r}
WFmodel_Nepal <- WF_nG_h_vP$new(pars = params_Nepal,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_Nepal$run(13*12)
```

```{r}
n_particles <- 10L
  n_times <- 13*12
  x <- array(NA, dim = c(WFmodel_Nepal$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel_Nepal$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  
library(dplyr)
library(zoo)
if (length(x[,1,1]) <= 8){
  cols <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors
} else {
  cols <- rainbow(length(x[,1,1]))
}
par(ask = FALSE)
matplot(time,(x[1,1 , ]), type = "l",
         xlab = "Time", ylab = "Number of individuals",
         col = cols[1], lty = 1, ylim = range(x))
for (species in 2:length(x[,1,1])) {
  matlines(time, (x[species,1 , ]), col = cols[species], lty = 1)
}
```

```{r}
fitted_params_Nepal <- list(dt = 1/12, species_no = no_Nepal_PP,  gene_no = nrow(Nepal_ggCaller_intermed_consensus)-1, Pop_ini = as.double(Nepal_model_start_pop), Pop_eq = as.double(Nepal_model_start_pop), capacity = sum(Nepal_model_start_pop), Genotypes = Nepal_ggCaller_intermed_consensus_matrix, sigma_f = -0.96064922, sigma_w = -1000, prop_f = 0.18276138, delta = Nepal_delta_ranking, m = -5.18194723 , migVec = Nepal_avg_cluster_freq, vaccTypes = Nepal_VT, v = 0.01538689, vacc_time = 9)


WFmodel_Nepal <- WF_nG_h_vP$new(pars = fitted_params_Nepal,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanggCPP1_Nepal <- rowMeans(WFmodel_Nepal$run(1)[-1,])
simMeanggCPP2_Nepal <- rowMeans(WFmodel_Nepal$run(12)[-1,])
simMeanggCPP3_Nepal <- rowMeans(WFmodel_Nepal$run(24)[-1,])
simMeanggCPP4_Nepal <- rowMeans(WFmodel_Nepal$run(36)[-1,])
simMeanggCPP5_Nepal <- rowMeans(WFmodel_Nepal$run(48)[-1,])
simMeanggCPP6_Nepal <- rowMeans(WFmodel_Nepal$run(60)[-1,])
simMeanggCPP7_Nepal <- rowMeans(WFmodel_Nepal$run(72)[-1,])
simMeanggCPP8_Nepal <- rowMeans(WFmodel_Nepal$run(84)[-1,])
simMeanggCPP9_Nepal <- rowMeans(WFmodel_Nepal$run(96)[-1,])
simMeanggCPP10_Nepal <- rowMeans(WFmodel_Nepal$run(108)[-1,])
simMeanggCPP11_Nepal <- rowMeans(WFmodel_Nepal$run(120)[-1,])
simMeanggCPP12_Nepal <- rowMeans(WFmodel_Nepal$run(132)[-1,])
simMeanggCPP13_Nepal <- rowMeans(WFmodel_Nepal$run(144)[-1,])
simMeanggCPP14_Nepal <- rowMeans(WFmodel_Nepal$run(156)[-1,])


  nepal_cluster_freq_1 <- readRDS(file = "Nepal_cluster_freqs_1.rds")
  nepal_cluster_freq_2 <- readRDS(file = "Nepal_cluster_freqs_2.rds")
  nepal_cluster_freq_3 <- readRDS(file = "Nepal_cluster_freqs_3.rds")
  nepal_cluster_freq_4 <- readRDS(file = "Nepal_cluster_freqs_4.rds")
  nepal_cluster_freq_5 <- readRDS(file = "Nepal_cluster_freqs_5.rds")
  nepal_cluster_freq_6 <- readRDS(file = "Nepal_cluster_freqs_6.rds")
  nepal_cluster_freq_7 <- readRDS(file = "Nepal_cluster_freqs_7.rds")
  nepal_cluster_freq_8 <- readRDS(file = "Nepal_cluster_freqs_8.rds")
  nepal_cluster_freq_9 <- readRDS(file = "Nepal_cluster_freqs_9.rds")
  nepal_cluster_freq_10 <- readRDS(file = "Nepal_cluster_freqs_10.rds")
  nepal_cluster_freq_11 <- readRDS(file = "Nepal_cluster_freqs_11.rds")
  nepal_cluster_freq_12 <- readRDS(file = "Nepal_cluster_freqs_12.rds")
  nepal_cluster_freq_13 <- readRDS(file = "Nepal_cluster_freqs_13.rds")
   nepal_cluster_freq_14 <- readRDS(file = "Nepal_cluster_freqs_14.rds")

Nepal_VT <- readRDS(file = "Nepal_VT.rds")
mass_clusters <- length(unique(seq_clusters$Cluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
output_filename <- "Nepal_ggCaller_PopPUNK"

Nepal_PopPUNK <- readRDS("Nepal_PP.rds")
no_Nepal_PP <- length(unique(Nepal_PopPUNK$Cluster))

Nepal_PP_serotype_comp <- rep(0,no_Nepal_PP)
for (i in 1:no_Nepal_PP) {
  Nepal_PP_serotype_comp[i] <- paste(unique(Nepal_PopPUNK$Serotype[which(Nepal_PopPUNK$Cluster==i)]), collapse = ", ")
}

Nepal_PP_cluster_freq <- rep(0,no_Nepal_PP)
for (i in 1:no_Nepal_PP) {
  Nepal_PP_cluster_freq[i] <- length(which(Nepal_PopPUNK$Cluster==i))
}
# exclude those from the plot that only occur once
Nepal_PP_cluster_freq_larger1 <- rep(0,no_Nepal_PP)
Nepal_PP_cluster_freq_larger1[Nepal_PP_cluster_freq>1] <- 1

lollipop_cluster_freqs_VTandNVT_labelSero_flipped(year = "2009", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_5[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_5[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP5_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP5_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])
lollipop_cluster_freqs_VTandNVT_labelSero_flipped(year = "2011", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_7[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_7[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP7_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP7_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])
lollipop_cluster_freqs_VTandNVT_labelSero_flipped(year = "2013", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_9[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_9[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP9_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP9_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])
lollipop_cluster_freqs_VTandNVT_labelSero_flipped(year = "2017", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_12[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_12[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP12_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP12_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])
lollipop_cluster_freqs_VTandNVT_labelSero_flipped(year = "2018", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_13[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_13[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP13_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP13_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_5[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_5[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP5_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP5_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
results_path_24 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_05_24/"
Nepal_1stfit <- readRDS(paste(results_path_24,"Nepal_ggCaller_PopPUNK_det_pmcmc_run2.rds",sep = ""))
Nepal_mcmc2 <- coda::as.mcmc(cbind(Nepal_1stfit$probabilities, Nepal_1stfit$pars))
coda::effectiveSize(Nepal_mcmc2)
summary(coda::as.mcmc(Nepal_mcmc2))
```

```{r}
results_path_6_6 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_06_06/run2/"
Nepal_2ndfit <- readRDS(paste(results_path_6_6,"Nepal_ggCaller_PopPUNK_stoch_pmcmc_run2.rds",sep = ""))
Nepal_mcmc2 <- coda::as.mcmc(cbind(Nepal_2ndfit$probabilities, Nepal_2ndfit$pars))
coda::effectiveSize(Nepal_mcmc2)
summary(coda::as.mcmc(Nepal_mcmc2))

processed_chains <- mcstate::pmcmc_thin(Nepal_2ndfit, burnin = 100, thin = 1)
parameter_mean_hpd <- apply(processed_chains$pars, 2, mean)
parameter_mean_hpd
print("det_mcmc_2 final log likelihood")
processed_chains$probabilities[nrow(processed_chains$probabilities),2]
print("det_mcmc_2 mean log likelihood")
mean(processed_chains$probabilities[,2])

det_proposal_matrix <- cov(processed_chains$pars)
```

```{r}
### Nepal det fit
results_path_6_19 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_06_19/"
Nepal_detfit <- readRDS(paste(results_path_6_19,"Nepal_ggCaller_PopPUNK_det_pmcmc_run2.rds",sep = ""))
Nepal_mcmc2 <- coda::as.mcmc(cbind(Nepal_detfit$probabilities, Nepal_detfit$pars))
coda::effectiveSize(Nepal_mcmc2)
summary(coda::as.mcmc(Nepal_mcmc2))
```

```{r}
fitted_params_Nepal <- list(dt = 1/12, species_no = no_Nepal_PP,  gene_no = nrow(Nepal_ggCaller_intermed_consensus)-1, Pop_ini = as.double(Nepal_model_start_pop), Pop_eq = as.double(Nepal_model_start_pop), capacity = sum(Nepal_model_start_pop), Genotypes = Nepal_ggCaller_intermed_consensus_matrix, sigma_f = -4.278e+02, sigma_w = -1000, prop_f = 4.519e-01, delta = Nepal_delta_ranking, m = -1.261e+01 , migVec = Nepal_avg_cluster_freq, vaccTypes = Nepal_VT, v = 1.685e-03, vacc_time = 9)

# run code from lines 3669 3724

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2005", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_1[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_1[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = Nepal_model_start_pop[which(Nepal_PP_cluster_freq>1)]/sum(Nepal_model_start_pop[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2009", plot_title = "PopPUNK and ggCaller", data1 = nepal_cluster_freq_5[which(Nepal_PP_cluster_freq>1)]/sum(nepal_cluster_freq_5[which(Nepal_PP_cluster_freq>1)]), model_name_1 ="Model", model1 = simMeanggCPP5_Nepal[which(Nepal_PP_cluster_freq>1)]/sum(simMeanggCPP5_Nepal[which(Nepal_PP_cluster_freq>1)]), Nepal_VT[which(Nepal_PP_cluster_freq>1)], SeroLabel = Nepal_PP_serotype_comp[which(Nepal_PP_cluster_freq>1)])
```

### analyse results from genetic algorithm for finding NFDS genes
```{r}
ga_results <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_12/gann.rds")
summary(ga_results)
sum(ga_results@solution)

ga_results <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_22/GA/gann.rds")
summary(ga_results)
sum(ga_results@solution)

ga_results <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_25/GA/gann.rds")
summary(ga_results)
sum(ga_results@solution)
ga_results

ga_results <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_15/GA_penaliseNoOfNFDS/gann.rds")
summary(ga_results)
sum(ga_results@solution)
plot(ga_results)
ga_results@fitnessValue + sum(ga_results@solution) # likelihood value
# not bad

ga_results <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_16/GA_FindGenesMinNFDSgenes/gann.rds")
summary(ga_results)
sum(ga_results@solution)
plot(ga_results)
ga_results@fitnessValue + sum(ga_results@solution) # likelihood value -335.8432
# not bad
```

```{r}
WF_model <- odin.dust::odin_dust("NFDS_Model_FindGenes.R")
```

```{r}
# GA fit from 25.07.2024 (~600 generations)

PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
ggCPP_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
ggCPP_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)

FindGenes_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3090376, sigma_w = 0, prop_f = 1, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 1, vacc_time = 0.15977862, delta_bool = (as.vector(ga_results@solution)))



#ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = log(0.11313856), delta = ggC_delta_data2, m = log(0.01107152), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.14340557, vacc_time = 0)

WFmodel <- WF_model$new(pars = FindGenes_ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

#n_particles <- 10L
#n_times <- 73
#x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

#for (t in seq_len(n_times)) {
#  x[ , , t] <- WFmodel$run(t)
#}
#time <- x[1, 1, ]
#x <- x[-1, , ]
#combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)

simMeanggCPP2 <- rowMeans(WFmodel$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel$run(72)[-1,])
combined_compare(simMeanggCPP2,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3,PP_mass_cluster_freq_3) 

# Lollipop for GA results

PP_serotype_comp <- rep(0,PP_mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_serotype_comp[i] <- paste(unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==unique(PopPUNK_clusters$Cluster)[i])]), collapse = ", ")
}

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), VT_vec = PPcluster_VTs, SeroLabel = PP_serotype_comp)


# compare gene vector to delta
ggC_delta_ranking2 <- readRDS("ggC_delta_ranking.rds")
ggC_delta_data2 <- readRDS("ggC_delta_data_post-pre.rds")

ggC_delta_data2_copy <- ggC_delta_data2
names(ggC_delta_data2_copy) <- 1:1770
ggC_delta_data2_copy <- sort(ggC_delta_data2_copy)

found_genes <- (as.vector(ga_results@solution))
found_genes_copy <- (as.vector(ga_results@solution))[as.integer(names(ggC_delta_data2_copy))]

plot(1-ggC_delta_data2_copy, ylim = c(0,1), main = "delta statistics vs. genes from GA")
points(found_genes_copy, col = "red", pch = ".")
legend(0.2,0.2, legend = c("delta stat", "GA"), col = c("black","red"), lty=1:2, cex = 1)

local_cols <- rainbow(12)
plot(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), type = "p", ylim=c(0,0.3))
points(PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), col = "orange")
points(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), col = "red")

# plot delta ranking vs. ga result
# in my latest Mass fit (07.10.2024) 0.3323 of genes are under strong NFDS
# 0.3323 * 1700
#[1] 564.91
delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")

delta_ranking_index <- unname(delta_ranking)
names(delta_ranking_index) <- 1:1700
delta_ranking_index_sorted_names <- names(sort(delta_ranking_index))

NFDS_standard <- c(rep(1, 564), rep(0,1700-564))
ga_found_genes <- (as.vector(ga_results@solution))
ga_found_genes_NFDSsorted <- ga_found_genes[order(unname(delta_ranking))]

sel_ids <- seq(from = 1, to = 1700, by = 10)

NFDS_standard_sel <- NFDS_standard[sel_ids]
ga_found_genes_NFDSsorted_sel <- ga_found_genes_NFDSsorted[sel_ids]

plot(sel_ids,as.logical(NFDS_standard_sel),  xlab="Genes, ordered by frequency changes", ylab="Under NFDS",yaxt = "n",cex.lab=1.5, cex.axis=1.5, cex.main=1.5, cex.sub=1.5, cex = 1.5)
points(sel_ids,ga_found_genes_NFDSsorted_sel, col = "red",cex=1.5 )
legend(100,0.6, legend = c("by frequency changes","by genetic algorithm"), fill = c("black", "red"), cex=1.5)
axis(2, at = c(FALSE,TRUE),cex.axis=1.5)

#Comparison_NFDSgeneticAlg

both_1 <- NFDS_standard * ga_found_genes_NFDSsorted


#sum(ga_found_genes_NFDSsorted[1:564])
#[1] 269
#> sum(ga_found_genes_NFDSsorted[-(1:564)])
#[1] 565
#> NFDS_standard_sel <- NFDS_standard[sel_ids]
#> plot(NFDS_standard_sel)
#> points(ga_found_genes_NFDSsorted_sel, col = "red")
#> 564 - sum(ga_found_genes_NFDSsorted[1:564])
#[1] 295
#> 1700 -564
#[1] 1136
#> 1136 - sum(ga_found_genes_NFDSsorted[-(1:564)])
#[1] 571
#> sum(ga_found_genes_NFDSsorted[565:1700])
#[1] 536
#> length(order(unname(delta_ranking))
#+ )
#[1] 1770
#> length(unique(order(unname(delta_ranking))))
#[1] 1770
#> length(ga_found_genes_NFDSsorted)
#[1] 1770

# create a dataset
cluster <- rep(unique(PopPUNK_clusters$Cluster),3)
cluster_iter <- rep(1:length(unique(PopPUNK_clusters$Cluster)),3)
time <- c(rep("1" , length(unique(PopPUNK_clusters$Cluster))),rep("2", length(unique(PopPUNK_clusters$Cluster))),rep("3", length(unique(PopPUNK_clusters$Cluster))))
value <- c(PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2),PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3))
data_points_df <- data.frame(cluster,cluster_iter,time,value)

 
# Grouped
library(ggplot2)
ggplot(data_points_df, aes(fill=time, y=value, x=cluster_iter)) + 
    geom_bar(position="dodge", stat="identity")



test <- data_points_df[1:10, "X2"]
barplot(test)
barplot(data_points_df[,2], beside = TRUE)



plot(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), type = "l", ylim=c(0,1))
points(simMeanggCPP3/sum(simMeanggCPP3), col = local_cols[1], pch = 4)
points(x[,1,72]/sum(x[,1,73]), col = local_cols[2])
points(x[,2,72]/sum(x[,2,73]), col = local_cols[3])
points(x[,3,72]/sum(x[,3,73]), col = local_cols[4])
points(x[,4,72]/sum(x[,4,73]), col = local_cols[5])
points(x[,5,73]/sum(x[,5,73]), col = local_cols[6])
points(x[,6,73]/sum(x[,6,73]), col = local_cols[7])
points(x[,7,73]/sum(x[,7,73]), col = local_cols[8])
points(x[,8,73]/sum(x[,8,73]), col = local_cols[9])
points(x[,9,73]/sum(x[,9,73]), col = local_cols[10])
points(x[,10,73]/sum(x[,10,73]), col = local_cols[11])
```

### Navajo fit

```{r}
WF_model <- odin.dust::odin_dust("NFDS_Model.R")
seq_clusters <- readRDS("Navajo_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "Navajo_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "Navajo_model_start_pop.rds")
  delta_ranking <- readRDS(file = "Navajo_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "Navajo_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "Navajo_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "Navajo_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "Navajo_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "Navajo_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "Navajo_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "Navajo_cluster_freqs_7.rds")
  mass_cluster_freq_8 <- readRDS(file = "Navajo_cluster_freqs_8.rds")
  mass_cluster_freq_9 <- readRDS(file = "Navajo_cluster_freqs_9.rds")
  mass_cluster_freq_10 <- readRDS(file = "Navajo_cluster_freqs_10.rds")
  mass_cluster_freq_11 <- readRDS(file = "Navajo_cluster_freqs_11.rds")
  mass_cluster_freq_12 <- readRDS(file = "Navajo_cluster_freqs_12.rds")
  mass_cluster_freq_13 <- readRDS(file = "Navajo_cluster_freqs_13.rds")
  mass_cluster_freq_14 <- readRDS(file = "Navajo_cluster_freqs_14.rds")
  mass_cluster_freq_15 <- readRDS(file = "Navajo_cluster_freqs_15.rds")
  mass_VT <- readRDS(file = "Navajo_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "Navajo_ggCaller_PopPUNK"
  
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:14, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7, mass_cluster_freq_8, mass_cluster_freq_9,mass_cluster_freq_10, mass_cluster_freq_11, mass_cluster_freq_12, mass_cluster_freq_13,mass_cluster_freq_14,mass_cluster_freq_15))
  
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  
  vacc_time <- 5
  
  
# compute serotype composition of PP clusters
Navajo_PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  Navajo_PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}
```

```{r}
# deterministic fit from July 17: -2.0986254  0.2779427 -2.6195911  0.2701895 
# deterministic fit from July 16 (only on local machine): sigma_f = -2.0589658, prop_f = 0.2793454, sigma_w =-1000, m = -2.6405403, v = 0.2697361
# deterministic fit from July 23: -2.1088261  0.2794157 -2.6403792  0.3132826 
# deterministic fit from July 23, with vaccTime=2: -2.1082122  0.2792276 -2.6361788  0.3067672 
# deterministic fit from July 24, with vaccTime=2 and 6A in PCV7: -2.2767165  0.2876572 -2.6442156  0.4553816

ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double( model_start_pop), Pop_eq = as.double( model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.2767165, prop_f = 0.2876572, sigma_w =-1000 , delta = delta_ranking, m = -2.6442156, migVec =  avg_cluster_freq, vaccTypes =  mass_VT, v = 0.4553816 , vacc_time = 2)
WFmodel <- WF_model$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP10_Navajo <- rowMeans(WFmodel$run(108)[-1,])

simMeanggCPP13_Navajo <- rowMeans(WFmodel$run(144)[-1,])
simMeanggCPP14_Navajo <- rowMeans(WFmodel$run(156)[-1,])
simMeanggCPP15_Navajo <- rowMeans(WFmodel$run(168)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_10/sum(mass_cluster_freq_10), model_name_1 ="Model", model1 = simMeanggCPP10_Navajo/sum(simMeanggCPP10_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_13/sum(mass_cluster_freq_13), model_name_1 ="Model", model1 = simMeanggCPP13_Navajo/sum(simMeanggCPP13_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="Model", model1 = simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 15", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_15/sum(mass_cluster_freq_15), model_name_1 ="Model", model1 = simMeanggCPP15_Navajo/sum(simMeanggCPP15_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)
# this is not very meaningful because it is just 28 data points

lollipop_cluster_freqs_VTandNVT_labelSero(year = "data tp 13 vs 14", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_13/sum(mass_cluster_freq_13), model_name_1 ="tp 14", model1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "data tp 14 vs 15", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="tp 15", model1 = mass_cluster_freq_15/sum(mass_cluster_freq_15), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 = model_start_pop/sum(model_start_pop), model_name_1 ="Model", model1 = simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="tp 1", model1 =  mass_cluster_freq_14/sum(mass_cluster_freq_14), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "Data change vs Model change", plot_title = "PopPUNK and ggCaller", data_name = "data tp 1", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="data tp 14", model1 =  mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_2 ="model tp 14", model2 =  simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

#lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 =mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP5_Navajo/sum(simMeanggCPP5_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_shaded(year = "tp 13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_13/sum(mass_cluster_freq_13), model_name_1 ="Model", model1 = simMeanggCPP13_Navajo/sum(simMeanggCPP13_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

```

```{r}
Navajo_data_df <- data.frame(matrix(c(mass_cluster_freq_1/sum(mass_cluster_freq_1), mass_cluster_freq_2/sum(mass_cluster_freq_2), mass_cluster_freq_3/sum(mass_cluster_freq_3), mass_cluster_freq_9/sum(mass_cluster_freq_9), mass_cluster_freq_10/sum(mass_cluster_freq_10), mass_cluster_freq_13/sum(mass_cluster_freq_13), mass_cluster_freq_14/sum(mass_cluster_freq_14)), ncol = 1))
Navajo_data_df$strain <- rep(1:length(mass_cluster_freq_1),7)
Navajo_data_df$year <- sort(rep(c("1998","1999","2000","2006","2007","2010","2011"),length(mass_cluster_freq_1)))
colnames(Navajo_data_df)[1] <- "value"

library("viridis") 
ggplot(Navajo_data_df, aes(fill=year, y=value, x=strain)) + 
    geom_bar(position="dodge", stat="identity") +
  scale_fill_viridis(discrete = TRUE)
```

```{r}
# 4 param fit
Navajo_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_17/Navajo_fit/Navajo_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_4param_fit_mcmc <- coda::as.mcmc(cbind(Navajo_4param_fit$probabilities, Navajo_4param_fit$pars))
coda::effectiveSize(Navajo_4param_fit_mcmc)
summary(coda::as.mcmc(Navajo_4param_fit_mcmc))

# 5 param fit
Navajo_5param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_17/Navajo_5paramfit/Navajo_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_5param_fit_mcmc <- coda::as.mcmc(cbind(Navajo_5param_fit$probabilities, Navajo_5param_fit$pars))

coda::effectiveSize(Navajo_5param_fit_mcmc)
summary(coda::as.mcmc(Navajo_5param_fit_mcmc))


# 4 param fit with vaccTime=2
Navajo_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_23/Navajo_VaccTime2/Navajo_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_4param_fit_mcmc <- coda::as.mcmc(cbind(Navajo_4param_fit$probabilities, Navajo_4param_fit$pars))
coda::effectiveSize(Navajo_4param_fit_mcmc)
summary(coda::as.mcmc(Navajo_4param_fit_mcmc))

# 4 param fit with vacc2 (pcv7 and pcv13 seperately)
Navajo_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_23/Navajo_vacc2/Navajo_ggCaller_PopPUNK2vacc_det_pmcmc_run2.rds")
Navajo_4param_fit_mcmc <- coda::as.mcmc(cbind(Navajo_4param_fit$probabilities, Navajo_4param_fit$pars))
coda::effectiveSize(Navajo_4param_fit_mcmc)
summary(coda::as.mcmc(Navajo_4param_fit_mcmc))

# 4 param fit with vaccTime=2 with 6A in PCV7
Navajo_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_24/Navajo_newPCV7/Navajo_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_4param_fit_mcmc <- coda::as.mcmc(cbind(Navajo_4param_fit$probabilities, Navajo_4param_fit$pars))
coda::effectiveSize(Navajo_4param_fit_mcmc)
summary(coda::as.mcmc(Navajo_4param_fit_mcmc))

# 4 param fit with vacc2 (pcv7 and pcv13 separately) with 6A in PCV7
Navajo_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_24/Navajo_newPCV7_2vacc/Navajo_ggCaller_PopPUNK2vacc_det_pmcmc_run2.rds")
Navajo_4param_fit_mcmc <- coda::as.mcmc(cbind(Navajo_4param_fit$probabilities, Navajo_4param_fit$pars))
coda::effectiveSize(Navajo_4param_fit_mcmc)
summary(coda::as.mcmc(Navajo_4param_fit_mcmc))

pairs(Navajo_4param_fit$pars)

## ggplot version
library(ggplot2)
library(GGally)
ggpairs(Navajo_4param_fit$pars, title = "Navajo", upper = list(continuous = wrap("cor", size = 7)))
```

```{r}
# new deterministic fit from July 24 2vacc: -2.5483028  0.2767303 -2.9747911  0.1604086  
# that includes 6A in PCV7

mass_VT1 <- readRDS(file = "Navajo_VT.rds")
mass_VT2 <- readRDS(file = "Navajo_VT2.rds")

ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double( model_start_pop), Pop_eq = as.double( model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.5483028, prop_f = 0.2767303, sigma_w =-1000 , delta = delta_ranking, m = -2.9747911, migVec =  avg_cluster_freq, vaccTypes1 =  mass_VT1, vaccTypes2 =  mass_VT2, v = 0.1604086 , vacc_time1 = 2, vacc_time2 = 12)
WF_model <- odin.dust::odin_dust("NFDS_Model_2vacc.R")
WFmodel <- WF_model$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP1_Navajo <- rowMeans(WFmodel$run(0)[-1,])

simMeanggCPP10_Navajo <- rowMeans(WFmodel$run(108)[-1,])
simMeanggCPP13_Navajo <- rowMeans(WFmodel$run(144)[-1,])
simMeanggCPP14_Navajo <- rowMeans(WFmodel$run(156)[-1,])
simMeanggCPP15_Navajo <- rowMeans(WFmodel$run(168)[-1,])


lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_10/sum(mass_cluster_freq_10), model_name_1 ="Model", model1 = simMeanggCPP10_Navajo/sum(simMeanggCPP10_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_13/sum(mass_cluster_freq_13), model_name_1 ="Model", model1 = simMeanggCPP13_Navajo/sum(simMeanggCPP13_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="Model", model1 = simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)
```

```{r}
# plot correlation of cluster size and error
data_order <- order(mass_cluster_freq_14)
data_vals <- (mass_cluster_freq_14/sum(mass_cluster_freq_14))[data_order]
model_vals <- (simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo))[data_order]
error_vals <- abs(data_vals - model_vals)
sq_error_vals <- (data_vals - model_vals)**2
scaled_error_vals <- abs(data_vals[which(data_vals!=0)] - model_vals[which(data_vals!=0)])/(data_vals[which(data_vals!=0)])

model <- lm(error_vals ~ mass_cluster_freq_14[order(mass_cluster_freq_14)])
summary(model)


plot(mass_cluster_freq_14[order(mass_cluster_freq_14)],error_vals, ylab = "absolute error", xlab = "Cluster size (data)", main = "Absolute error model vs. data for Navajo, tp 14")
abline(lm(error_vals ~ mass_cluster_freq_14[order(mass_cluster_freq_14)]), col = "red")


model_sqr <- lm(sq_error_vals ~ mass_cluster_freq_14[order(mass_cluster_freq_14)])
summary(model_sqr)

plot(mass_cluster_freq_14[order(mass_cluster_freq_14)],sq_error_vals, ylab = "squared error", xlab = "Cluster size (data)", main = "Squared error model vs. data for Navajo, tp 14")
abline(lm(sq_error_vals ~ mass_cluster_freq_14[order(mass_cluster_freq_14)]), col = "red")

model_scaled <- lm(scaled_error_vals ~ (mass_cluster_freq_14[order(mass_cluster_freq_14)])[which(data_vals!=0)])
summary(model_scaled)

plot((mass_cluster_freq_14[order(mass_cluster_freq_14)])[which(data_vals!=0)],scaled_error_vals, ylab = "absolute error/cluster size", xlab = "Cluster size (data)", main = "Relative absolute error model vs. data for Navajo, tp 14")
abline(lm(scaled_error_vals ~ mass_cluster_freq_14[order(mass_cluster_freq_14)][which(data_vals!=0)]), col = "red")
```

```{r}
# 4 param fit
# Mass
Mass_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_16/Mass_fit/4param_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Mass_4param_fit_mcmc <- coda::as.mcmc(cbind(Mass_4param_fit$probabilities, Mass_4param_fit$pars))
coda::effectiveSize(Mass_4param_fit_mcmc)
summary(coda::as.mcmc(Mass_4param_fit_mcmc))
plot(Mass_4param_fit_mcmc)

# 5 param fit
Mass_5param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_17/Mass_5paramfit/Mass_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Mass_5param_fit_mcmc <- coda::as.mcmc(cbind(Mass_5param_fit$probabilities, Mass_5param_fit$pars))

coda::effectiveSize(Mass_5param_fit_mcmc)
summary(coda::as.mcmc(Mass_5param_fit_mcmc))
```

```{r}
# 5 param fit: -2.50384352 -476.25811203    0.27730687   -2.95914643    0.08597233 
ggCPP_params <- list(dt = 1/36, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double( model_start_pop), Pop_eq = as.double( model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.50384352, prop_f = 0.27730687, sigma_w =-476.25811203, delta = delta_ranking, m = -2.95914643, migVec =  avg_cluster_freq, vaccTypes =  mass_VT, v = 0.08597233  , vacc_time = 0)
WFmodel <- WF_model$new(pars = ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP10_Navajo_5p <- rowMeans(WFmodel$run(109)[-1,])

simMeanggCPP13_Navajo_5p <- rowMeans(WFmodel$run(145)[-1,])
simMeanggCPP14_Navajo_5p <- rowMeans(WFmodel$run(157)[-1,])
simMeanggCPP15_Navajo_5p <- rowMeans(WFmodel$run(169)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_10/sum(mass_cluster_freq_10), model_name_1 ="Model", model1 = simMeanggCPP10_Navajo_5p/sum(simMeanggCPP10_Navajo_5p), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_13/sum(mass_cluster_freq_13), model_name_1 ="Model", model1 = simMeanggCPP13_Navajo_5p/sum(simMeanggCPP13_Navajo_5p), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="Model", model1 = simMeanggCPP14_Navajo_5p/sum(simMeanggCPP14_Navajo_5p), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)


lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "Data change vs Model change", plot_title = "PopPUNK and ggCaller", data_name = "data tp 14", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="model 4 param", model1 =  simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo), model_name_2 ="model 5 param", model2 =  simMeanggCPP14_Navajo_5p/sum(simMeanggCPP14_Navajo_5p), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)
```

# UK
```{r}
# 4 param fit
UK_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_23/UK/UK_ggCaller_PopPUNK_det_pmcmc_run2.rds")
UK_4param_fit_mcmc <- coda::as.mcmc(cbind(UK_4param_fit$probabilities, UK_4param_fit$pars))
coda::effectiveSize(UK_4param_fit_mcmc)
summary(coda::as.mcmc(UK_4param_fit_mcmc))

# 4 param fit with two vaccines
UK_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_23/UK_vacc2/UK_ggCaller_PopPUNK2vacc_det_pmcmc_run2.rds")
UK_4param_fit_mcmc <- coda::as.mcmc(cbind(UK_4param_fit$probabilities, UK_4param_fit$pars))
coda::effectiveSize(UK_4param_fit_mcmc)
summary(coda::as.mcmc(UK_4param_fit_mcmc))

# 4 param fit with 6A in PCV7
UK_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_24/UK_newPCV7/UK_ggCaller_PopPUNK_det_pmcmc_run2.rds")
UK_4param_fit_mcmc <- coda::as.mcmc(cbind(UK_4param_fit$probabilities, UK_4param_fit$pars))
coda::effectiveSize(UK_4param_fit_mcmc)
summary(coda::as.mcmc(UK_4param_fit_mcmc))

# 4 param fit with two vaccines with 6A in PCV7
UK_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_24/UK_newPCV7_2vacc/UK_ggCaller_PopPUNK2vacc_det_pmcmc_run2.rds")
UK_4param_fit_mcmc <- coda::as.mcmc(cbind(UK_4param_fit$probabilities, UK_4param_fit$pars))
coda::effectiveSize(UK_4param_fit_mcmc)
summary(coda::as.mcmc(UK_4param_fit_mcmc))

pairs(UK_4param_fit$pars)

ggpairs(UK_4param_fit$pars, title = "Southampton", upper = list(continuous = wrap("cor", size = 7)))
```

```{r}
seq_clusters <- readRDS("UK_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "UK_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "UK_model_start_pop.rds")
  delta_ranking <- readRDS(file = "UK_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "UK_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "UK_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "UK_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "UK_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "UK_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "UK_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "UK_cluster_freqs_7.rds")
  mass_VT <- readRDS(file = "UK_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "UK_ggCaller_PopPUNK"
  
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:6, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7))
  
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  
  vacc_time <- 0
# compute serotype composition of PP clusters
UK_PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  UK_PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}
```

```{r}
# deterministic fit from July 23: -1.4405979  0.1000423 -3.9348562  0.1414027 
# new deterministic fit from July 24 with 6A in PCV7: -2.2864083  0.1005419 -4.0242875  0.1131342 
mass_VT <- readRDS(file = "UK_VT.rds")

ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double( model_start_pop), Pop_eq = as.double( model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.2864083, prop_f = 0.1005419, sigma_w =-1000 , delta = delta_ranking, m = -4.0242875, migVec =  avg_cluster_freq, vaccTypes =  mass_VT, v = 0.1131342 , vacc_time = 0)
WF_model <- odin.dust::odin_dust("NFDS_Model.R")
WFmodel <- WF_model$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP1_UK <- rowMeans(WFmodel$run(0)[-1,])

simMeanggCPP4_UK <- rowMeans(WFmodel$run(36)[-1,])
simMeanggCPP5_UK <- rowMeans(WFmodel$run(48)[-1,])
simMeanggCPP6_UK <- rowMeans(WFmodel$run(60)[-1,])
simMeanggCPP7_UK <- rowMeans(WFmodel$run(72)[-1,])


lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), model_name_1 ="Model", model1 = simMeanggCPP7_UK/sum(simMeanggCPP7_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_6/sum(mass_cluster_freq_6), model_name_1 ="Model", model1 = simMeanggCPP6_UK/sum(simMeanggCPP6_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2009/10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_4/sum(mass_cluster_freq_4), model_name_1 ="Model", model1 = simMeanggCPP4_UK/sum(simMeanggCPP4_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_shaded(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), model_name_1 ="Model", model1 = simMeanggCPP7_UK/sum(simMeanggCPP7_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)
```

```{r}
# deterministic fit from July 23 2vacc: -1.93371832  0.09901734 -4.00039067  0.12526164 
mass_VT_no6A <- readRDS(file = "UK_VT_no6A.rds")

# new deterministic fit from July 24 2vacc: -2.4253023  0.1009613 -3.9979980  0.1056966 
# that includes 6A in PCV7

mass_VT1 <- readRDS(file = "UK_VT.rds")
mass_VT2 <- readRDS(file = "UK_VT2.rds")

ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double( model_start_pop), Pop_eq = as.double( model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.4253023, prop_f = 0.1009613, sigma_w =-1000 , delta = delta_ranking, m = -3.9979980, migVec =  avg_cluster_freq, vaccTypes1 =  mass_VT1, vaccTypes2 =  mass_VT2, v = 0.1056966 , vacc_time1 = 0, vacc_time2 = 4)
WF_model <- odin.dust::odin_dust("NFDS_Model_2vacc.R")
WFmodel <- WF_model$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP1_UK <- rowMeans(WFmodel$run(0)[-1,])

simMeanggCPP4_UK <- rowMeans(WFmodel$run(36)[-1,])
simMeanggCPP5_UK <- rowMeans(WFmodel$run(48)[-1,])
simMeanggCPP6_UK <- rowMeans(WFmodel$run(60)[-1,])
simMeanggCPP7_UK <- rowMeans(WFmodel$run(72)[-1,])


lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), model_name_1 ="Model", model1 = simMeanggCPP7_UK/sum(simMeanggCPP7_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_6/sum(mass_cluster_freq_6), model_name_1 ="Model", model1 = simMeanggCPP6_UK/sum(simMeanggCPP6_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2009/10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_4/sum(mass_cluster_freq_4), model_name_1 ="Model", model1 = simMeanggCPP4_UK/sum(simMeanggCPP4_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Data 2006 vs 2012", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Data 2012", model1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)
```

```{r}
# plot correlation of cluster size and error
data_order <- order(mass_cluster_freq_7)
data_vals <- (mass_cluster_freq_7/sum(mass_cluster_freq_7))[data_order]
model_vals <- (simMeanggCPP7_UK/sum(simMeanggCPP7_UK))[data_order]
error_vals <- abs(data_vals - model_vals)
sq_error_vals <- (data_vals - model_vals)**2
plot(mass_cluster_freq_7[order(mass_cluster_freq_7)],error_vals, ylab = "absolute error", xlab = "Cluster size (data)", main = "Absolute error model vs. data for Southampton, 2012/13")
plot(mass_cluster_freq_7[order(mass_cluster_freq_7)],sq_error_vals, ylab = "absolute error", xlab = "Cluster size (data)", main = "Absolute error model vs. data for Southampton, 2012/13")

model <- lm(error_vals ~ mass_cluster_freq_7[order(mass_cluster_freq_7)])
summary(model)

plot(mass_cluster_freq_7[order(mass_cluster_freq_7)],error_vals, ylab = "absolute error", xlab = "Cluster size (data)", main = "Absolute error model vs. data for Southampton, 2012/13")
abline(lm(error_vals ~ mass_cluster_freq_7[order(mass_cluster_freq_7)]), col = "red")


model_sqr <- lm(sq_error_vals ~ mass_cluster_freq_7[order(mass_cluster_freq_7)])
summary(model_sqr)

plot(mass_cluster_freq_7[order(mass_cluster_freq_7)],sq_error_vals, ylab = "squared error", xlab = "Cluster size (data)", main = "Squared error model vs. data for Southampton, 2012/13")
abline(lm(sq_error_vals ~ mass_cluster_freq_7[order(mass_cluster_freq_7)]), col = "red")
```


# new version of VT-divers model
```{r}
read_VT_data_and_lollipop <- function(loc, pars_from_mcmc){
  if(loc == "Mass"){
    seq_clusters <- readRDS("PopPUNK_clusters.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
  delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
  #delta_ranking <- readRDS(file = "ggC_delta_ranking3.rds")
  mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
  #mass_VT <- readRDS(file = "PP_mass_VT_mean.rds")
  mass_VT <- readRDS(file = "PP_mass_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "4param_ggCaller_PopPUNK"
  # process data with particle filter:
  dt <- 1/36 # we assume that the generation time of Strep. pneumo is 1 month
  # we have data from 2001, 2004, 2007, so we want 3 (years) * 12 (months) = 36 updates in-between
  ceil_mass_NVT <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    ceil_mass_NVT[i] <- ceiling(mean(as.integer(seq_clusters[seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT"]=="NVT")))
  }
  #ceil_mass_NVT[is.nan(ceil_mass_NVT)] <- 0
  mean_mass_VT_2001 <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    mean_mass_VT_2001[i] <- (mean(as.integer(seq_clusters[seq_clusters$SeqYear == 2001 & seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT"]=="VT")))
  }
  mean_mass_VT_2001[is.nan(mean_mass_VT_2001)] <- 0
  
  NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT)
  VT_mig <- rep(1/mass_clusters, mass_clusters) * (1-ceil_mass_NVT)
  avg_cluster_freq <- as.matrix(cbind(NVT_mig,VT_mig))
  model_start_pop <- matrix(as.double(c(model_start_pop * (1-mean_mass_VT_2001),model_start_pop * mean_mass_VT_2001)), byrow = FALSE, nrow = mass_clusters, ncol = 2)
  output_filename <- "VT_ggCaller_PopPUNK"
  peripost_mass_cluster_freq <- data.frame("year" = c(1, 2), rbind(mass_cluster_freq_2, mass_cluster_freq_3))
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  vacc_time <- 0
  
  PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}

  
  ggCPP_params <- list(dt = 1/36, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = pars_from_mcmc[1], prop_f = pars_from_mcmc[2], sigma_w =-1000 , delta = delta_ranking, m = pars_from_mcmc[3], migVec =  as.matrix(avg_cluster_freq), v = pars_from_mcmc[4] , vT = c(0,1), vacc_time = 0)
WF <- odin.dust::odin_dust("NFDS_Model_VT.R")
WFmodel <- WF$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

VT_divers_0 <- rowMeans(WFmodel$run(0)[-1,])[1:mass_clusters]

VT_divers_36 <- rowMeans(WFmodel$run(36)[-1,])[1:mass_clusters]
VT_divers_72 <- rowMeans(WFmodel$run(48)[-1,])[1:mass_clusters]


lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = VT_divers_0/sum(VT_divers_0), VT_vec = mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = VT_divers_36/sum(VT_divers_36), VT_vec = mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = VT_divers_72/sum(VT_divers_72),  VT_vec = mass_VT, SeroLabel = PP_serotype_comp)
  }
  if(loc == "UK"){
    seq_clusters <- readRDS("UK_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "UK_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "UK_model_start_pop.rds")
  delta_ranking <- readRDS(file = "UK_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "UK_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "UK_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "UK_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "UK_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "UK_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "UK_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "UK_cluster_freqs_7.rds")
  mass_VT <- readRDS(file = "UK_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "UK_VT_ggCaller_PopPUNK"
  
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:6, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7))
  
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  
  vacc_time <- 0
  ceil_mass_NVT <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    ceil_mass_NVT[i] <- ceiling(mean(as.integer(seq_clusters[seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT_PCV7"]=="NVT")))
  }
  #ceil_mass_NVT[is.nan(ceil_mass_NVT)] <- 0
  mean_mass_VT_2001 <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    mean_mass_VT_2001[i] <- (mean(as.integer(seq_clusters[seq_clusters$Time == 2006 & seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT_PCV7"]=="VT")))
  }
  mean_mass_VT_2001[is.nan(mean_mass_VT_2001)] <- 0
  
  NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT)
  VT_mig <- rep(1/mass_clusters, mass_clusters) * (1-ceil_mass_NVT)
  avg_cluster_freq <- data.frame(as.matrix(cbind(NVT_mig,VT_mig)))
  model_start_pop <- matrix(as.double(c(model_start_pop * (1-mean_mass_VT_2001),model_start_pop * mean_mass_VT_2001)), byrow = FALSE, nrow = mass_clusters, ncol = 2)
  
  UK_PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  UK_PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}
  
  ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = pars_from_mcmc[1], prop_f = pars_from_mcmc[2], sigma_w =-1000 , delta = delta_ranking, m = pars_from_mcmc[3], migVec =  as.matrix(avg_cluster_freq), v = pars_from_mcmc[4] , vT = c(0,1), vacc_time = 0)
  
WF <- odin.dust::odin_dust("NFDS_Model_VT.R")
WFmodel <- WF$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

#simMeanggCPP1_UK <- rowMeans(WFmodel$run(0)[-1,])[1:mass_clusters]

simMeanggCPP4_UK <- rowMeans(WFmodel$run(36)[-1,])[1:mass_clusters]
simMeanggCPP5_UK <- rowMeans(WFmodel$run(48)[-1,])[1:mass_clusters]
simMeanggCPP6_UK <- rowMeans(WFmodel$run(60)[-1,])[1:mass_clusters]
simMeanggCPP7_UK <- rowMeans(WFmodel$run(72)[-1,])[1:mass_clusters]


lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), model_name_1 ="Model", model1 = simMeanggCPP7_UK/sum(simMeanggCPP7_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_6/sum(mass_cluster_freq_6), model_name_1 ="Model", model1 = simMeanggCPP6_UK/sum(simMeanggCPP6_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2009/10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_4/sum(mass_cluster_freq_4), model_name_1 ="Model", model1 = simMeanggCPP4_UK/sum(simMeanggCPP4_UK), VT_vec = mass_VT, SeroLabel = UK_PP_serotype_comp)
  
  }
  if(loc == "Navajo"){
    seq_clusters <- readRDS("Navajo_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "Navajo_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "Navajo_model_start_pop.rds")
  delta_ranking <- readRDS(file = "Navajo_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "Navajo_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "Navajo_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "Navajo_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "Navajo_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "Navajo_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "Navajo_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "Navajo_cluster_freqs_7.rds")
  mass_cluster_freq_8 <- readRDS(file = "Navajo_cluster_freqs_8.rds")
  mass_cluster_freq_9 <- readRDS(file = "Navajo_cluster_freqs_9.rds")
  mass_cluster_freq_10 <- readRDS(file = "Navajo_cluster_freqs_10.rds")
  mass_cluster_freq_11 <- readRDS(file = "Navajo_cluster_freqs_11.rds")
  mass_cluster_freq_12 <- readRDS(file = "Navajo_cluster_freqs_12.rds")
  mass_cluster_freq_13 <- readRDS(file = "Navajo_cluster_freqs_13.rds")
  mass_cluster_freq_14 <- readRDS(file = "Navajo_cluster_freqs_14.rds")
  mass_cluster_freq_15 <- readRDS(file = "Navajo_cluster_freqs_15.rds")
  mass_VT <- readRDS(file = "Navajo_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "Navajo_VT_ggCaller_PopPUNK"
  
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:14, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7, mass_cluster_freq_8, mass_cluster_freq_9,mass_cluster_freq_10, mass_cluster_freq_11, mass_cluster_freq_12, mass_cluster_freq_13,mass_cluster_freq_14,mass_cluster_freq_15))
  
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  
  vacc_time <- 2 # trying vacc time =2 instead of 5 as before
  
  ceil_mass_NVT <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    ceil_mass_NVT[i] <- ceiling(mean(as.integer(seq_clusters[seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT"]=="NVT")))
  }
  #ceil_mass_NVT[is.nan(ceil_mass_NVT)] <- 0
  mean_mass_VT_start <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    mean_mass_VT_start[i] <- (mean(as.integer(seq_clusters[seq_clusters$SeqYear == 1999 & seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT"]=="VT")))
  }
  mean_mass_VT_start[is.nan(mean_mass_VT_start)] <- 0
  
  NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT)
  VT_mig <- rep(1/mass_clusters, mass_clusters) * (1-ceil_mass_NVT)
  avg_cluster_freq <- data.frame(as.matrix(cbind(NVT_mig,VT_mig)))
  model_start_pop <- matrix(as.double(c(model_start_pop * (1-mean_mass_VT_start),model_start_pop * mean_mass_VT_start)), byrow = FALSE, nrow = mass_clusters, ncol = 2)
  ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = pars_from_mcmc[1], prop_f = pars_from_mcmc[2], sigma_w =-1000 , delta = delta_ranking, m = pars_from_mcmc[3], migVec =  as.matrix(avg_cluster_freq), v = pars_from_mcmc[4] , vT = c(0,1), vacc_time = 0)
   
   Navajo_PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  Navajo_PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}
WF <- odin.dust::odin_dust("NFDS_Model_VT.R")
WFmodel <- WF$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  
  
simMeanggCPP10_Navajo <- rowMeans(WFmodel$run(108)[-1,])[1:mass_clusters]

simMeanggCPP13_Navajo <- rowMeans(WFmodel$run(144)[-1,])[1:mass_clusters]
simMeanggCPP14_Navajo <- rowMeans(WFmodel$run(156)[-1,])[1:mass_clusters]
simMeanggCPP15_Navajo <- rowMeans(WFmodel$run(168)[-1,])[1:mass_clusters]

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_10/sum(mass_cluster_freq_10), model_name_1 ="Model", model1 = simMeanggCPP10_Navajo/sum(simMeanggCPP10_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_13/sum(mass_cluster_freq_13), model_name_1 ="Model", model1 = simMeanggCPP13_Navajo/sum(simMeanggCPP13_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="Model", model1 = simMeanggCPP14_Navajo/sum(simMeanggCPP14_Navajo), VT_vec = mass_VT, SeroLabel = Navajo_PP_serotype_comp)
}
}

```

```{r}
# VT-divers fit from 08.08.2024 for Mass: 
Mass_VT <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_08/VT_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Mass_VT_mcmc <- coda::as.mcmc(cbind(Mass_VT$probabilities, Mass_VT$pars))
coda::effectiveSize(Mass_VT_mcmc)
summary(coda::as.mcmc(Mass_VT_mcmc))
plot(Mass_VT_mcmc)

## ggplot pairs plot
library(ggplot2)
library(GGally)
ggpairs(Mass_VT$pars, title = "Mass", upper = list(continuous = wrap("cor", size = 7)))

# try to find maximum a posteriori estimate (map)
#install.packages("bayestestR")
library(bayestestR)
map_estimate(Mass_VT$pars[, 1:4])

# VT-divers fit from 08.08.2024 for Mass: -1.19 0.24 -3.80 0.16

# Mass
pars_from_mcmc <- map_estimate(Mass_VT$pars[, 1:4])$MAP_Estimate
read_VT_data_and_lollipop("Mass", pars_from_mcmc)

```

```{r}
### UK 
UK_VT <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_09/UK/UK_VT_ggCaller_PopPUNK_det_pmcmc_run2.rds")
UK_VT_mcmc <- coda::as.mcmc(cbind(UK_VT$probabilities, UK_VT$pars))
coda::effectiveSize(UK_VT_mcmc)
summary(coda::as.mcmc(UK_VT_mcmc))
plot(UK_VT_mcmc)

pars_from_mcmc_UK <- map_estimate(UK_VT$pars[, 1:4])$MAP_Estimate
# -2.00106249  0.09769008 -4.01855736  0.12837577
read_VT_data_and_lollipop("UK", pars_from_mcmc_UK)
```

```{r}
### UK 
UK_VT <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_14/UK_VT_2vacc/UK_VT_ggCaller_PopPUNK_det_pmcmc_run2.rds")
UK_VT_mcmc <- coda::as.mcmc(cbind(UK_VT$probabilities, UK_VT$pars))
coda::effectiveSize(UK_VT_mcmc)
summary(coda::as.mcmc(UK_VT_mcmc))
plot(UK_VT_mcmc)

pars_from_mcmc_UK <- map_estimate(UK_VT$pars[, 1:4])$MAP_Estimate
# -2.00106249  0.09769008 -4.01855736  0.12837577
read_VT_data_and_lollipop("UK", pars_from_mcmc_UK)
```

```{r}
### Navajo 
Navajo_VT <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_09/Navajo/Navajo_VT_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_VT_mcmc <- coda::as.mcmc(cbind(Navajo_VT$probabilities, Navajo_VT$pars))
coda::effectiveSize(Navajo_VT_mcmc)
summary(coda::as.mcmc(Navajo_VT_mcmc))
plot(Navajo_VT_mcmc)

pars_from_mcmc_Navajo <- map_estimate(Navajo_VT$pars[, 1:4])$MAP_Estimate
# -2.8889963  0.2623231 -3.2392050  0.2270977

# mean from same run: -2.7741 0.2691 -3.1262 0.3377
pars_from_mcmc_Navajo <- c(-2.7741, 0.2691, -3.1262, 0.3377)
read_VT_data_and_lollipop("Navajo", pars_from_mcmc_Navajo)

# with 6A in PCV7
Navajo_VT <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_14/Navajo_VT_1vacc_with6A/Navajo_VT_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_VT_mcmc <- coda::as.mcmc(cbind(Navajo_VT$probabilities, Navajo_VT$pars))
coda::effectiveSize(Navajo_VT_mcmc)
summary(coda::as.mcmc(Navajo_VT_mcmc))
plot(Navajo_VT_mcmc)

pars_from_mcmc_Navajo <- map_estimate(Navajo_VT$pars[, 1:4])$MAP_Estimate
# -2.2101835  0.2800375 -2.6085131  0.4725749

# mean from same run: -2.7741 0.2691 -3.1262 0.3377
#pars_from_mcmc_Navajo <- c(-2.7741, 0.2691, -3.1262, 0.3377)
read_VT_data_and_lollipop("Navajo", pars_from_mcmc_Navajo)


```

```{r}
# compare this VT divers run with normal run
# because the likelihood is much better but the lollipop looks basically the same.
seq_clusters <- readRDS("Navajo_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "Navajo_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "Navajo_model_start_pop.rds")
  delta_ranking <- readRDS(file = "Navajo_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "Navajo_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "Navajo_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "Navajo_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "Navajo_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "Navajo_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "Navajo_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "Navajo_cluster_freqs_7.rds")
  mass_cluster_freq_8 <- readRDS(file = "Navajo_cluster_freqs_8.rds")
  mass_cluster_freq_9 <- readRDS(file = "Navajo_cluster_freqs_9.rds")
  mass_cluster_freq_10 <- readRDS(file = "Navajo_cluster_freqs_10.rds")
  mass_cluster_freq_11 <- readRDS(file = "Navajo_cluster_freqs_11.rds")
  mass_cluster_freq_12 <- readRDS(file = "Navajo_cluster_freqs_12.rds")
  mass_cluster_freq_13 <- readRDS(file = "Navajo_cluster_freqs_13.rds")
  mass_cluster_freq_14 <- readRDS(file = "Navajo_cluster_freqs_14.rds")
  mass_cluster_freq_15 <- readRDS(file = "Navajo_cluster_freqs_15.rds")
  mass_VT <- readRDS(file = "Navajo_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "Navajo_VT_ggCaller_PopPUNK"
  
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:14, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7, mass_cluster_freq_8, mass_cluster_freq_9,mass_cluster_freq_10, mass_cluster_freq_11, mass_cluster_freq_12, mass_cluster_freq_13,mass_cluster_freq_14,mass_cluster_freq_15))
  
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  
  vacc_time <- 2 # trying vacc time =2 instead of 5 as before
  
  ceil_mass_NVT <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    ceil_mass_NVT[i] <- ceiling(mean(as.integer(seq_clusters[seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT"]=="NVT")))
  }
  #ceil_mass_NVT[is.nan(ceil_mass_NVT)] <- 0
  mean_mass_VT_start <- rep(0, mass_clusters)
  for (i in 1:mass_clusters){
    mean_mass_VT_start[i] <- (mean(as.integer(seq_clusters[seq_clusters$SeqYear == 1999 & seq_clusters$Cluster == unique(seq_clusters$Cluster)[i],"VT"]=="VT")))
  }
  mean_mass_VT_start[is.nan(mean_mass_VT_start)] <- 0
  
  NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT)
  VT_mig <- rep(1/mass_clusters, mass_clusters) * (1-ceil_mass_NVT)
  avg_cluster_freq <- data.frame(as.matrix(cbind(NVT_mig,VT_mig)))
  model_start_pop <- matrix(as.double(c(model_start_pop * (1-mean_mass_VT_start),model_start_pop * mean_mass_VT_start)), byrow = FALSE, nrow = mass_clusters, ncol = 2)
  ggCPP_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = pars_from_mcmc_Navajo[1], prop_f = pars_from_mcmc_Navajo[2], sigma_w =-1000 , delta = delta_ranking, m = pars_from_mcmc_Navajo[3], migVec =  as.matrix(avg_cluster_freq), v = pars_from_mcmc_Navajo[4] , vT = c(0,1), vacc_time = 0)
   
   Navajo_PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  Navajo_PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}
WF <- odin.dust::odin_dust("NFDS_Model_VT.R")
WFmodel <- WF$new(pars = ggCPP_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  
  
simMeanggCPP10_Navajo <- rowMeans(WFmodel$run(108)[-1,])[1:mass_clusters]

simMeanggCPP13_Navajo <- rowMeans(WFmodel$run(144)[-1,])[1:mass_clusters]
simMeanggCPP14_Navajo <- rowMeans(WFmodel$run(156)[-1,])[1:mass_clusters]
#simMeanggCPP15_Navajo <- rowMeans(WFmodel$run(168)[-1,])[1:mass_clusters]



VT_14 <- simMeanggCPP14_Navajo # computed here
#standard_14_Navajo <- simMeanggCPP14_Navajo # computed in line 4086

# compute serotype composition of PP clusters
Navajo_PP_serotype_comp <- rep(0,mass_clusters)
for (i in 1:mass_clusters) {
  Navajo_PP_serotype_comp[i] <- paste(unique(seq_clusters$Serotype[which(seq_clusters$Cluster==unique(seq_clusters$Cluster)[i])]), collapse = ", ")
}

lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "tp 14", plot_title = "Navajo - Standard vs. VT-divers Model", data_name = "Data", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="VT-divers Model", model1 = VT_14/sum(VT_14), model_name_2 ="Standard Model", model2 = standard_14_Navajo/sum(standard_14_Navajo), mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_relative_ModelComp(year = "tp 14", plot_title = "Navajo - Standard vs. VT-divers Model", data_name = "Data", data1 = mass_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="VT-divers Model", model1 = VT_14/sum(VT_14), model_name_2 ="Standard Model", model2 = standard_14_Navajo/sum(standard_14_Navajo), mass_VT, SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14", plot_title = "Navajo - Standard vs. VT-divers Model", data_name = "Standard Model", data1 = standard_14_Navajo/sum(standard_14_Navajo), model_name_1 ="VT-divers Model", model1 = VT_14/sum(VT_14), mass_VT, SeroLabel = Navajo_PP_serotype_comp)
# I think this one does not make any sense because you do not know where the real value (the data) would be...

# plotting VT and non-VT separately
mass_VT_cluster_freq_14 <- readRDS(file = "Navajo_VT_cluster_freqs_14.rds")
mass_NVT_cluster_freq_14 <- readRDS(file = "Navajo_NVT_cluster_freqs_14.rds")
simMeanggCPP14_Navajo_NVT <- rowMeans(WFmodel$run(156)[-1,])[(mass_clusters +1):(2*mass_clusters)]
simMeanggCPP14_Navajo_VT <- rowMeans(WFmodel$run(156)[-1,])[(2*mass_clusters +1):(3*mass_clusters)]

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14 - VTs", plot_title = "Navajo", data_name = "VT data", data1 = mass_VT_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="VT-divers Model", model1 = simMeanggCPP14_Navajo_VT/sum(VT_14), VT_vec =  rep(1,mass_clusters), SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "tp 14 - NVTs", plot_title = "Navajo", data_name = "VT data", data1 = mass_NVT_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="VT-divers Model", model1 = simMeanggCPP14_Navajo_NVT/sum(VT_14), VT_vec =  rep(0,mass_clusters), SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_relative(year = "tp 14 - VTs", plot_title = "Navajo", data_name = "VT data", data1 = mass_VT_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="VT-divers Model", model1 = simMeanggCPP14_Navajo_VT/sum(VT_14), VT_vec =  rep(1,mass_clusters), SeroLabel = Navajo_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero_relative(year = "tp 14 - NVTs", plot_title = "Navajo", data_name = "VT data", data1 = mass_NVT_cluster_freq_14/sum(mass_cluster_freq_14), model_name_1 ="VT-divers Model", model1 = simMeanggCPP14_Navajo_NVT/sum(VT_14), VT_vec =  rep(0,mass_clusters), SeroLabel = Navajo_PP_serotype_comp)
```

```{r}
### Navajo VT 2vacc
Navajo_VT <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_14/Navajo_VT_2vacc/Navajo_VT_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_VT_mcmc <- coda::as.mcmc(cbind(Navajo_VT$probabilities, Navajo_VT$pars))
coda::effectiveSize(Navajo_VT_mcmc)
summary(coda::as.mcmc(Navajo_VT_mcmc))
plot(Navajo_VT_mcmc)

pars_from_mcmc_Navajo <- map_estimate(Navajo_VT$pars[, 1:4])$MAP_Estimate
# -2.8889963  0.2623231 -3.2392050  0.2270977
read_VT_data_and_lollipop("Navajo", pars_from_mcmc_Navajo)
```

```{r}
# Investigate PPxSero model
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")

  seq_clusters <- readRDS("UK_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "UK_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  mass_clusters <- length(unique(seq_clusters$Cluster))
  delta_ranking <- readRDS(file = "UK_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "UK_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "UK_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "UK_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "UK_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "UK_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "UK_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "UK_cluster_freqs_7.rds")
  mass_VT <- readRDS(file = "UK_SeroVT.rds")
  
  avg_cluster_freq <- readRDS(file = "UK_PPsero_mig.rds")
  output_filename <- "UK_PPxSero_ggCaller_PopPUNK"
  
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:6, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7))
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  vacc_time <- 0
  sero_no = length(unique(seq_clusters$Serotype))
  model_start_pop <- readRDS(file = "UK_PPsero_startpop.rds")
  
# 2nd fit 15.08. (not a great fit): -0.33669781  0.13949168 -2.87094079  0.04126142
PPxSero_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -0.33669781, prop_f = 0.13949168, sigma_w =-1000 , delta = delta_ranking, m = -2.87094079, migVec =  as.matrix(avg_cluster_freq), v = 0.04126142 , vaccTypes = mass_VT, vacc_time = 0, sero_no = sero_no)

WF_PPxSero_model <- WF_PPxSero$new(pars = PPxSero_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP1_UK <- rowMeans(WF_PPxSero_model$run(0)[-1,])[1:mass_clusters]

simMeanggCPP4_UK <- rowMeans(WF_PPxSero_model$run(36)[-1,])[1:mass_clusters]
simMeanggCPP5_UK <- rowMeans(WF_PPxSero_model$run(48)[-1,])[1:mass_clusters]
simMeanggCPP6_UK <- rowMeans(WF_PPxSero_model$run(60)[-1,])[1:mass_clusters]
simMeanggCPP7_UK <- rowMeans(WF_PPxSero_model$run(72)[-1,])[1:mass_clusters]
simMeanggCPP7_UK_all <- rowMeans(WF_PPxSero_model$run(72)[-1,])
simMeanggCPP7_UK_matrix <- matrix(simMeanggCPP7_UK_all, ncol = 42, nrow = 59, byrow = FALSE)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Start", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_UK/sum(simMeanggCPP1_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), model_name_1 ="Model", model1 = simMeanggCPP7_UK/sum(simMeanggCPP7_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_6/sum(mass_cluster_freq_6), model_name_1 ="Model", model1 = simMeanggCPP6_UK/sum(simMeanggCPP6_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2009/10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_4/sum(mass_cluster_freq_4), model_name_1 ="Model", model1 = simMeanggCPP4_UK/sum(simMeanggCPP4_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)



# colSums(simMeanggCPP7_UK_matrix[,-1])
# gives us the serotype numbers (summed over all clusters)

UK_cluster_freq_sero_7 <- readRDS(file = "UK_cluster_freqs_sero_7.rds")
UK_cluster_freq_sero_7_seroCounts <- colSums(UK_cluster_freq_sero_7)

UK_cluster_freq_sero_6 <- readRDS(file = "UK_cluster_freqs_sero_6.rds")

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = UK_cluster_freq_sero_7_seroCounts/sum(UK_cluster_freq_sero_7_seroCounts), model_name_1 ="Model", model1 = colSums(simMeanggCPP7_UK_matrix[,-1])/sum(simMeanggCPP7_UK_matrix[,-1]), VT_vec = rep(0,sero_no), SeroLabel = 1:sero_no)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = colSums(UK_cluster_freq_sero_6)/sum(UK_cluster_freq_sero_6), model_name_1 ="Model", model1 = colSums(simMeanggCPP7_UK_matrix[,-1])/sum(simMeanggCPP7_UK_matrix[,-1]),  VT_vec = rep(0,sero_no), SeroLabel = unique(seq_clusters$Serotype))

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = rowSums(UK_cluster_freq_sero_6)/sum(UK_cluster_freq_sero_6), model_name_1 ="Model", model1 = rowSums(simMeanggCPP7_UK_matrix[,-1])/sum(simMeanggCPP7_UK_matrix[,-1]),  VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)
```

```{r}
# Param estimates for PPxSero
# Navajo
Navajo_PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_15/Navajo_PPxSero_fit2/Navajo_PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_PPxSero_mcmc <- coda::as.mcmc(cbind(Navajo_PPxSero$probabilities, Navajo_PPxSero$pars))
coda::effectiveSize(Navajo_PPxSero_mcmc)
summary(coda::as.mcmc(Navajo_PPxSero_mcmc))
#plot(Navajo_PPxSero_mcmc)
pars_from_mcmc_Navajo <- map_estimate(Navajo_PPxSero$pars[, 1:4])$MAP_Estimate
# -2.9642979  0.9834568 -2.7628004  0.6148080
read_VT_data_and_lollipop("Navajo", pars_from_mcmc_Navajo)

# Southampton
Southampton_PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_15/UK_PPxSero_fit2/UK_gPPxSero_gCaller_PopPUNK_det_pmcmc_run2.rds")
Southampton_PPxSero_mcmc <- coda::as.mcmc(cbind(Southampton_PPxSero$probabilities, Southampton_PPxSero$pars))
coda::effectiveSize(Southampton_PPxSero_mcmc)
summary(coda::as.mcmc(Southampton_PPxSero_mcmc))
#plot(Navajo_PPxSero_mcmc)
pars_from_mcmc_UK <- map_estimate(Southampton_PPxSero$pars[, 1:4])$MAP_Estimate
# 
read_VT_data_and_lollipop("UK", pars_from_mcmc_UK)

# Mass
Mass_PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_14/Mass_PPxSero/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Mass_PPxSero_mcmc <- coda::as.mcmc(cbind(Mass_PPxSero$probabilities, Mass_PPxSero$pars))
coda::effectiveSize(Mass_PPxSero_mcmc)
summary(coda::as.mcmc(Mass_PPxSero_mcmc))
#plot(Navajo_PPxSero_mcmc)
pars_from_mcmc_Mass<- map_estimate(Mass_PPxSero$pars[, 1:4])$MAP_Estimate
# -1.1040119  0.2518332 -2.2806578  0.3606627
read_VT_data_and_lollipop("Mass", pars_from_mcmc_Mass)
```

```{r}
mass_cluster_freq_1 <- readRDS(file = "UK_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "UK_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "UK_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "UK_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "UK_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "UK_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "UK_cluster_freqs_7.rds")
  
sum_UK_data <- (mass_cluster_freq_1 + mass_cluster_freq_2 + mass_cluster_freq_3 + mass_cluster_freq_4 + mass_cluster_freq_5 + mass_cluster_freq_6 + mass_cluster_freq_7)

count_cluster_size_UK <- rep(0, (max(sum_UK_data) +1) )
for (i in 0:(max(sum_UK_data))) {
  count_cluster_size_UK[i+1] <- length(which(sum_UK_data == i))
}
plot(0:max(sum_UK_data),count_cluster_size_UK/sum(count_cluster_size_UK), ylim = c(0,0.6), main = "Southampton counts vs. Poisson distribution", xlab = "Cluster Size", ylab = "relative counts of cluster size")
lines(0:max(sum_UK_data),(dpois(0:76,8)), col = "red")
lines(0:max(sum_UK_data),(dpois(0:76,1)), col = "blue")
legend(60, 0.6, legend=c("Pois(8)", "Pois(1)"),
       col=c("red", "blue"), lty=1, cex=1.2)

plot(0:max(sum_UK_data),count_cluster_size_UK/sum(count_cluster_size_UK), ylim = c(0,0.6), main = "Southampton counts vs. Poisson distribution", xlab = "Cluster Size", ylab = "relative counts of cluster size")
lines(0:max(sum_UK_data),(dpois(0:76,8) + dpois(0:76,1))/sum(dpois(0:76,8) + dpois(0:76,1)), col = "red")
### might be zero-inflation?!
# I think it is 1-inflation :D 
# check in other datasets 

# wait, how about just one year?
counts_UK_1 <- rep(0, (max(mass_cluster_freq_1) +1) )
for (i in 0:(max(mass_cluster_freq_1))) {
  counts_UK_1[i+1] <- length(which(mass_cluster_freq_1 == i))
}

plot(0:max(mass_cluster_freq_1),counts_UK_1/sum(counts_UK_1), ylim = c(0,0.6), main = "Southampton counts vs. Poisson distribution", xlab = "Cluster Size", ylab = "relative counts of cluster size")
lines(0:max(mass_cluster_freq_1),(dpois(0:10,8)), col = "red")
lines(0:max(mass_cluster_freq_1),(dpois(0:10,0)), col = "blue")
legend(60, 0.6, legend=c("Pois(8)", "Pois(1)"),
       col=c("red", "blue"), lty=1, cex=1.2)


lines(dnbinom(0:80, 1, mu =1, log = FALSE))
lines(dnbinom(0:80, 10, mu =1, log = FALSE))

plot(dnbinom(0:80, 10, mu =1, log = FALSE), ylim = c(0,1))
lines(dnbinom(0:80, 1, mu =1, log = FALSE))
lines(dnbinom(0:80, 2, mu =1, log = FALSE))
lines(dnbinom(0:80, 20, mu =1, log = FALSE))
```

```{r}
## PPxSero_2vacc fits
# Navajo
Navajo_PPxSero2vacc <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_23/Navajo_PPxSero2vacc/Navajo_PPxSero2vacc_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_PPxSero_mcmc <- coda::as.mcmc(cbind(Navajo_PPxSero2vacc$probabilities, Navajo_PPxSero2vacc$pars))
coda::effectiveSize(Navajo_PPxSero_mcmc)
summary(coda::as.mcmc(Navajo_PPxSero_mcmc))
#Navajo with corrected likelihood

# Navajo
Navajo_PPxSero2vacc <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_11/Navajo_PPxSero_NewStart/Navajo_PPxSero2vacc_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_PPxSero_mcmc <- coda::as.mcmc(cbind(Navajo_PPxSero2vacc$probabilities, Navajo_PPxSero2vacc$pars))
coda::effectiveSize(Navajo_PPxSero_mcmc)
summary(coda::as.mcmc(Navajo_PPxSero_mcmc))
# -3.6979  0.8129 -2.6422 0.5849

# Navajo
Navajo_PPxSero2vacc <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_21/Navajo_PPxSero2vacc/Navajo_PPxSero2vacc_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Navajo_PPxSero_mcmc <- coda::as.mcmc(cbind(Navajo_PPxSero2vacc$probabilities, Navajo_PPxSero2vacc$pars))
coda::effectiveSize(Navajo_PPxSero_mcmc)
summary(coda::as.mcmc(Navajo_PPxSero_mcmc))
# -4.0370  0.8789 -2.8074 0.3290

# UK
UK_PPxSero2vacc <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_23/UK_PPxSero2vacc/UK_PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
UK_PPxSero_mcmc <- coda::as.mcmc(cbind(UK_PPxSero2vacc$probabilities, UK_PPxSero2vacc$pars))
coda::effectiveSize(UK_PPxSero_mcmc)
summary(coda::as.mcmc(UK_PPxSero_mcmc))

# UK with corrected likelihood
Southampton_PPxSero2vacc <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_02/UK_PPxSero/UK_PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Southampton_PPxSero2vacc_mcmc <- coda::as.mcmc(cbind(Southampton_PPxSero2vacc$probabilities, Southampton_PPxSero2vacc$pars))
coda::effectiveSize(Southampton_PPxSero2vacc_mcmc)
summary(coda::as.mcmc(Southampton_PPxSero2vacc_mcmc))
#plot(Navajo_PPxSero_mcmc)
pars_from_mcmc_UK <- map_estimate(Southampton_PPxSero2vacc$pars[, 1:4])$MAP_Estimate
# -2.67857028  0.14616278 -3.40487571  0.07433112

# UK 14.10.24
Southampton_PPxSero2vacc <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_14/UK_PPxSero_NewStart/UK_PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Southampton_PPxSero2vacc_mcmc <- coda::as.mcmc(cbind(Southampton_PPxSero2vacc$probabilities, Southampton_PPxSero2vacc$pars))
coda::effectiveSize(Southampton_PPxSero2vacc_mcmc)
summary(coda::as.mcmc(Southampton_PPxSero2vacc_mcmc))
#plot(Navajo_PPxSero_mcmc)
pars_from_mcmc_UK <- map_estimate(Southampton_PPxSero2vacc$pars[, 1:4])$MAP_Estimate
# -2.67857028  0.14616278 -3.40487571  0.07433112


```

```{r}
# Look at Southampton PPxSero 2vacc fits
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero_2vacc.R")

  seq_clusters <- readRDS("UK_PP.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "UK_ggCaller_intermed_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  mass_clusters <- length(unique(seq_clusters$Cluster))
  delta_ranking <- readRDS(file = "UK_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "UK_cluster_freqs_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "UK_cluster_freqs_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "UK_cluster_freqs_3.rds")
  mass_cluster_freq_4 <- readRDS(file = "UK_cluster_freqs_4.rds")
  mass_cluster_freq_5 <- readRDS(file = "UK_cluster_freqs_5.rds")
  mass_cluster_freq_6 <- readRDS(file = "UK_cluster_freqs_6.rds")
  mass_cluster_freq_7 <- readRDS(file = "UK_cluster_freqs_7.rds")
  mass_VT <- readRDS(file = "UK_SeroVT.rds")
  
  avg_cluster_freq <- readRDS(file = "UK_PPsero_mig.rds")
  output_filename <- "UK_PPxSero_ggCaller_PopPUNK"
  sero_no = length(unique(seq_clusters$Serotype))
  dt <- 1/12
  peripost_mass_cluster_freq <- data.frame("year" = 1:6, rbind(mass_cluster_freq_2,mass_cluster_freq_3,mass_cluster_freq_4,mass_cluster_freq_5,mass_cluster_freq_6, mass_cluster_freq_7))
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  PCV13_VTs <- rep(0,sero_no)
  names(PCV13_VTs) <- unique(seq_clusters$Serotype)
  PCV13_VTs[intersect(PCV13_VTs,c("1", "3", "4","5","6A","6B", "7F", "9V", "14", "18C", "19A", "19F", "23F"))] <- 1
  vaccTypes2 <- unname(PCV13_VTs)
  
  # add 6A to PCV7 because there is strong cross-immunity btw PVC7 and 6A (4.Croucher, N. J. et al. Population genomics of post-vaccine changes in pneumococcal epidemiology. Nat. Genet. 45, 656–663 (2013).)
  PCV7_VTs <- rep(0,sero_no)
  names(PCV7_VTs) <- unique(seq_clusters$Serotype)
  PCV7_VTs[intersect(PCV7_VTs,c("4","6A", "6B", "9V", "14", "18C", "19F", "23F"))] <- 1
  vaccTypes1 <- unname(PCV7_VTs)
  
  dt <- 1/12
  vacc_time1 <- 0
  vacc_time2 <- 4
  model_start_pop <- readRDS(file = "UK_PPsero_startpop3.rds")
  
# 2nd fit 15.08. (not a great fit): -0.33669781  0.13949168 -2.87094079  0.04126142
PPxSero2vacc_params <- list(dt = 1/12, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.67857028, prop_f = 0.14616278, sigma_w =-1000 , delta = delta_ranking, m = -3.40487571, migVec =  as.matrix(avg_cluster_freq), v = 0.07433112 , vaccTypes1 = vaccTypes1, vaccTypes2 = vaccTypes2, vacc_time1 = 0, vacc_time2 = 4, sero_no = sero_no)

WF_PPxSero_model <- WF_PPxSero$new(pars = PPxSero2vacc_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP1_UK <- rowMeans(WF_PPxSero_model$run(0)[-1,])[1:mass_clusters]

simMeanggCPP4_UK <- rowMeans(WF_PPxSero_model$run(36)[-1,])[1:mass_clusters]
simMeanggCPP5_UK <- rowMeans(WF_PPxSero_model$run(48)[-1,])[1:mass_clusters]
simMeanggCPP6_UK <- rowMeans(WF_PPxSero_model$run(60)[-1,])[1:mass_clusters]
simMeanggCPP7_UK <- rowMeans(WF_PPxSero_model$run(72)[-1,])[1:mass_clusters]
simMeanggCPP7_UK_all <- rowMeans(WF_PPxSero_model$run(72)[-1,])
simMeanggCPP7_UK_matrix <- matrix(simMeanggCPP7_UK_all, ncol = 42, nrow = 59, byrow = FALSE)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Start", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_UK/sum(simMeanggCPP1_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_7/sum(mass_cluster_freq_7), model_name_1 ="Model", model1 = simMeanggCPP7_UK/sum(simMeanggCPP7_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_6/sum(mass_cluster_freq_6), model_name_1 ="Model", model1 = simMeanggCPP6_UK/sum(simMeanggCPP6_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2009/10", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_4/sum(mass_cluster_freq_4), model_name_1 ="Model", model1 = simMeanggCPP4_UK/sum(simMeanggCPP4_UK), VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)



# colSums(simMeanggCPP7_UK_matrix[,-1])
# gives us the serotype numbers (summed over all clusters)

UK_cluster_freq_sero_7 <- readRDS(file = "UK_cluster_freqs_sero_7.rds")
UK_cluster_freq_sero_7_seroCounts <- colSums(UK_cluster_freq_sero_7)

UK_cluster_freq_sero_6 <- readRDS(file = "UK_cluster_freqs_sero_6.rds")

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2012/13", plot_title = "PopPUNK and ggCaller", data1 = UK_cluster_freq_sero_7_seroCounts/sum(UK_cluster_freq_sero_7_seroCounts), model_name_1 ="Model", model1 = colSums(simMeanggCPP7_UK_matrix[,-1])/sum(simMeanggCPP7_UK_matrix[,-1]), VT_vec = rep(0,sero_no), SeroLabel = 1:sero_no)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = colSums(UK_cluster_freq_sero_6)/sum(UK_cluster_freq_sero_6), model_name_1 ="Model", model1 = colSums(simMeanggCPP7_UK_matrix[,-1])/sum(simMeanggCPP7_UK_matrix[,-1]),  VT_vec = rep(0,sero_no), SeroLabel = unique(seq_clusters$Serotype))

lollipop_cluster_freqs_VTandNVT_labelSero(year = "Winter 2011/12", plot_title = "PopPUNK and ggCaller", data1 = rowSums(UK_cluster_freq_sero_6)/sum(UK_cluster_freq_sero_6), model_name_1 ="Model", model1 = rowSums(simMeanggCPP7_UK_matrix[,-1])/sum(simMeanggCPP7_UK_matrix[,-1]),  VT_vec = rep(0,59), SeroLabel = UK_PP_serotype_comp)
```



```{r}
## Mass PPxSero
Mass_PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_08_14/Mass_PPxSero/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Mass_PPxSero_mcmc <- coda::as.mcmc(cbind(Mass_PPxSero$probabilities, Mass_PPxSero$pars))
coda::effectiveSize(Mass_PPxSero_mcmc)
summary(coda::as.mcmc(Mass_PPxSero_mcmc))

library(bayestestR)
map_estimate(Mass_PPxSero$pars)
# -1.10 0.25 -2.28 0.36

sampled_param_id <- sample(1:nrow(Mass_PPxSero_mcmc),1000)

# trying to add confidence intervals to lollipop plot
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")

seq_clusters <- readRDS("PopPUNK_clusters.rds")
  sero_no = length(unique(seq_clusters$Serotype))
  intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "PPsero_startpop.rds")
  delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
  mass_VT <- readRDS(file = "SeroVT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- readRDS(file = "PPsero_mig.rds")
  dt <- 1/36
  vacc_time <- 0
  output_filename <- "PPxSero_ggCaller_PopPUNK"
  
  
  PPxSero_params <- list(dt = 1/36, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -1.10, prop_f = 0.25, sigma_w =-1000 , delta = delta_ranking, m = -2.28, migVec =  as.matrix(avg_cluster_freq), v = 0.36 , vaccTypes = mass_VT, vacc_time = 0, sero_no = sero_no)

WF_PPxSero_model <- WF_PPxSero$new(pars = PPxSero_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP1_Mass <- rowMeans(WF_PPxSero_model$run(0)[-1,])[1:mass_clusters]
simMeanggCPP1_Mass_all <- rowMeans(WF_PPxSero_model$run(0)[-1,])
simMeanggCPP1_Mass_matrix <- matrix(simMeanggCPP1_Mass_all, ncol = (sero_no+1), nrow = mass_clusters, byrow = FALSE)

simMeanggCPP2_Mass <- rowMeans(WF_PPxSero_model$run(36)[-1,])[1:mass_clusters]
simMeanggCPP3_Mass <- rowMeans(WF_PPxSero_model$run(72)[-1,])[1:mass_clusters]

simMeanggCPP3_Mass_1 <- WF_PPxSero_model$run(72)[-1,1][1:mass_clusters]
simMeanggCPP3_Mass_2 <- WF_PPxSero_model$run(72)[-1,2][1:mass_clusters]

simMeanggCPP3_Mass_all <- rowMeans(WF_PPxSero_model$run(72)[-1,])
simMeanggCPP3_Mass_matrix <- matrix(simMeanggCPP7_Mass_all, ncol = (sero_no+1), nrow = mass_clusters, byrow = FALSE)


PP_serotype_comp <- rep(0,PP_mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_serotype_comp[i] <- paste(unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==unique(PopPUNK_clusters$Cluster)[i])]), collapse = ", ")
}

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Model", model1 = (simMeanggCPP1_Mass)/sum((simMeanggCPP1_Mass)), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="Model", model1 = (simMeanggCPP3_Mass)/sum((simMeanggCPP3_Mass)), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)

# two simulations with the same params already differ quite a bit
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="Model", model1 = (simMeanggCPP3_Mass_1)/sum((simMeanggCPP3_Mass_1)), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="Model", model1 = (simMeanggCPP3_Mass_2)/sum((simMeanggCPP3_Mass_2)), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)

# make lollipop plot for serotypes instead
PP_mass_cluster_freq_3_sero <- readRDS(file = "PP_mass_cluster_freq_3_sero.rds")
PP_mass_cluster_freq_1_sero <- readRDS(file = "PP_mass_cluster_freq_1_sero.rds")

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = colSums(PP_mass_cluster_freq_3_sero)/sum(PP_mass_cluster_freq_3_sero), model_name_1 ="Model", model1 = colSums(simMeanggCPP3_Mass_matrix[,-1])/sum(simMeanggCPP3_Mass_matrix[,-1]), VT_vec = rep(0,sero_no), SeroLabel = 1:sero_no)

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = rowSums(PP_mass_cluster_freq_3_sero)/sum(PP_mass_cluster_freq_3_sero), model_name_1 ="Model", model1 = rowSums(simMeanggCPP3_Mass_matrix[,-1])/sum(simMeanggCPP3_Mass_matrix[,-1]),  VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)


lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = colSums(PP_mass_cluster_freq_1_sero)/sum(PP_mass_cluster_freq_1_sero), model_name_1 ="Model", model1 = colSums(simMeanggCPP1_Mass_matrix[,-1])/sum(simMeanggCPP1_Mass_matrix[,-1]), VT_vec = rep(0,sero_no), SeroLabel = 1:sero_no)

plot(1:sero_no, colSums(PP_mass_cluster_freq_1_sero)/sum(PP_mass_cluster_freq_1_sero))
points(colSums(simMeanggCPP1_Mass_matrix[,-1])/sum(simMeanggCPP1_Mass_matrix[,-1]), col = "red")

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = rowSums(PP_mass_cluster_freq_1_sero)/sum(PP_mass_cluster_freq_1_sero), model_name_1 ="Model", model1 = rowSums(simMeanggCPP1_Mass_matrix[,-1])/sum(simMeanggCPP1_Mass_matrix[,-1]), VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
# create empty array for storing all of the simulation results
empty_vec <- rep(0,mass_clusters)
sim_results_Mass <- array(c(empty_vec, 1000), dim = c(mass_clusters, 1000))

for (i in 1:1000) {
PPxSero_params <- list(dt = 1/36, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = Mass_PPxSero_mcmc[sampled_param_id[i],4], prop_f = Mass_PPxSero_mcmc[sampled_param_id[i],5], sigma_w =-1000 , delta = delta_ranking, m = Mass_PPxSero_mcmc[sampled_param_id[i],6], migVec =  as.matrix(avg_cluster_freq), v = Mass_PPxSero_mcmc[sampled_param_id[i],7] , vaccTypes = mass_VT, vacc_time = 0, sero_no = sero_no)

WF_PPxSero_model <- WF_PPxSero$new(pars = PPxSero_params,
                         time = 0,
                         n_particles = 1L,
                         n_threads = 4L,
                         seed = 1L)

simMeanggCPP3_Mass_1 <- WF_PPxSero_model$run(72)[-1,1][1:mass_clusters]

sim_results_Mass[,i] <- simMeanggCPP3_Mass_1
}

divide_by_sum <- function(x){
  x <- x / sum(x)
  x
}

sim_results_Mass_rel <- apply(sim_results_Mass, 2, divide_by_sum)

#ttest_1 <- t.test(sim_results_Mass_rel[1,])

# collect confidence intervals for all clusters
conf_intervals_Mass <- array(c(empty_vec,empty_vec),dim = c(mass_clusters, 2))

for (i in 1:mass_clusters) {
  ttest <- t.test(sim_results_Mass_rel[i,])
  conf_intervals_Mass[i,] <- c(ttest$conf.int[1], ttest$conf.int[2])
}

lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="lower_bound", model1 = conf_intervals_Mass[,1], model_name_2 ="upper_bound", model2 = conf_intervals_Mass[,2], VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)


# try min and max instead
min_Mass <- apply(sim_results_Mass_rel, 1, min)
max_Mass <- apply(sim_results_Mass_rel, 1, max)

lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="minimum", model1 = min_Mass, model_name_2 ="maximum", model2 = max_Mass, VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
PPxSero_params <- list(dt = 1/36, species_no =mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = ( model_start_pop), Pop_eq = Pop_eq <- rowSums(model_start_pop), capacity = sum( model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = Mass_PPxSero_mcmc[sampled_param_id[i],4], prop_f = Mass_PPxSero_mcmc[sampled_param_id[i],5], sigma_w =-1000 , delta = delta_ranking, m = Mass_PPxSero_mcmc[sampled_param_id[i],6], migVec =  as.matrix(avg_cluster_freq), v = Mass_PPxSero_mcmc[sampled_param_id[i],7] , vaccTypes = mass_VT, vacc_time = 0, sero_no = sero_no)

WF_PPxSero_model <- WF_PPxSero$new(pars = PPxSero_params,
                         time = 0,
                         n_particles = 100L,
                         n_threads = 8L,
                         seed = 1L)

simMeanggCPP3_Mass_1 <- WF_PPxSero_model$run(72)[(2:(mass_clusters+1)),]


divide_by_sum <- function(x){
  x <- x / sum(x)
  x
}

sim_results_Mass_rel <- apply(simMeanggCPP3_Mass_1, 2, divide_by_sum)

# collect confidence intervals for all clusters
conf_intervals_Mass <- array(c(empty_vec,empty_vec),dim = c(mass_clusters, 2))

for (i in 1:mass_clusters) {
  ttest <- t.test(sim_results_Mass_rel[i,])
  conf_intervals_Mass[i,] <- c(ttest$conf.int[1], ttest$conf.int[2])
}

lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="lower_bound", model1 = conf_intervals_Mass[,1], model_name_2 ="upper_bound", model2 = conf_intervals_Mass[,2], VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
plot(1:mass_clusters, mass_cluster_freq_3/sum(mass_cluster_freq_3), type = "p", pch = 19)
points(sim_results_Mass_rel[,1], col = "red")
points(sim_results_Mass_rel[,2], col = "red")
points(sim_results_Mass_rel[,3], col = "red")
points(sim_results_Mass_rel[,4], col = "red")
points(sim_results_Mass_rel[,5], col = "red")
points(sim_results_Mass_rel[,6], col = "red")
points(sim_results_Mass_rel[,7], col = "red")
points(sim_results_Mass_rel[,8], col = "red")
points(sim_results_Mass_rel[,9], col = "red")
points(sim_results_Mass_rel[,10], col = "red")

rowMax <- function(x){
  max(x)
}
sim_res_rowMax <- apply(sim_results_Mass_rel,1,rowMax)
rowMin <- function(x){
  min(x)
}
sim_res_rowMin <- apply(sim_results_Mass_rel,1,rowMin)


plot(1:mass_clusters, mass_cluster_freq_3/sum(mass_cluster_freq_3), type = "p", pch = 19, ylim = c(0,0.2))
points(sim_res_rowMax, col = "red")
points(sim_res_rowMin, col = "red")
```

```{r}
# repeat this for standard model
#corrected
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.0958228, sigma_w = -1000, prop_f = 0.3107495, delta = ggC_delta_ranking, m = -4.1434129, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1366157, vacc_time = 0)

WF_nG_h_vP <- odin.dust::odin_dust("NFDS_Model.R")


### comparing time trajectories between model and data
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 0,
                                   n_particles = 1L,
                                   n_threads = 4L,
                                   seed = 1L)
empty_vec <- rep(0,mass_clusters)
sim_ggCPP2 <- array(rep(empty_vec,73),dim = c(mass_clusters, 73))

for (i in 0:72) {
  sim_ggCPP2[,i+1] <- (WFmodel_ggCPP$run(i)[-1])
}

library("viridis") 
plot(1:mass_clusters, mass_cluster_freq_1/sum(mass_cluster_freq_1), pch = 19, col = "#E69F00", ylim = c(0, 0.2))
for (i in 1:73) {
  points(sim_ggCPP2[,i]/sum(sim_ggCPP2[,i]), col = viridis(73)[i])
}
points((1:mass_clusters)+0.3,sim_ggCPP2[,1]/sum(sim_ggCPP2[,1]), col = viridis(73)[1], pch = 19)
points((1:mass_clusters)+0.3,sim_ggCPP2[,37]/sum(sim_ggCPP2[,37]), col = viridis(73)[37], pch = 19)
points((1:mass_clusters)+0.3,sim_ggCPP2[,73]/sum(sim_ggCPP2[,73]), col = viridis(73)[73], pch = 19)
points(mass_cluster_freq_1/sum(mass_cluster_freq_1), col = "#E69F00", pch = 19)
points(mass_cluster_freq_2/sum(mass_cluster_freq_2), col = "#D55E00", pch = 19)
points(mass_cluster_freq_3/sum(mass_cluster_freq_3), col = "#CC79A7", pch = 19)
legend(40, 0.2, legend = c("Model 0", "Model 36", "Model 72","Data 2001", "Data 2004", "Data 2007"), fill = c(viridis(73)[1], viridis(73)[37], viridis(73)[73], "#E69F00","#D55E00", "#CC79A7"), cex = 2)

# the fit seems usually better for time point 36 (2004) than for 72 (2007)?
combined_compare(sim_ggCPP2[,37], mass_cluster_freq_2)
#[1] -128.7101
combined_compare(sim_ggCPP2[,73], mass_cluster_freq_3)
#[1] -122.9715
# hm, there is absolutely no evidence for that...

plot(1:mass_clusters, mass_cluster_freq_1/sum(mass_cluster_freq_1), pch = 19, col = "#E69F00", ylim = c(0, 0.2), cex = 1.5, ylab = "relative Cluster size", xlab = "Cluster Index")
for (i in 1:73) {
  points((1:mass_clusters)+ ((i-1)*0.005), sim_ggCPP2[,i]/sum(sim_ggCPP2[,i]), col = viridis(73)[i], cex = 1.5)
}
points((1:mass_clusters),sim_ggCPP2[,1]/sum(sim_ggCPP2[,1]), bg = viridis(73)[1], pch = 21, col = "#E69F00", cex = 1.5)
points((1:mass_clusters)+0.18,sim_ggCPP2[,37]/sum(sim_ggCPP2[,37]), bg = viridis(73)[37], pch = 21, col = "#D55E00", cex = 1.5)
points((1:mass_clusters)+0.36,sim_ggCPP2[,73]/sum(sim_ggCPP2[,73]), bg = viridis(73)[73], pch = 21, col = "#CC79A7", cex = 1.5)
points(mass_cluster_freq_1/sum(mass_cluster_freq_1), col = "#E69F00", pch = 19, cex = 1.5)
points((1:mass_clusters)+0.18,mass_cluster_freq_2/sum(mass_cluster_freq_2), col = "#D55E00", pch = 19, cex = 1.5)
points((1:mass_clusters)+0.36,mass_cluster_freq_3/sum(mass_cluster_freq_3), col = "#CC79A7", pch = 19, cex = 1.5)
abline(v= (1:mass_clusters) + 0.7 )
legend(40, 0.2, legend = c("Model 0", "Model 36", "Model 72","Data 2001", "Data 2004", "Data 2007"), fill = c(viridis(73)[1], viridis(73)[37], viridis(73)[73], "#E69F00","#D55E00", "#CC79A7"), cex = 1.5)


WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 0,
                                   n_particles = 100L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sim_ggCPP3 <- (WFmodel_ggCPP$run(72)[-1,])

sim_ggCPP3_rel <- apply(sim_ggCPP3,2,divide_by_sum)
sim_res_rowMax <- apply(sim_ggCPP3_rel,1,rowMax)
sim_res_rowMin <- apply(sim_ggCPP3_rel,1,rowMin)

plot(1:mass_clusters, mass_cluster_freq_3/sum(mass_cluster_freq_3), type = "p", pch = 19)
points(sim_res_rowMax, col = "red")
points(sim_res_rowMin, col = "red")
```

```{r}
# this for null model
WF_null <- odin.dust::odin_dust("null_NFDS_Model.R")
# params from fit ggCPP 2024_03_08 
# 0.008118758 0.031313422 
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008118758, v = 0.031313422)

WFmodelnull_ggCPP <- WF_null$new(pars = null_ggCPP_params,
                                   time = 0,
                                   n_particles = 100L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodelnull_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodelnull_ggCPP$run(72)[-1,])
sim_ggCPP3 <- (WFmodelnull_ggCPP$run(72)[-1,])

sim_ggCPP3_rel <- apply(sim_ggCPP3,2,divide_by_sum)
sim_res_rowMax <- apply(sim_ggCPP3_rel,1,rowMax)
sim_res_rowMin <- apply(sim_ggCPP3_rel,1,rowMin)

plot(1:mass_clusters, mass_cluster_freq_3/sum(mass_cluster_freq_3), type = "p", pch = 19, ylim = c(0, max(sim_res_rowMax)))
points(sim_res_rowMax, col = "red")
points(sim_res_rowMin, col = "red")
```

```{r}
# check mcmc iterations of states instead
# still corrected likelihood, i.e. standard 4-param model
# 4 param fit
Mass_4param_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_07_26/Mass_correctedLikelihood/4param_ggCaller_PopPUNK_det_pmcmc_run2.rds")

plot(1:mass_clusters, mass_cluster_freq_3/sum(mass_cluster_freq_3), type = "p", pch = 19)
points(Mass_4param_fit$state[-1,10000]/sum(Mass_4param_fit$state[-1,10000]), col = "red")
points(Mass_4param_fit$state[-1,20000]/sum(Mass_4param_fit$state[-1,20000]), col = "red")
points(Mass_4param_fit$state[-1,30000]/sum(Mass_4param_fit$state[-1,30000]), col = "red")
points(Mass_4param_fit$state[-1,40000]/sum(Mass_4param_fit$state[-1,40000]), col = "red")
points(Mass_4param_fit$state[-1,50000]/sum(Mass_4param_fit$state[-1,50000]), col = "red")
points(Mass_4param_fit$state[-1,60000]/sum(Mass_4param_fit$state[-1,60000]), col = "red")
points(Mass_4param_fit$state[-1,70000]/sum(Mass_4param_fit$state[-1,70000]), col = "red")
points(Mass_4param_fit$state[-1,80000]/sum(Mass_4param_fit$state[-1,80000]), col = "red")

# how much does each of them contribute to the likelihood?
combined_likelihood <- rep(0, mass_clusters)
for (i in 1:mass_clusters) {
  combined_likelihood[i] <- ll_pois(mass_cluster_freq_3[i],Mass_4param_fit$state[i+1,10000]/sum(Mass_4param_fit$state[-1,10000])*sum(mass_cluster_freq_3))
}

plot(which(PP_mass_VT==1),combined_likelihood[which(PP_mass_VT==1)], pch = 21, ylim = c(-5,0), xlim = c(0,56), xlab = "Massachusetts Clusters", ylab = "likelihood")
points(which(PP_mass_VT==0),combined_likelihood[which(PP_mass_VT==0)], pch = 19)
legend(0,0, legend = c("VT","NVT"), pch = c(21,19))

mean(combined_likelihood[which(PP_mass_VT==1)])
mean(combined_likelihood[which(PP_mass_VT==0)])
# NVTs, on average, add more to the likelihood, i.e. are more difficult to fit
```


```{r}
# check for within-cluster overdispersion for Mass
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
PP_model_start_pop_scaled <- PP_model_start_pop/sum(PP_model_start_pop) * sum(mass_cluster_freq_1)
plot(1:mass_clusters, PP_model_start_pop_scaled/sum(PP_model_start_pop_scaled), pch = 21)
points(mass_cluster_freq_2/sum(mass_cluster_freq_2), col = "red")
points(mass_cluster_freq_3/sum(mass_cluster_freq_3), col = "blue")

plot(dpois(1:sum(PP_model_start_pop_scaled),PP_model_start_pop_scaled[1]), col = "blue")
abline(v = PP_model_start_pop_scaled[1],col = "blue")
abline(v = mass_cluster_freq_2[1],col = "red")
points(dpois(1:sum(mass_cluster_freq_2),mass_cluster_freq_2[1]), col = "red")
abline(v = mass_cluster_freq_3[1],col = "orange")

plot(dpois(1:sum(PP_model_start_pop),PP_model_start_pop[2]), col = "blue")
abline(v = PP_model_start_pop[2],col = "blue")
abline(v = mass_cluster_freq_2[2],col = "red")
points(dpois(1:sum(mass_cluster_freq_2),mass_cluster_freq_2[2]), col = "red")
abline(v = mass_cluster_freq_3[2],col = "orange")
```

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
ggCPP_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
ggCPP_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)

# with corrected likelihood (26.07.24): -2.0958228  0.3107495 -4.4689789  0.1366157 
# map estimate of this run: map_estimate(Mass_4param_fit$pars[, 1:4])
# -2.11 0.25 -4.41 0.11
#corrected
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.0958228, sigma_w = -1000, prop_f = 0.3107495, delta = ggC_delta_ranking, m = -4.1434129, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1366157, vacc_time = 0)
WF_nG_h_vP <- odin.dust::odin_dust("NFDS_Model.R")
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 0,
                                   n_particles = 1L,
                                   n_threads = 4L,
                                   seed = 1L)
#simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
#simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
#ggCPP_trajectory <- WFmodel_ggCPP$run(72)
n_particles <- 1L
n_times <- 144
ggCPP_trajectory <- array(NA, dim = c(WFmodel_ggCPP$info()$len, n_particles, n_times+1))
for (t in 0:(n_times)) {
  ggCPP_trajectory[ , , t+1] <- WFmodel_ggCPP$run(t)
}
time <- ggCPP_trajectory[1, 1, ]
ggCPP_trajectory <- ggCPP_trajectory[-1, , ]

all_colors = grDevices::colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]
rnd_colors <- sample(all_colors,nrow(ggCPP_trajectory))

plot(time, ggCPP_trajectory[1,]/colSums(ggCPP_trajectory), ylim = c(0,0.3), type = "l", col = rnd_colors[1])
points(0,PP_mass_cluster_freq_1[1]/sum(PP_mass_cluster_freq_1), pch = 19, col = rnd_colors[1])
points(1,PP_mass_cluster_freq_2[1]/sum(PP_mass_cluster_freq_2), pch = 19, col = rnd_colors[1])
points(2,PP_mass_cluster_freq_3[1]/sum(PP_mass_cluster_freq_3), pch = 19, col = rnd_colors[1])
for (i in 2:nrow(ggCPP_trajectory)) {
  lines(time,ggCPP_trajectory[i,]/colSums(ggCPP_trajectory), col = rnd_colors[i])
  points(0,PP_mass_cluster_freq_1[i]/sum(PP_mass_cluster_freq_1), pch = 19, col = rnd_colors[i])
  points(1,PP_mass_cluster_freq_2[i]/sum(PP_mass_cluster_freq_2), pch = 19, col = rnd_colors[i])
  points(2,PP_mass_cluster_freq_3[i]/sum(PP_mass_cluster_freq_3), pch = 19, col = rnd_colors[i])
}

# do the same for all clusters that occur at least three times in the dataset (across all time points)
first_plot_point <- which((PP_mass_cluster_freq_1 + PP_mass_cluster_freq_2 + PP_mass_cluster_freq_3)>=3)[1]
plot(time, ggCPP_trajectory[first_plot_point,]/colSums(ggCPP_trajectory), ylim = c(0,0.3), type = "l", col = rnd_colors[first_plot_point])
points(0,PP_mass_cluster_freq_1[first_plot_point]/sum(PP_mass_cluster_freq_1), pch = 19, col = rnd_colors[first_plot_point])
points(1,PP_mass_cluster_freq_2[first_plot_point]/sum(PP_mass_cluster_freq_2), pch = 19, col = rnd_colors[first_plot_point])
points(2,PP_mass_cluster_freq_3[first_plot_point]/sum(PP_mass_cluster_freq_3), pch = 19, col = rnd_colors[first_plot_point])
for (i in which((PP_mass_cluster_freq_1 + PP_mass_cluster_freq_2 + PP_mass_cluster_freq_3)>=3)[-1]) {
  lines(time,ggCPP_trajectory[i,]/colSums(ggCPP_trajectory), col = rnd_colors[i])
  points(0,PP_mass_cluster_freq_1[i]/sum(PP_mass_cluster_freq_1), pch = 19, col = rnd_colors[i])
  points(1,PP_mass_cluster_freq_2[i]/sum(PP_mass_cluster_freq_2), pch = 19, col = rnd_colors[i])
  points(2,PP_mass_cluster_freq_3[i]/sum(PP_mass_cluster_freq_3), pch = 19, col = rnd_colors[i])
}

# do this for all cluster that occur with at least 2.5% frequency in at least one time point (is what Corander et al. did)
frequent_clusters <- unique(c(which(PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1) >= 0.025),which(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) >= 0.025),which(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) >= 0.025)))
frequent_clusters <- sort(frequent_clusters)
first_plot_point <- frequent_clusters[1]
plot(time, ggCPP_trajectory[first_plot_point,]/colSums(ggCPP_trajectory), ylim = c(0,0.2), type = "l", col = rnd_colors[first_plot_point])
points(0,PP_mass_cluster_freq_1[first_plot_point]/sum(PP_mass_cluster_freq_1), pch = 19, col = rnd_colors[first_plot_point])
points(1,PP_mass_cluster_freq_2[first_plot_point]/sum(PP_mass_cluster_freq_2), pch = 19, col = rnd_colors[first_plot_point])
points(2,PP_mass_cluster_freq_3[first_plot_point]/sum(PP_mass_cluster_freq_3), pch = 19, col = rnd_colors[first_plot_point])
for (i in frequent_clusters[-1]) {
  lines(time,ggCPP_trajectory[i,]/colSums(ggCPP_trajectory), col = rnd_colors[i])
  points(0,PP_mass_cluster_freq_1[i]/sum(PP_mass_cluster_freq_1), pch = 19, col = rnd_colors[i])
  points(1,PP_mass_cluster_freq_2[i]/sum(PP_mass_cluster_freq_2), pch = 19, col = rnd_colors[i])
  points(2,PP_mass_cluster_freq_3[i]/sum(PP_mass_cluster_freq_3), pch = 19, col = rnd_colors[i])
}

# make bar plots instead
ggCPP1 <- ggCPP_trajectory[,1]
ggCPP2 <- ggCPP_trajectory[,37]
ggCPP3 <- ggCPP_trajectory[,73]

barplot_df <- data.frame(time = sort(rep(c("2001","2004","2007"),length(frequent_clusters))), cluster = (rep(1:length(frequent_clusters),3)), model = c((ggCPP1/sum(ggCPP1))[frequent_clusters], (ggCPP2/sum(ggCPP2))[frequent_clusters], (ggCPP3/sum(ggCPP3))[frequent_clusters]), data = c((PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1))[frequent_clusters],(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))[frequent_clusters],(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3))[frequent_clusters]))

p_model <- ggplot(data=barplot_df, aes(x=cluster, y=model, fill=time)) +
geom_bar(stat="identity", position=position_dodge()) + scale_fill_manual(values=c("#E69F00","#D55E00", "#CC79A7")) +
  scale_x_continuous("Strains", breaks = (1:length(frequent_clusters)),labels = as.character(frequent_clusters)) + 
  scale_y_continuous(name="Frequency in model", limits=c(0, 0.175)) +
  geom_vline(xintercept = seq(from=.5, to=length(frequent_clusters)+.5, by = 1), col = "grey") +
  theme(text = element_text(size = 20))

p_data <- ggplot(data=barplot_df, aes(x=cluster, y=data, fill=time)) +
geom_bar(stat="identity", position=position_dodge()) + scale_fill_manual(values=c("#E69F00","#D55E00", "#CC79A7")) +
  scale_x_continuous("Strains", breaks = (1:length(frequent_clusters)),labels = as.character(frequent_clusters))  + 
  scale_y_continuous(name="Frequency in data", limits=c(0, 0.175)) +
  geom_vline(xintercept = seq(from=.5, to=length(frequent_clusters)+.5, by = 1), col = "grey") +
  theme(text = element_text(size = 20))

library(gridExtra)
grid.arrange(p_data,p_model, ncol=1)
```

#look at fits for PPxSero_LikeWithSero
```{r}
#Data
  mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
  PP_mass_sero_freq_1 <- readRDS(file = "PP_mass_sero_freq_1.rds")
  PP_mass_sero_freq_2 <- readRDS(file = "PP_mass_sero_freq_2.rds")
  PP_mass_sero_freq_3 <- readRDS(file = "PP_mass_sero_freq_3.rds")
  
  seq_clusters <- readRDS("PopPUNK_clusters.rds")
  sero_no = length(unique(seq_clusters$Serotype))
  intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS("PPsero_startpop6.rds") # same as 5 but new order
  delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")

  mass_VT <- readRDS(file = "SeroVT.rds")
  mass_clusters <- length(unique(seq_clusters$Cluster))
  avg_cluster_freq <- readRDS(file = "PPsero_mig.rds")
  dt <- 1/36
  vacc_time <- 0

#Parameter fits
# Mass
PPxSeroWithSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_02/Mass_PPxSero_LikelihoodWithSero/PPxSeroWithSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSeroWithSero_mcmc <- coda::as.mcmc(cbind(PPxSeroWithSero$probabilities, PPxSeroWithSero$pars))
coda::effectiveSize(PPxSeroWithSero_mcmc)
summary(coda::as.mcmc(PPxSeroWithSero_mcmc))
library(bayestestR)
map_estimate(PPxSeroWithSero$pars)
# sigma_f -2.73, prop_f 0.27, m -3.30, v 0.11

#Parameter fits for JustSero likelihood
# Mass
PPxSeroJustSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_02/Mass_PPxSero_LikelihoodJustSero/PPxSeroWithSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSeroJustSero_mcmc <- coda::as.mcmc(cbind(PPxSeroJustSero$probabilities, PPxSeroJustSero$pars))
coda::effectiveSize(PPxSeroJustSero_mcmc)
summary(coda::as.mcmc(PPxSeroJustSero_mcmc))
library(bayestestR)
map_estimate(PPxSeroJustSero$pars)
# sigma_f -0.06, prop_f 9.64e-03, m -3.26, v 0.17
fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop5, Pop_eq = as.double(rowSums(PPsero_startpop5)), capacity = sum(PPsero_startpop5), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -0.06, prop_f = 9.64e-03, delta = ggC_delta_ranking, m = -3.26, migVec = PPxSero_matrix_prob, vaccTypes = SeroVT, v = 0.17, vacc_time = 0)
 
# old Mass PPxSero Fit (14.08.)
#-1.1040119  0.2518332 -2.2806578  0.3606627
fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop2, Pop_eq = as.double(rowSums(PPsero_startpop2)), capacity = sum(PPsero_startpop2), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -1.1040119, prop_f = 0.2518332, delta = ggC_delta_ranking, m = -2.2806578, migVec = PPxSero_matrix_prob, vaccTypes = SeroVT, v = 0.3606627, vacc_time = 0)

fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop5, Pop_eq = as.double(rowSums(PPsero_startpop2)), capacity = sum(PPsero_startpop2), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.73, prop_f = 0.27, delta = ggC_delta_ranking, m = -3.30, migVec = PPxSero_matrix_prob, vaccTypes = SeroVT, v = 0.11, vacc_time = 0)

#newStart PPxSeroWithSero fit (04.10.2024)
PPxSeroWithSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_04/Mass_PPxSeroWithSero_NewStart/PPxSeroWithSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSeroWithSero_mcmc <- coda::as.mcmc(cbind(PPxSeroWithSero$probabilities, PPxSeroWithSero$pars))
coda::effectiveSize(PPxSeroWithSero_mcmc)
summary(coda::as.mcmc(PPxSeroWithSero_mcmc))
library(bayestestR)
map_estimate(PPxSeroWithSero$pars)
# sigma_f -2.81, prop_f 0.27, m -3.30, v 0.11
fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(PPsero_startpop6), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.81, prop_f = 0.27, delta = ggC_delta_ranking, m = -3.30, migVec = PPxSero_matrix_prob2, vaccTypes = SeroVT2, v = 0.11, vacc_time = 0)

#newStart PPxSeroWithSero fit (07.10.2024) - corrected sero freqs
PPxSeroWithSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_07/Mass_PPxSeroWithSero_NewStart/PPxSeroWithSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSeroWithSero_mcmc <- coda::as.mcmc(cbind(PPxSeroWithSero$probabilities, PPxSeroWithSero$pars))
coda::effectiveSize(PPxSeroWithSero_mcmc)
summary(coda::as.mcmc(PPxSeroWithSero_mcmc))
library(bayestestR)
map_estimate(PPxSeroWithSero$pars)
# sigma_f -1.13, prop_f 0.25, m -1.48, v 0.48
fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = mass_clusters, sero_no = length(unique(seq_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = model_start_pop, Pop_eq = as.double(rowSums(model_start_pop)), capacity = sum(model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -1.13, prop_f = 0.25, delta = ggC_delta_ranking, m = -1.48, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.48, vacc_time = 0)

#newStart PPxSeroWithSero fit (16.10.2024)
PPxSeroWithSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_16/Mass_PPxSero_NewStart/Mass_PPxSero_WithSero/PPxSeroWithSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSeroWithSero_mcmc <- coda::as.mcmc(cbind(PPxSeroWithSero$probabilities, PPxSeroWithSero$pars))
coda::effectiveSize(PPxSeroWithSero_mcmc)
summary(coda::as.mcmc(PPxSeroWithSero_mcmc))
library(bayestestR)
map_estimate(PPxSeroWithSero$pars)
# sigma_f -3.24, prop_f 0.25, m -4.59, v 0.07
fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = mass_clusters, sero_no = length(unique(seq_clusters$Serotype)), gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = model_start_pop, Pop_eq = as.double(rowSums(model_start_pop)), capacity = sum(model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = -3.24, prop_f = 0.25, delta = ggC_delta_ranking, m = -4.59, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.07, vacc_time = 0)

WF_PPxSeroWithSero <- odin.dust::odin_dust("NFDS_Model_PPxSeroWithSero.R")
WFmodel_ppxSeroWithSero <- WF_PPxSeroWithSero$new(pars = fitPPxSeroWithSero_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanggCPP1_clust <- rowMeans(WFmodel_ppxSeroWithSero$run(0)[2:(PP_mass_clusters+1),])
simMeanggCPP1_sero <- rowMeans(WFmodel_ppxSeroWithSero$run(0)[(PP_mass_clusters + 2):(PP_mass_clusters + sero_no+1),])
simMeanggCPP2_clust <- rowMeans(WFmodel_ppxSeroWithSero$run(36)[2:(PP_mass_clusters+1),])
simMeanggCPP2_sero <- rowMeans(WFmodel_ppxSeroWithSero$run(36)[(PP_mass_clusters + 2):(PP_mass_clusters + sero_no+1),])
simMeanggCPP3_clust <- rowMeans(WFmodel_ppxSeroWithSero$run(72)[2:(PP_mass_clusters+1),])
simMeanggCPP3_sero <- rowMeans(WFmodel_ppxSeroWithSero$run(72)[(PP_mass_clusters + 2):(PP_mass_clusters + sero_no+1),])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_clust/sum(simMeanggCPP1_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_clust/sum(simMeanggCPP2_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_clust/sum(simMeanggCPP3_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT)

# and all but new look
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_clust/sum(simMeanggCPP1_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PPcluster_VTs, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_clust/sum(simMeanggCPP2_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PPcluster_VTs, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_clust/sum(simMeanggCPP3_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PPcluster_VTs, ClustLabel = unique(PopPUNK_clusters$Cluster))

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_sero_freq_2/sum(PP_mass_sero_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_sero/sum(simMeanggCPP2_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_sero_freq_3/sum(PP_mass_sero_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_sero/sum(simMeanggCPP3_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT)

#new look for serotypes as well
mass_VT_str <- sapply(mass_VT, function(x) if(x==1){"VT"}else{"NVT"})
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = (PP_mass_sero_freq_1)/sum((PP_mass_sero_freq_1)), model_name_1 ="Model", model1 = simMeanggCPP1_sero/sum(simMeanggCPP1_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT_str, ClustLabel = unique(PopPUNK_clusters$Serotype))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_sero_freq_2/sum((PP_mass_sero_freq_2)), model_name_1 ="Model", model1 = simMeanggCPP2_sero/sum(simMeanggCPP2_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT_str, ClustLabel = unique(PopPUNK_clusters$Serotype))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 =PP_mass_sero_freq_3/sum((PP_mass_sero_freq_3)), model_name_1 ="Model", model1 = simMeanggCPP3_sero/sum(simMeanggCPP3_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT_str, ClustLabel = unique(PopPUNK_clusters$Serotype))


#re-order to compare to sero-only model

lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 =(PP_mass_sero_freq_3/sum((PP_mass_sero_freq_3)))[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], model_name_1 ="Model", model1 = (simMeanggCPP3_sero/sum(simMeanggCPP3_sero))[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype)[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], VT_vec = mass_VT_str[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], ClustLabel = unique(PopPUNK_clusters$Serotype)[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]])

#combined_compare(simMeanggCPP2_log,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3_log,PP_mass_cluster_freq_3)
#combined_compare(simMeanggCPP2,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3,PP_mass_cluster_freq_3)
combined_compare(simMeanggCPP2_sero,PP_mass_sero_freq_2) + combined_compare(simMeanggCPP3_sero,PP_mass_sero_freq_3)
```

```{r}
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Standard Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), model_name_2 ="Sero Sub-comp.", model2 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Standard Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model_name_2 ="Sero Sub-comp.", model2 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

```

```{r}
# look at time trajectory of this fit

#newStart PPxSeroWithSero fit (16.10.2024)
#PPxSeroWithSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_16/Mass_PPxSero_NewStart/Mass_PPxSero_WithSero/PPxSeroWithSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
#PPxSeroWithSero_mcmc <- coda::as.mcmc(cbind(PPxSeroWithSero$probabilities, PPxSeroWithSero$pars))
#coda::effectiveSize(PPxSeroWithSero_mcmc)
#summary(coda::as.mcmc(PPxSeroWithSero_mcmc))
#library(bayestestR)
#map_estimate(PPxSeroWithSero$pars)
# sigma_f -3.24, prop_f 0.25, m -4.59, v 0.07
fitPPxSeroWithSero_params <- list(dt = 1/36, species_no = mass_clusters, sero_no = length(unique(seq_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = model_start_pop, Pop_eq = as.double(rowSums(model_start_pop)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -3.24, prop_f = 0.25, delta = delta_ranking, m = -4.59, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.07, vacc_time = 0)

WF_PPxSeroWithSero <- odin.dust::odin_dust("NFDS_Model_PPxSeroWithSero.R")
WFmodel_ppxSeroWithSero <- WF_PPxSeroWithSero$new(pars = fitPPxSeroWithSero_params,
                         time = 0,
                         n_particles = 1L,
                         n_threads = 4L,
                         seed = 1L)
#simMeanggCPP1_clust <- rowMeans(WFmodel_ppxSeroWithSero$run(0)[2:(PP_mass_clusters+1),])
#simMeanggCPP1_sero <- rowMeans(WFmodel_ppxSeroWithSero$run(0)[(PP_mass_clusters + 2):(PP_mass_clusters + sero_no+1),])
#simMeanggCPP2_clust <- rowMeans(WFmodel_ppxSeroWithSero$run(36)[2:(PP_mass_clusters+1),])
#simMeanggCPP2_sero <- rowMeans(WFmodel_ppxSeroWithSero$run(36)[(PP_mass_clusters + 2):(PP_mass_clusters + sero_no+1),])
#simMeanggCPP3_clust <- rowMeans(WFmodel_ppxSeroWithSero$run(72)[2:(PP_mass_clusters+1),])
#simMeanggCPP3_sero <- rowMeans(WFmodel_ppxSeroWithSero$run(72)[(PP_mass_clusters + 2):(PP_mass_clusters + sero_no+1),])

empty_vec <- rep(0,mass_clusters)
sim_ggCPP2 <- array(rep(empty_vec,219),dim = c(mass_clusters, 219))

for (i in 0:218) {
  sim_ggCPP2[,i+1] <- (WFmodel_ppxSeroWithSero$run(i)[2:(PP_mass_clusters+1),])
}

library("viridis") 
plot(1:mass_clusters, mass_cluster_freq_1/sum(mass_cluster_freq_1), pch = 19, col = "#E69F00", ylim = c(0, 0.2))
for (i in 1:218) {
  points((1:mass_clusters)+ ((i-1)*0.0045), sim_ggCPP2[,i]/sum(sim_ggCPP2[,i]), col = viridis(218)[i], cex = 1.5)
}
#points((1:mass_clusters),sim_ggCPP2[,1]/sum(sim_ggCPP2[,1]), bg = viridis(73)[1], pch = 21, col = "#E69F00", cex = 1.5)
#points((1:mass_clusters)+0.18,sim_ggCPP2[,37]/sum(sim_ggCPP2[,37]), bg = viridis(73)[37], pch = 21, col = "#D55E00", cex = 1.5)
#points((1:mass_clusters)+0.36,sim_ggCPP2[,73]/sum(sim_ggCPP2[,73]), bg = viridis(73)[73], pch = 21, col = "#CC79A7", cex = 1.5)
points(mass_cluster_freq_1/sum(mass_cluster_freq_1), col = "#E69F00", pch = 19, cex = 1.5)
points((1:mass_clusters)+0.162,mass_cluster_freq_2/sum(mass_cluster_freq_2), col = "#D55E00", pch = 19, cex = 1.5)
points((1:mass_clusters)+0.324,mass_cluster_freq_3/sum(mass_cluster_freq_3), col = "#CC79A7", pch = 19, cex = 1.5)
abline(v= (1:mass_clusters) + 0.7 )
legend(40, 0.2, legend = c("Model 0", "Model 36", "Model 72","Data 2001", "Data 2004", "Data 2007"), fill = c(viridis(73)[1], viridis(73)[37], viridis(73)[73], "#E69F00","#D55E00", "#CC79A7"), cex = 2)


for (j in 1:mass_clusters) {
  loc <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_11_06/TimeTrajMass/"
  file_name <- paste("Cluster", as.character(j), ".pdf", sep = "")
  pdf(file = paste(loc,file_name,sep = ""),   # The directory you want to save the file in
    width = 12, # The width of the plot in inches
    height = 6)
  plot(c(0,36,72), c((mass_cluster_freq_1/sum(mass_cluster_freq_1))[j],(mass_cluster_freq_2/sum(mass_cluster_freq_2))[j], (mass_cluster_freq_3/sum(mass_cluster_freq_3))[j]), pch = 4, col = "red", ylim = c(0, 0.2), xlim = c(0, 220))
for (i in 1:218) {
  points(0+ ((i-1)), sim_ggCPP2[j,i]/sum(sim_ggCPP2[,i]), col = viridis(218)[i], cex = 1.5, pch = 19)
}
points(c(0,36,72), c((mass_cluster_freq_1/sum(mass_cluster_freq_1))[j],(mass_cluster_freq_2/sum(mass_cluster_freq_2))[j], (mass_cluster_freq_3/sum(mass_cluster_freq_3))[j]), pch = 4, col = "red", cex = 2)
#legend(40, 0.2, legend = c("Model 0", "Model 36", "Model 72","Data 2001", "Data 2004", "Data 2007"), fill = c(viridis(218)[1], viridis(218)[37], viridis(218)[73], "black","black", "black"), cex = 2)
dev.off()
}

plot(c(0,36,72), c((mass_cluster_freq_1/sum(mass_cluster_freq_1))[1],(mass_cluster_freq_2/sum(mass_cluster_freq_2))[1], (mass_cluster_freq_3/sum(mass_cluster_freq_3))[1]), pch = 19, col = "#E69F00", ylim = c(0, 0.2), xlim = c(0, 220))
for (i in 1:218) {
  points(0+ ((i-1)), sim_ggCPP2[1,i]/sum(sim_ggCPP2[,i]), col = viridis(218)[i], cex = 1.5)
}
points(c(0,36,72), c((mass_cluster_freq_1/sum(mass_cluster_freq_1))[1],(mass_cluster_freq_2/sum(mass_cluster_freq_2))[1], (mass_cluster_freq_3/sum(mass_cluster_freq_3))[1]), pch = 4, col = "black")


# plot all trajectories together with lines
# this is very crowded though
plot(c(0,36,72), c((mass_cluster_freq_1/sum(mass_cluster_freq_1))[1],(mass_cluster_freq_2/sum(mass_cluster_freq_2))[1], (mass_cluster_freq_3/sum(mass_cluster_freq_3))[1]), pch = 4, col = viridis(mass_clusters)[1], ylim = c(0, 0.2), xlim = c(0, 220))
for (j in 1:mass_clusters) {
  #loc <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_11_06/TimeTrajMass/"
  #file_name <- paste("Cluster", as.character(j), ".pdf", sep = "")
  #pdf(file = paste(loc,file_name,sep = ""),   # The directory you want to save the file in
  #  width = 12, # The width of the plot in inches
  #  height = 6)
  plot_vec <- rep(0, 218)
for (i in 1:218) {
  plot_vec[i] <- sim_ggCPP2[j,i]/sum(sim_ggCPP2[,i])
  #lines(0+ ((i-1)), sim_ggCPP2[j,i]/sum(sim_ggCPP2[,i]), col = viridis(mass_clusters)[j], cex = 1.5, pch = 19)
}
  lines(plot_vec, col = viridis(mass_clusters)[j])
points(c(0,36,72), c((mass_cluster_freq_1/sum(mass_cluster_freq_1))[j],(mass_cluster_freq_2/sum(mass_cluster_freq_2))[j], (mass_cluster_freq_3/sum(mass_cluster_freq_3))[j]), pch = 4, col = viridis(mass_clusters)[j], cex = 2)
#legend(40, 0.2, legend = c("Model 0", "Model 36", "Model 72","Data 2001", "Data 2004", "Data 2007"), fill = c(viridis(218)[1], viridis(218)[37], viridis(218)[73], "black","black", "black"), cex = 2)
#dev.off()
}
```





#look at fits for Mass PPxSero
```{r}
#Data
  mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
  PP_mass_sero_freq_1 <- readRDS(file = "PP_mass_sero_freq_1.rds")
  PP_mass_sero_freq_2 <- readRDS(file = "PP_mass_sero_freq_2.rds")
  PP_mass_sero_freq_3 <- readRDS(file = "PP_mass_sero_freq_3.rds")
  PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
  PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
  PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")

#Parameter fits
# Mass, 06.10.2024
PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_06/Mass_PPxSero_NewNewStart/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_mcmc <- coda::as.mcmc(cbind(PPxSero$probabilities, PPxSero$pars))
coda::effectiveSize(PPxSero_mcmc)
summary(coda::as.mcmc(PPxSero_mcmc))
library(bayestestR)
map_estimate(PPxSero$pars)
# sigma_f -2.61, prop_f 0.37, m -2.35, v 0.71

#Parameter fits
# Mass, 07.10.2024
PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_07/Mass_PPxSero_NewNewStart/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_mcmc <- coda::as.mcmc(cbind(PPxSero$probabilities, PPxSero$pars))
coda::effectiveSize(PPxSero_mcmc)
summary(coda::as.mcmc(PPxSero_mcmc))
library(bayestestR)
map_estimate(PPxSero$pars)
# sigma_f -2.74, prop_f 0.37, m -2.37, v 0.84

# local fit Oct 16: -3.9754960  0.4799110 -4.1216273  0.1149849 

PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
  sero_no = length(unique(PopPUNK_clusters$Serotype))
  intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS("PPsero_startpop6.rds") 
  delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
  mass_VT <- readRDS(file = "SeroVT.rds")
  avg_cluster_freq <- readRDS(file = "PPsero_mig.rds")

# new fit on cluster (16.10.24)
PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_16/Mass_PPxSero_NewStart/Mass_PPxSero_NewStart/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_mcmc <- coda::as.mcmc(cbind(PPxSero$probabilities, PPxSero$pars))
coda::effectiveSize(PPxSero_mcmc)
summary(coda::as.mcmc(PPxSero_mcmc))
library(bayestestR)
map_estimate(PPxSero$pars)
# sigma_f -3.23, prop_f 0.24, m -4.36, v 0.08

fitPPxSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.74, prop_f = 0.37, delta = delta_ranking, m = -2.37, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.84, vacc_time = 0)

fitPPxSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -3.9754960, prop_f = 0.4799110, delta = delta_ranking, m = -4.1216273, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1149849, vacc_time = 0)

fitPPxSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -3.23, prop_f = 0.24, delta = delta_ranking, m = -4.36, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.08, vacc_time = 0)

WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")
WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
#WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params,
#                         time = 0,
#                         n_particles = 100L,
#                         n_threads = 4L,
#                         seed = 1L)
simMeanggCPP1_clust <- rowMeans(WFmodel_ppxSero$run(0)[2:(PP_mass_clusters+1),])
simMeanggCPP1_all <- rowMeans(WFmodel_ppxSero$run(0)[-(1:(PP_mass_clusters+1)),])
simMeanggCPP1_matrix <- matrix(simMeanggCPP1_all, ncol = length(unique(PopPUNK_clusters$Serotype)), nrow = PP_mass_clusters, byrow = FALSE)
simMeanggCPP1_sero <- colSums(simMeanggCPP1_matrix)
simMeanggCPP1_matrix_clust <- WFmodel_ppxSero$run(0)[(2:(PP_mass_clusters+1)),]

simMeanggCPP2_clust <- rowMeans(WFmodel_ppxSero$run(36)[2:(PP_mass_clusters+1),])
simMeanggCPP2_all <- rowMeans(WFmodel_ppxSero$run(36)[-(1:(PP_mass_clusters+1)),])
simMeanggCPP2_matrix <- matrix(simMeanggCPP2_all, ncol = length(unique(PopPUNK_clusters$Serotype)), nrow = PP_mass_clusters, byrow = FALSE)
simMeanggCPP2_sero <- colSums(simMeanggCPP2_matrix)
simMeanggCPP2_matrix_clust <- WFmodel_ppxSero$run(36)[(2:(PP_mass_clusters+1)),]

simMeanggCPP3_clust <- rowMeans(WFmodel_ppxSero$run(72)[2:(PP_mass_clusters+1),])
simMeanggCPP3_all <- rowMeans(WFmodel_ppxSero$run(72)[-(1:(PP_mass_clusters+1)),])
simMeanggCPP3_matrix <- matrix(simMeanggCPP3_all, ncol = length(unique(PopPUNK_clusters$Serotype)), nrow = PP_mass_clusters, byrow = FALSE)
simMeanggCPP3_sero <- colSums(simMeanggCPP3_matrix)
simMeanggCPP3_matrix_clust <- WFmodel_ppxSero$run(72)[(2:(PP_mass_clusters+1)),]

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_clust/sum(simMeanggCPP1_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_clust/sum(simMeanggCPP2_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_clust/sum(simMeanggCPP3_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT, ClustLabel = unique(PopPUNK_clusters$Cluster))

#only relevant clusters
# non_small_cluster_idx from conf_data section
PPcluster_VTs <- readRDS("PPcluster_VTs_3groups.rds") # has VT, NVT, and mixed

lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = (PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1))[non_small_cluster_idx], model_name_1 ="Model", model1 = (simMeanggCPP1_clust/sum(simMeanggCPP1_clust))[non_small_cluster_idx], PP_mass_VT[non_small_cluster_idx], SeroLabel = PP_serotype_comp[non_small_cluster_idx], VT_vec = PPcluster_VTs[non_small_cluster_idx], ClustLabel = unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx])
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = (PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))[non_small_cluster_idx], model_name_1 ="Model", model1 = (simMeanggCPP2_clust/sum(simMeanggCPP2_clust))[non_small_cluster_idx], PP_mass_VT[non_small_cluster_idx], SeroLabel = PP_serotype_comp[non_small_cluster_idx], VT_vec = PPcluster_VTs[non_small_cluster_idx], ClustLabel = unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx])
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = (PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3))[non_small_cluster_idx], model_name_1 ="Model", model1 = (simMeanggCPP3_clust/sum(simMeanggCPP3_clust))[non_small_cluster_idx], PP_mass_VT[non_small_cluster_idx], SeroLabel = PP_serotype_comp[non_small_cluster_idx], VT_vec = PPcluster_VTs[non_small_cluster_idx], ClustLabel = unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx])

# and all but new look
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_clust/sum(simMeanggCPP1_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PPcluster_VTs, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_clust/sum(simMeanggCPP2_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PPcluster_VTs, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_clust/sum(simMeanggCPP3_clust), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PPcluster_VTs, ClustLabel = unique(PopPUNK_clusters$Cluster))

#scale_fill_manual(values=c( "orange","#999999","#D32F2F"),labels = c("Mixed", "Non-Vaccine Types","Vaccine Types"))+theme_minimal() +


lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = (PP_mass_sero_freq_1)/sum((PP_mass_sero_freq_1)), model_name_1 ="Model", model1 = simMeanggCPP1_sero/sum(simMeanggCPP1_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT, ClustLabel = unique(PopPUNK_clusters$Serotype))
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_sero_freq_2/sum((PP_mass_sero_freq_2)), model_name_1 ="Model", model1 = simMeanggCPP2_sero/sum(simMeanggCPP2_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT, ClustLabel = unique(PopPUNK_clusters$Serotype))
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 =PP_mass_sero_freq_3/sum((PP_mass_sero_freq_3)), model_name_1 ="Model", model1 = simMeanggCPP3_sero/sum(simMeanggCPP3_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT, ClustLabel = unique(PopPUNK_clusters$Serotype))

#new look for serotypes as well
mass_VT_str <- sapply(mass_VT, function(x) if(x==1){"VT"}else{"NVT"})
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = (PP_mass_sero_freq_1)/sum((PP_mass_sero_freq_1)), model_name_1 ="Model", model1 = simMeanggCPP1_sero/sum(simMeanggCPP1_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT_str, ClustLabel = unique(PopPUNK_clusters$Serotype))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_sero_freq_2/sum((PP_mass_sero_freq_2)), model_name_1 ="Model", model1 = simMeanggCPP2_sero/sum(simMeanggCPP2_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT_str, ClustLabel = unique(PopPUNK_clusters$Serotype))
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 =PP_mass_sero_freq_3/sum((PP_mass_sero_freq_3)), model_name_1 ="Model", model1 = simMeanggCPP3_sero/sum(simMeanggCPP3_sero), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = mass_VT_str, ClustLabel = unique(PopPUNK_clusters$Serotype))


# collect confidence intervals for all clusters
simMeanggCPP3_matrix_clust_rel <- simMeanggCPP3_matrix_clust/colSums(simMeanggCPP3_matrix_clust)
empty_vec <- rep(0,PP_mass_clusters)
conf_intervals_Mass <- array(c(empty_vec,empty_vec),dim = c(PP_mass_clusters, 2))

for (i in 1:PP_mass_clusters) {
  ttest <- t.test(simMeanggCPP3_matrix_clust_rel[i,])
  conf_intervals_Mass[i,] <- c(ttest$conf.int[1], ttest$conf.int[2])
}

max_vals <- apply(simMeanggCPP3_matrix_clust_rel,1,max)
min_vals <- apply(simMeanggCPP3_matrix_clust_rel,1,min)

lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="lower_bound", model1 = conf_intervals_Mass[,1], model_name_2 ="upper_bound", model2 = conf_intervals_Mass[,2], VT_vec = PP_mass_VT, SeroLabel = PP_serotype_comp)



combined_compare(simMeanggCPP3_sero, PP_mass_sero_freq_3) + combined_compare(simMeanggCPP2_sero, PP_mass_sero_freq_2)
#-168.4656

# re-order this plot to make it look more like the sero-only model plot
sero_only_label_dict <- 1:length(unique(Mass_Samples_accCodes$Serotype))
names(sero_only_label_dict) <- unique(Mass_Samples_accCodes$Serotype)
sero_only_label_dict[unique(PopPUNK_clusters$Serotype)]
sero_only_label_dict[unique(PopPUNK_clusters$Serotype)]
strainsero_label_dict <- 1:length(unique(PopPUNK_clusters$Serotype))
names(strainsero_label_dict) <- unique(PopPUNK_clusters$Serotype)
strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]
unique(PopPUNK_clusters$Serotype)[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]]

lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 =(PP_mass_sero_freq_3/sum((PP_mass_sero_freq_3)))[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], model_name_1 ="Model", model1 = (simMeanggCPP3_sero/sum(simMeanggCPP3_sero))[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype)[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], VT_vec = mass_VT_str[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]], ClustLabel = unique(PopPUNK_clusters$Serotype)[strainsero_label_dict[unique(Mass_Samples_accCodes$Serotype)]])


#combined_compare(simMeanggCPP2_log,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3_log,PP_mass_cluster_freq_3)
#combined_compare(simMeanggCPP2,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3,PP_mass_cluster_freq_3)
```

```{r}
# Lollipop Plot for PPxSero Null model
PPxSero_Null <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_11/Mass_PPxSeroNull/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_Null_mcmc <- coda::as.mcmc(cbind(PPxSero_Null$probabilities, PPxSero_Null$pars))

rand_ind <- sample(x = 1:nrow(PPxSero_Null_mcmc), size = 1000, replace = FALSE)
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")
empty_vec <- rep(0,PP_mass_clusters)
cluster_samples_ParamVar_Null <- array(rep(empty_vec,length(rand_ind)),dim = c(length(rand_ind),PP_mass_clusters))

for (i in 1:length(rand_ind)) {
  pars <- PPxSero_Null_mcmc[rand_ind[i],4:5]
  
  fitPPxSero_params_Null <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -1000, prop_f = 1, delta = delta_ranking, m = pars[1], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = pars[2], vacc_time = 0)
  WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params_Null,
                         time = 0,
                         n_particles = 1L,
                         n_threads = 4L,
                         seed = 1L)
  cluster_samples_ParamVar_Null[i,] <- (WFmodel_ppxSero$run(72)[2:(PP_mass_clusters+1),])
}
```


```{r}
# Find variance from parameter variation
#Parameter fits
# Mass, 07.10.2024
PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_07/Mass_PPxSero_NewNewStart/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_mcmc <- coda::as.mcmc(cbind(PPxSero$probabilities, PPxSero$pars))

# Mass, 16.10.2024
PPxSero <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_16/Mass_PPxSero_NewStart/Mass_PPxSero_NewStart/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_mcmc <- coda::as.mcmc(cbind(PPxSero$probabilities, PPxSero$pars))

rand_ind <- sample(x = 1:nrow(PPxSero_mcmc), size = 1000, replace = FALSE)
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")
empty_vec <- rep(0,PP_mass_clusters)
cluster_samples_ParamVar <- array(rep(empty_vec,length(rand_ind)),dim = c(length(rand_ind),PP_mass_clusters))

for (i in 1:length(rand_ind)) {
  pars <- PPxSero_mcmc[rand_ind[i],4:7]
  
  fitPPxSero_params <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = pars[1], prop_f = pars[2], delta = delta_ranking, m = pars[3], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = pars[4], vacc_time = 0)
  WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params,
                         time = 0,
                         n_particles = 1L,
                         n_threads = 4L,
                         seed = 1L)
  cluster_samples_ParamVar[i,] <- (WFmodel_ppxSero$run(72)[2:(PP_mass_clusters+1),])
}

library(DescTools)
binom_conf_data <- t(sapply(PP_mass_cluster_freq_3, BinomCI, sum(PP_mass_cluster_freq_3,conf.level = 0.66)))
#BinomCI(PP_mass_cluster_freq_3[2], (sum(PP_mass_cluster_freq_3)))
plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,1], ylim = c(0,0.25),main="Binomial 66% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
for (i in 1:length(rand_ind)) {
  points(cluster_samples_ParamVar[i,]/sum(cluster_samples_ParamVar[i,]),col="red")
}

saveRDS(cluster_samples_ParamVar, "cluster_samples_ParamVar1000.rds")

empty_vec <- rep(0,PP_mass_clusters)
conf_intervals_Mass <- array(c(empty_vec,empty_vec),dim = c(PP_mass_clusters, 2))
cluster_samples_ParamVar_rel <- cluster_samples_ParamVar/rowSums(cluster_samples_ParamVar)

for (i in 1:PP_mass_clusters) {
  ttest <- t.test(cluster_samples_ParamVar_rel[,i])
  conf_intervals_Mass[i,] <- c(ttest$conf.int[1], ttest$conf.int[2])
}

sd_Mass_ParamSamples <- apply(cluster_samples_ParamVar_rel, 2,sd)
mean_Mass_ParamSamples <- apply(cluster_samples_ParamVar_rel,2,mean)
quantile_Mass_ParamSamples_up <- apply(cluster_samples_ParamVar_rel,2,quantile,.975)
quantile_Mass_ParamSamples_low <- apply(cluster_samples_ParamVar_rel,2,quantile,.025)

#investigate how many data values are within the 99, 75 and 50 percentile of the model
quantile_Mass_ParamSamples_up99 <- apply(cluster_samples_ParamVar_rel,2,quantile,.995)
quantile_Mass_ParamSamples_low99 <- apply(cluster_samples_ParamVar_rel,2,quantile,.005)
quantile_Mass_ParamSamples_up75 <- apply(cluster_samples_ParamVar_rel,2,quantile,.875)
quantile_Mass_ParamSamples_low75 <- apply(cluster_samples_ParamVar_rel,2,quantile,.125)
quantile_Mass_ParamSamples_up50 <- apply(cluster_samples_ParamVar_rel,2,quantile,0.75)
quantile_Mass_ParamSamples_low50 <- apply(cluster_samples_ParamVar_rel,2,quantile,.25)

mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
mass_cluster_freq_3_rel <- mass_cluster_freq_3/sum(mass_cluster_freq_3)

length(union(which((mass_cluster_freq_3_rel[non_small_cluster_idx]>quantile_Mass_ParamSamples_low99[non_small_cluster_idx])=="FALSE"),which((mass_cluster_freq_3_rel[non_small_cluster_idx]<quantile_Mass_ParamSamples_up99[non_small_cluster_idx])=="FALSE")))
# 14 of 21 are not
length(union(which((mass_cluster_freq_3_rel[non_small_cluster_idx]>quantile_Mass_ParamSamples_low75[non_small_cluster_idx])=="FALSE"),which((mass_cluster_freq_3_rel[non_small_cluster_idx]<quantile_Mass_ParamSamples_up75[non_small_cluster_idx])=="FALSE")))
# 18 of 21 are not
length(union(which((mass_cluster_freq_3_rel[non_small_cluster_idx]>quantile_Mass_ParamSamples_low50[non_small_cluster_idx])=="FALSE"),which((mass_cluster_freq_3_rel[non_small_cluster_idx]<quantile_Mass_ParamSamples_up50[non_small_cluster_idx])=="FALSE")))
# 21 of 21 are not

# that's not great.

plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,1], ylim = c(0,0.25),main="Binomial 66% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
points(mean_Mass_ParamSamples,col="red")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),quantile_Mass_ParamSamples_low, 1:length(unique(PopPUNK_clusters$Cluster)),quantile_Mass_ParamSamples_up, angle=90, code=3, length=0.06, col="red")

arrows(1:length(unique(PopPUNK_clusters$Cluster)),mean_Mass_ParamSamples + sd_Mass_ParamSamples, 1:length(unique(PopPUNK_clusters$Cluster)),mean_Mass_ParamSamples - sd_Mass_ParamSamples, angle=90, code=3, length=0.06, col="red")
#points(mean_Mass_ParamSamples + sd_Mass_ParamSamples,col="red")
#points(mean_Mass_ParamSamples - sd_Mass_ParamSamples,col="red")
binom_conf_data <- t(sapply(PP_mass_cluster_freq_3, BinomCI, sum(PP_mass_cluster_freq_3,conf.level = 0.66)))

data_and_model_with_errors <- data.frame(
  cluster=rep(unique(PopPUNK_clusters$Cluster),2),
  xvals = rep(1:length(unique(PopPUNK_clusters$Cluster)),2),
  condition = c(rep("Data",length(unique(PopPUNK_clusters$Cluster))),rep("Model",length(unique(PopPUNK_clusters$Cluster)))),
  values=c(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), mean_Mass_ParamSamples),
  upper=c(binom_conf_data[,2], quantile_Mass_ParamSamples_low),
  lower = c(binom_conf_data[,3], quantile_Mass_ParamSamples_up)
)

ggplot(data_and_model_with_errors, aes(fill=condition, y=values, x=xvals)) + 
    geom_bar(position="dodge", stat="identity") +
  geom_errorbar( aes(ymin=lower, ymax=upper), width=0.8, colour="black", alpha=0.9, size=1,position=position_dodge(.9)) +
  scale_x_continuous("Clusters", breaks = 1:(length(cluster)/2), labels = cluster[1:(length(cluster)/2)])



#repeat for null model
# first PPxSero Null fit (11.10.2024)
PPxSero_Null <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_11/Mass_PPxSeroNull/PPxSero_ggCaller_PopPUNK_det_pmcmc_run2.rds")
PPxSero_Null_mcmc <- coda::as.mcmc(cbind(PPxSero_Null$probabilities, PPxSero_Null$pars))

rand_ind <- sample(x = 1:nrow(PPxSero_Null_mcmc), size = 1000, replace = FALSE)
WF_PPxSero <- odin.dust::odin_dust("NFDS_Model_PPxSero.R")
empty_vec <- rep(0,PP_mass_clusters)
cluster_samples_ParamVar_Null <- array(rep(empty_vec,length(rand_ind)),dim = c(length(rand_ind),PP_mass_clusters))

for (i in 1:length(rand_ind)) {
  pars <- PPxSero_Null_mcmc[rand_ind[i],4:5]
  
  fitPPxSero_params_Null <- list(dt = 1/36, species_no = PP_mass_clusters, sero_no = length(unique(PopPUNK_clusters$Serotype)), gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = PPsero_startpop6, Pop_eq = as.double(rowSums(PPsero_startpop6)), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -1000, prop_f = 1, delta = delta_ranking, m = pars[1], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = pars[2], vacc_time = 0)
  WFmodel_ppxSero <- WF_PPxSero$new(pars = fitPPxSero_params_Null,
                         time = 0,
                         n_particles = 1L,
                         n_threads = 4L,
                         seed = 1L)
  cluster_samples_ParamVar_Null[i,] <- (WFmodel_ppxSero$run(72)[2:(PP_mass_clusters+1),])
}
saveRDS(cluster_samples_ParamVar_Null, "cluster_samples_ParamVar_Null1000.rds")

cluster_samples_ParamVar_Null_rel <- cluster_samples_ParamVar_Null/rowSums(cluster_samples_ParamVar_Null)

sd_Mass_ParamSamples_Null <- apply(cluster_samples_ParamVar_Null_rel, 2,sd)
mean_Mass_ParamSamples_Null <- apply(cluster_samples_ParamVar_Null_rel,2,mean)
quantile_Mass_ParamSamples_up_Null <- apply(cluster_samples_ParamVar_Null_rel,2,quantile,.975)
quantile_Mass_ParamSamples_low_Null <- apply(cluster_samples_ParamVar_Null_rel,2,quantile,.025)


data_and_model_with_errors_and_null <- data.frame(
  cluster=rep(unique(PopPUNK_clusters$Cluster),3),
  xvals = rep(1:length(unique(PopPUNK_clusters$Cluster)),3),
  group = c(rep("Data",length(unique(PopPUNK_clusters$Cluster))),rep("NFDS Model",length(unique(PopPUNK_clusters$Cluster))),rep("Null Model",length(unique(PopPUNK_clusters$Cluster)))),
  values=c(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), mean_Mass_ParamSamples, mean_Mass_ParamSamples_Null),
  upper=c(binom_conf_data[,2], quantile_Mass_ParamSamples_low,quantile_Mass_ParamSamples_low_Null),
  lower = c(binom_conf_data[,3], quantile_Mass_ParamSamples_up,quantile_Mass_ParamSamples_up_Null)
)

ggplot(data_and_model_with_errors_and_null, aes(fill=group, y=values, x=xvals)) + 
    geom_bar(position="dodge", stat="identity") +
  geom_errorbar( aes(ymin=lower, ymax=upper), width=0.8, colour="black", alpha=0.9, size=1,position=position_dodge(.9)) +
  scale_x_continuous("Clusters", breaks = 1:(length(cluster)/2), labels = cluster[1:(length(cluster)/2)]) +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9"))+theme_minimal()

Sero_mass_VT <- readRDS(file = "SeroVT.rds")
#PP_serotype_comp
#unique(PopPUNK_clusters$Serotype)
#PP_serotype_comp_vec
PPcluster_VTs <- rep("NVT", length(unique(PopPUNK_clusters$Cluster)))
for (i in 1:length(PP_serotype_comp_vec)) {
  clust_sero_no <- length(PP_serotype_comp_vec[[i]])
  cluster_sero_sum <- 0
  for (j in 1:length(PP_serotype_comp_vec[[i]])) {
    cluster_sero_sum <- cluster_sero_sum + Sero_mass_VT[which(unique(PopPUNK_clusters$Serotype) == PP_serotype_comp_vec[[i]][j])]
  }
  if(cluster_sero_sum == 0){
    PPcluster_VTs[i] <- "NVT"
  }
  else if(cluster_sero_sum == clust_sero_no){
    PPcluster_VTs[i] <- "VT"
  }
  else{
    PPcluster_VTs[i] <- "mixed"
  }
}

saveRDS(PPcluster_VTs, "PPcluster_VTs_3groups.rds")

#cluster that appear with more than 2.5% in at least one tp
non_small_cluster_idx <- sort(unique(c(which((PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1))>0.025), which((PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))>0.025), which((PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3))>0.025))))

data_and_model_with_errors_and_null_large_clusters <- data.frame(
  cluster=rep(unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx],3),
  xvals = rep(1:length(non_small_cluster_idx),3),
  Group = c(rep("Data",length(non_small_cluster_idx)),rep("NFDS Model",length(non_small_cluster_idx)),rep("Null Model",length(non_small_cluster_idx))),
  VT = rep(PPcluster_VTs[non_small_cluster_idx],3),
  values=c((PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3))[non_small_cluster_idx], mean_Mass_ParamSamples[non_small_cluster_idx], mean_Mass_ParamSamples_Null[non_small_cluster_idx]),
  upper=c(binom_conf_data[non_small_cluster_idx,2], quantile_Mass_ParamSamples_low[non_small_cluster_idx],quantile_Mass_ParamSamples_low_Null[non_small_cluster_idx]),
  lower = c(binom_conf_data[non_small_cluster_idx,3], quantile_Mass_ParamSamples_up[non_small_cluster_idx],quantile_Mass_ParamSamples_up_Null[non_small_cluster_idx])
)

ggplot(data_and_model_with_errors_and_null_large_clusters, aes(fill=Group, y=values, x=xvals)) + 
    geom_bar(position="dodge", stat="identity") +
  geom_errorbar( aes(ymin=lower, ymax=upper), width=0.8, colour="black", alpha=0.9, size=1,position=position_dodge(.9)) +
  scale_x_continuous("Strains", breaks = 1:(length(non_small_cluster_idx)), labels = unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx]) +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9"))+theme_minimal()

ggplot(data_and_model_with_errors_and_null_large_clusters, aes(fill = VT,y=values, x=xvals,group = Group, color = Group)) + 
    geom_bar(position = position_dodge(.9), stat="identity",size = 1.5) +
  geom_errorbar( aes(ymin=lower, ymax=upper), width=0.8, colour="black", alpha=0.9, size=1,position=position_dodge(.9)) +
  scale_x_continuous("Strains", breaks = 1:(length(non_small_cluster_idx)), labels = unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx]) +
  scale_fill_manual(values=c( "orange","#999999","#D32F2F"),labels = c("Mixed", "Non-Vaccine Types","Vaccine Types"))+theme_minimal() +
  scale_color_manual(values = c("black", "#0072B2", "#CC79A7"),labels = c("Data", "NFDS Model","Neutral Model")) +
  labs(x = "Strains", y = "Frequency") +
  ggtitle("Massachusetts 2007 Data vs. NFDS Model vs. Neutral Model\n with 66% binomial confidence intervals on data and 95th percentiles on model values") +  # Add the plot title
  theme(
    axis.title.x = element_text(size = 16),  # Increase x-axis label size
    axis.title.y = element_text(size = 16),  # Increase y-axis label size
    axis.text.x = element_text(size = 16),   # Increase x-axis tick label size
    axis.text.y = element_text(size = 16),    # Increase y-axis tick label size
    legend.text = element_text(size = 18),  # Increase legend text size
    legend.title = element_text(size = 18),  # Increase legend title size
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5)
  ) +
  ylim(0, 0.25)

#"#0072B2", "#D55E00", "#CC79A7"
```



```{r}
### plot data with errors!

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = (sqrt(PP_mass_cluster_freq_3) + PP_mass_cluster_freq_3)/sum(sqrt(PP_mass_cluster_freq_3) + PP_mass_cluster_freq_3), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT, ClustLabel = unique(PopPUNK_clusters$Cluster))
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = (PP_mass_cluster_freq_3 - sqrt(PP_mass_cluster_freq_3))/sum(PP_mass_cluster_freq_3 - sqrt(PP_mass_cluster_freq_3)), PP_mass_VT, SeroLabel = PP_serotype_comp, VT_vec = PP_mass_VT, ClustLabel = unique(PopPUNK_clusters$Cluster))


plot(1:length(unique(PopPUNK_clusters$Cluster)),PP_mass_cluster_freq_3, ylim=c(0,35), type="o", xlab="Concentration", ylab="Optical activity", main="Error bars on data points")

## draw arrows up and down of data points to show the error bars.
plot(1:length(unique(PopPUNK_clusters$Cluster)),PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), ylim = c(0,0.25))
arrows(1:length(unique(PopPUNK_clusters$Cluster)),(PP_mass_cluster_freq_3+sqrt(PP_mass_cluster_freq_3))/sum(PP_mass_cluster_freq_3), 1:length(unique(PopPUNK_clusters$Cluster)), (PP_mass_cluster_freq_3-sqrt(PP_mass_cluster_freq_3))/sum(PP_mass_cluster_freq_3), angle=90, code=3, length=0.06, col="black")
points(1:length(unique(PopPUNK_clusters$Cluster)),simMeanggCPP3_clust/sum(simMeanggCPP3_clust), col = "red",pch = 4)
#lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = colSums(PP_mass_cluster_freq_1_sero)/sum((PP_mass_cluster_freq_1_sero)), model_name_1 ="Model", model1 = colSums(PPsero_startpop6)/sum(PPsero_startpop6), rep(0, sero_no), SeroLabel = unique(PopPUNK_clusters$Serotype), VT_vec = rep(0, sero_no))

#with ggplot

# create data with errors data
data_with_errors <- data.frame(
  cluster=unique(PopPUNK_clusters$Cluster),
  xvals = 1:length(unique(PopPUNK_clusters$Cluster)),
  data=PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3),
  sd=sqrt(PP_mass_cluster_freq_3)/sum(PP_mass_cluster_freq_3),
  model=simMeanggCPP3_clust/sum(simMeanggCPP3_clust),
  model_sd = sqrt(simMeanggCPP3_clust)/sum(simMeanggCPP3_clust)
)
 
# Most basic error bar
ggplot(data_with_errors) +
    geom_bar( aes(x=xvals, y=data), stat="identity", fill="black", alpha=0.5) +
    geom_errorbar( aes(x=xvals, ymin=data-sd, ymax=data+sd), width=0.4, colour="black", alpha=0.9, size=1.3) +
    geom_point(aes(x=xvals, y=model), colour="red", shape = 19, size=3)

ggplot(data_with_errors) +
    geom_point( aes(x=xvals, y=data), stat="identity", colour="black", alpha=0.9) +
    geom_errorbar( aes(x=xvals, ymin=data-sd, ymax=data+sd), width=0.4, colour="black", alpha=0.9, size=1.3) +
    geom_point(aes(x=xvals, y=model), colour="red", shape = 4)

# Most basic error bar
ggplot(data_with_errors) +
    geom_bar( aes(x=xvals, y=data), stat="identity", fill="black", alpha=0.7) +
    geom_errorbar( aes(x=xvals, ymin=data-sd, ymax=data+sd), width=0.4, colour="black", alpha=0.9, size=1.3) +
    geom_bar( aes(x=xvals+0.5, y=model), stat="identity", fill="black", alpha=0.7) +
    geom_errorbar( aes(x=xvals+0.5, ymin=model-model_sd, ymax=model+model_sd), width=0.4, colour="black", alpha=0.9, size=1.3)


#install.packages("DescTools")
library(DescTools)
multinom_conf_data <- MultinomCI(PP_mass_cluster_freq_3, conf.level = 0.66)
plot(1:length(unique(PopPUNK_clusters$Cluster)),multinom_conf_data[,1], ylim = c(0,0.25),main="Multinomial 66% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),multinom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), multinom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
points(1:length(unique(PopPUNK_clusters$Cluster)),simMeanggCPP3_clust/sum(simMeanggCPP3_clust), col = "red",pch = 4)
axis(1, at=1:length(unique(PopPUNK_clusters$Cluster)), labels=unique(PopPUNK_clusters$Cluster))

binom_conf_data <- t(sapply(PP_mass_cluster_freq_3, BinomCI, sum(PP_mass_cluster_freq_3,conf.level = 0.66)))
#BinomCI(PP_mass_cluster_freq_3[2], (sum(PP_mass_cluster_freq_3)))
plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,1], ylim = c(0,0.25),main="Binomial 66% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
points(1:length(unique(PopPUNK_clusters$Cluster)),simMeanggCPP3_clust/sum(simMeanggCPP3_clust), col = "red",pch = 4)
axis(1, at=1:length(unique(PopPUNK_clusters$Cluster)), labels=unique(PopPUNK_clusters$Cluster))

binom_conf_data_1 <- t(sapply(PP_mass_cluster_freq_1, BinomCI, sum(PP_mass_cluster_freq_1),conf.level = 0.66))
binom_conf_data_2 <- t(sapply(PP_mass_cluster_freq_2, BinomCI, sum(PP_mass_cluster_freq_2),conf.level = 0.66))
binom_conf_data_3 <- t(sapply(PP_mass_cluster_freq_3, BinomCI, sum(PP_mass_cluster_freq_3),conf.level = 0.66))
plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data_3[,1], ylim = c(0,0.25),main="Data over time and with confidence intervals", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data_3[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data_3[,3], angle=90, code=3, length=0.06, col="black")
points((1:length(unique(PopPUNK_clusters$Cluster))-0.4),binom_conf_data_1[,1], col = "#E69F00")
arrows((1:length(unique(PopPUNK_clusters$Cluster))-0.4),binom_conf_data_1[,2], (1:length(unique(PopPUNK_clusters$Cluster))-0.4), binom_conf_data_1[,3], angle=90, code=3, length=0.06, col="#E69F00")
points((1:length(unique(PopPUNK_clusters$Cluster))-0.2),binom_conf_data_2[,1], col = "#56B4E9")
arrows((1:length(unique(PopPUNK_clusters$Cluster))-0.2),binom_conf_data_2[,2], (1:length(unique(PopPUNK_clusters$Cluster))-0.2), binom_conf_data_2[,3], angle=90, code=3, length=0.06, col="#56B4E9")
axis(1, at=1:length(unique(PopPUNK_clusters$Cluster)), labels=unique(PopPUNK_clusters$Cluster))
legend("topright", title = "Time", c("2001", "2004","2007"),col = c("#E69F00","#56B4E9","black"), cex = 2, lty=1)



only_data_with_errors_3times <- data.frame(
  cluster=rep(unique(PopPUNK_clusters$Cluster)[non_small_cluster_idx],3),
  xvals = rep(1:length(non_small_cluster_idx),3),
  Group = c(rep("2001",length(non_small_cluster_idx)),rep("2004",length(non_small_cluster_idx)),rep("2007",length(non_small_cluster_idx))),
  VT = rep(PPcluster_VTs[non_small_cluster_idx],3),
  values=c(binom_conf_data_1[non_small_cluster_idx,1], binom_conf_data_2[non_small_cluster_idx,1], binom_conf_data_3[non_small_cluster_idx,1]),
  upper=c(binom_conf_data_1[non_small_cluster_idx,2], binom_conf_data_2[non_small_cluster_idx,2],binom_conf_data_3[non_small_cluster_idx,2]),
  lower = c(binom_conf_data_1[non_small_cluster_idx,3], binom_conf_data_2[non_small_cluster_idx,3],binom_conf_data_3[non_small_cluster_idx,3])
)

ggplot(only_data_with_errors_3times, aes(fill=Group, y=values, x=xvals)) + 
    geom_bar(position="dodge", stat="identity") +
  geom_errorbar( aes(ymin=lower, ymax=upper), width=0.8, colour="black", alpha=0.9, size=1,position=position_dodge(.9)) +
  scale_x_continuous("Strains", breaks = 1:(length(non_small_cluster_idx)), labels = cluster[1:(length(non_small_cluster_idx))]) +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9"))+theme_minimal()

ggplot(only_data_with_errors_3times, aes(fill = VT,y=values, x=xvals,group = Group, color = Group)) + 
    geom_bar(position = position_dodge(.9), stat="identity",size = 1.5) +
  geom_errorbar( aes(ymin=lower, ymax=upper), width=0.8, colour="black", alpha=0.9, size=1,position=position_dodge(.9)) +
  scale_x_continuous("Strains", breaks = 1:(length(non_small_cluster_idx)), labels = cluster[1:(length(non_small_cluster_idx))]) +
  scale_fill_manual(values=c( "orange","#999999","#D32F2F"),labels = c("Mixed", "Non-Vaccine Types","Vaccine Types"))+theme_minimal() +
  scale_color_manual(values = c("#00000040", "#00000070", "#000000"),labels = c("2001", "2004","2007")) +
  labs(x = "Strains", y = "Frequency") +
  ggtitle("Massachusetts Data 2001, 2004, and 2007 \n with 66% binomial confidence intervals") +  # Add the plot title
  theme(
    axis.title.x = element_text(size = 16),  # Increase x-axis label size
    axis.title.y = element_text(size = 16),  # Increase y-axis label size
    axis.text.x = element_text(size = 14),   # Increase x-axis tick label size
    axis.text.y = element_text(size = 14),    # Increase y-axis tick label size
    legend.text = element_text(size = 12),  # Increase legend text size
    legend.title = element_text(size = 14),  # Increase legend title size
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5)
  ) +
  ylim(0, 0.25)



#95% conf interval
multinom_conf_data <- MultinomCI(PP_mass_cluster_freq_3, conf.level = 0.95)
plot(1:length(unique(PopPUNK_clusters$Cluster)),multinom_conf_data[,1], ylim = c(0,0.25),main="Multinomial 95% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),multinom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), multinom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
points(1:length(unique(PopPUNK_clusters$Cluster)),simMeanggCPP3_clust/sum(simMeanggCPP3_clust), col = "red",pch = 4)
axis(1, at=1:length(unique(PopPUNK_clusters$Cluster)), labels=unique(PopPUNK_clusters$Cluster))

binom_conf_data <- t(sapply(PP_mass_cluster_freq_3, BinomCI, sum(PP_mass_cluster_freq_3),conf.level = 0.95))
#BinomCI(PP_mass_cluster_freq_3[2], (sum(PP_mass_cluster_freq_3)))
plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,1], ylim = c(0,0.25),main="Binomial 95% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
points(1:length(unique(PopPUNK_clusters$Cluster)),simMeanggCPP3_clust/sum(simMeanggCPP3_clust), col = "red",pch = 4)
axis(1, at=1:length(unique(PopPUNK_clusters$Cluster)), labels=unique(PopPUNK_clusters$Cluster))
points(1:length(unique(PopPUNK_clusters$Cluster)),max_vals, col = "red",pch = 1)
points(1:length(unique(PopPUNK_clusters$Cluster)),min_vals, col = "red",pch = 1)
points(1:length(unique(PopPUNK_clusters$Cluster)),conf_intervals_Mass[,1], col = "red",pch = 1)
points(1:length(unique(PopPUNK_clusters$Cluster)),conf_intervals_Mass[,2], col = "red",pch = 1)


plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,1], ylim = c(0,0.25),main="Binomial 66% conf. intervals on data vs model", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data[,3], angle=90, code=3, length=0.06, col="black")
points(1:length(unique(PopPUNK_clusters$Cluster)),simMeanggCPP3_clust/sum(simMeanggCPP3_clust), col = "red",pch = 4)
axis(1, at=1:length(unique(PopPUNK_clusters$Cluster)), labels=unique(PopPUNK_clusters$Cluster))
#points(1:length(unique(PopPUNK_clusters$Cluster)),max_vals, col = "red",pch = 1)
#points(1:length(unique(PopPUNK_clusters$Cluster)),min_vals, col = "red",pch = 1)
points(1:length(unique(PopPUNK_clusters$Cluster)),conf_intervals_Mass[,1], col = "red",pch = 1)
points(1:length(unique(PopPUNK_clusters$Cluster)),conf_intervals_Mass[,2], col = "red",pch = 1)


plot(multinom_conf_data[,2], type = "l", ylim = c(0,0.25))
lines(binom_conf_data[,2], col = "red")

plot(multinom_conf_data[,2], type = "l", ylim = c(0,0.25))
lines(binom_conf_data[,1], col = "blue")
lines(multinom_conf_data[,3], col = "red")
lines(binom_conf_data[,2], lty = 2)
lines(binom_conf_data[,3], col = "red", lty = 2)
legend("topright", title = "66% Conf. Intervals", c("Upper", "Lower"),col = c("red", "black"), cex = 2, lty=1:2)

plot(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,1], ylim = c(0,0.25),main="Binomial and Multinomial 66% conf. intervals of data", xaxt = "n", xlab = "Clusters", ylab = "Frequency")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),binom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), binom_conf_data[,3], angle=90, code=3, length=0.1, col="#E69F00")
arrows(1:length(unique(PopPUNK_clusters$Cluster)),multinom_conf_data[,2], 1:length(unique(PopPUNK_clusters$Cluster)), multinom_conf_data[,3], angle=90, code=3, length=0.1, col="#56B4E9")
legend("topright", title = "66% Conf. Intervals", c("Data", "Binomial","Multinomial"),col = c("black","#E69F00","#56B4E9"), cex = 2, lty=1)


```

```{r}
# calculate precision
PPcluster_VTs <- readRDS("PPcluster_VTs_3groups.rds")
# maybe coefficient of variation (CV)? that is sigma/mu 
#for model
cluster_samples_ParamVar <- readRDS("cluster_samples_ParamVar1000.rds")
cluster_samples_ParamVar_rel <- cluster_samples_ParamVar/rowSums(cluster_samples_ParamVar)
sd_Mass_ParamSamples <- apply(cluster_samples_ParamVar_rel, 2,sd)
mean_Mass_ParamSamples <- apply(cluster_samples_ParamVar_rel,2,mean)
sd_Mass_ParamSamples/mean_Mass_ParamSamples

mean_Mass_ParamSamples_Null <- apply(cluster_samples_ParamVar_Null_rel,2,mean)

# for data
# draw vectors from data distribution
mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
mass_cluster_freq_3_rel <- mass_cluster_freq_3/sum(mass_cluster_freq_3)
data_range <- t(rmultinom(1000,sum(mass_cluster_freq_3),mass_cluster_freq_3/sum(mass_cluster_freq_3)))
data_range_rel <- data_range/rowSums(data_range)
sd_Mass_data <- apply(data_range_rel, 2,sd)
mean_Mass_data <- apply(data_range_rel,2,mean)
sd_Mass_data/mean_Mass_data

# percent error
(mass_cluster_freq_3_rel - mean_Mass_ParamSamples)/mass_cluster_freq_3_rel*100
#does not work because of clusters of size 0
(mass_cluster_freq_3_rel - mean_Mass_ParamSamples)/mean_Mass_ParamSamples

# abs error
abs_error <- abs(mean_Mass_ParamSamples - mass_cluster_freq_3_rel)

plot(mass_cluster_freq_3_rel)
plot(abs_error, xlab = "Clusters")

plot(mass_cluster_freq_3_rel[which(PPcluster_VTs=="VT")], abs_error[which(PPcluster_VTs=="VT")], col = "red", ylim = c(0,0.025), xlim = c(0,0.1), ylab = "Absolute error", xlab = "Cluster frequency")
points(mass_cluster_freq_3_rel[which(PPcluster_VTs=="mixed")], abs_error[which(PPcluster_VTs=="mixed")], col = "orange")
points(mass_cluster_freq_3_rel[which(PPcluster_VTs=="NVT")], abs_error[which(PPcluster_VTs=="NVT")], col = "black")
# Add a legend
legend(0.08, 0.025, legend=c("VT", "mixed","NVT"),
       col=c("red", "orange","black"),lty = 1, cex=1.2)
# abs error and cluster size seem to be correlated, at least for the NVTs 

#rel error for those that are not zero
rel_error <- abs(mean_Mass_ParamSamples[which(mass_cluster_freq_3_rel!=0)] - mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)])/(mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)])

rel_error_VT <- abs(mean_Mass_ParamSamples[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="VT"))] - mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="VT"))])/(mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="VT"))])
rel_error_NVT <- abs(mean_Mass_ParamSamples[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="NVT"))] - mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="NVT"))])/(mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="NVT"))])
rel_error_mixed <- abs(mean_Mass_ParamSamples[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="mixed"))] - mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="mixed"))])/(mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="mixed"))])

plot(mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="VT"))], rel_error_VT, col = "red", ylim = c(0,3.2), xlim = c(0,0.2))
points(mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="NVT"))], rel_error_NVT, col = "black")
points(mass_cluster_freq_3_rel[intersect(which(mass_cluster_freq_3_rel!=0), which(PPcluster_VTs=="mixed"))], rel_error_mixed, col = "orange")

# average deviation
abs_deviation <- abs(cluster_samples_ParamVar_rel - matrix(rep(mean_Mass_ParamSamples,1000), nrow = 1000, ncol = 55, byrow = TRUE))
average_deviation <- colMeans(abs_deviation)
plot(average_deviation)
plot(mean_Mass_ParamSamples,average_deviation) #clear correlation: smaller clusters: higher precision
plot(mean_Mass_ParamSamples[which(PPcluster_VTs=="VT")], average_deviation[which(PPcluster_VTs=="VT")], col = "red", ylim = c(0,0.007), xlim = c(0,0.15))
points(mean_Mass_ParamSamples[which(PPcluster_VTs=="mixed")], average_deviation[which(PPcluster_VTs=="mixed")], col = "orange")
points(mean_Mass_ParamSamples[which(PPcluster_VTs=="NVT")], average_deviation[which(PPcluster_VTs=="NVT")], col = "black")

# average deviation of data
abs_deviation_data <- abs(data_range_rel - matrix(rep(mean_Mass_data,1000), nrow = 1000, ncol = 55, byrow = TRUE))
average_deviation_data <- colMeans(abs_deviation_data)
plot(average_deviation_data)
points(average_deviation, col="red")

library(XNomial)
xmulti(mean_Mass_ParamSamples[which(mass_cluster_freq_3_rel!=0)], mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)])
xmonte((mean_Mass_ParamSamples[which(mass_cluster_freq_3_rel!=0)])/sum(mean_Mass_ParamSamples[which(mass_cluster_freq_3_rel!=0)])*sum(mass_cluster_freq_3), mass_cluster_freq_3[which(mass_cluster_freq_3_rel!=0)], histobins=T)

# need to have counts, not relative frequencies
xmonte(apply(data_range,2,mean)[which(mass_cluster_freq_3_rel!=0)], mass_cluster_freq_3[which(mass_cluster_freq_3_rel!=0)])


# I thought I could compare whether model and data come from the same multinomial distribution (using a chi-square test) but I don't think that makes much sense
# Perform Chi-Square test
chi_sq_result <- chisq.test((colMeans(cluster_samples_ParamVar))[which(mass_cluster_freq_3_rel!=0)],p =(mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)])/sum(mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)]))
print(chi_sq_result)
#hmm, it is quite sure that the model values are not distributed as the data
chi_sq_result <- chisq.test((colMeans(cluster_samples_ParamVar)), p =(colMeans(cluster_samples_ParamVar))/sum(colMeans(cluster_samples_ParamVar)))
print(chi_sq_result)

chi_sq_result <- chisq.test(((colMeans(data_range)))[which(mass_cluster_freq_3_rel!=0)], p =(mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)])/sum(mass_cluster_freq_3_rel[which(mass_cluster_freq_3_rel!=0)]))
print(chi_sq_result)

observed <- as.vector(cont_table)
expected <- chi_sq_result$expected


# compare cluster changes model and data
cluster_change_model <- mean_Mass_ParamSamples - mass_cluster_freq_1/sum(mass_cluster_freq_1)
cluster_change_data <- mass_cluster_freq_3/sum(mass_cluster_freq_3) - mass_cluster_freq_1/sum(mass_cluster_freq_1)
plot(cluster_change_data)

plot(mass_cluster_freq_3_rel[order(cluster_change_data, decreasing = TRUE)])
points(mean_Mass_ParamSamples[order(cluster_change_data, decreasing = TRUE)], col = "red")

PPcluster_VTs_cols <- rep("red",length(PPcluster_VTs))
PPcluster_VTs_cols[which(PPcluster_VTs == "NVT")] <- "black"
PPcluster_VTs_cols[which(PPcluster_VTs == "mixed")] <- "orange"
plot(sort(cluster_change_data, decreasing = TRUE), col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
abline(h=0, lty = 2)
points(cluster_change_model[order(cluster_change_data, decreasing = TRUE)], pch = 4, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
# Add a legend
legend(40, 0.075, legend=c("Data VT", "Model VT", "Data mixed","Model mixed","Data NVT", "Model NVT"),
       col=c("red","red","orange", "orange","black", "black"),pch = c(1,4), cex=1.2)


cluster_nullprorata <- mass_cluster_freq_1
cluster_nullprorata[which(PPcluster_VTs == "VT")] <- 0
cluster_change_nullprorata <- cluster_nullprorata/sum(cluster_nullprorata) - mass_cluster_freq_1/sum(mass_cluster_freq_1)

#normal null model 
cluster_change_model_null <- mean_Mass_ParamSamples_Null - mass_cluster_freq_1/sum(mass_cluster_freq_1)


plot(sort(cluster_change_data, decreasing = TRUE), col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2,xaxt = "n", xlab = "Cluster")
axis(1, at = 1:length(cluster_change_data), labels = unique(PopPUNK_clusters$Cluster)[order(cluster_change_data, decreasing = TRUE)])
abline(h=0, lty = 2)
points(cluster_change_model[order(cluster_change_data, decreasing = TRUE)], pch = 4, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
points(cluster_change_nullprorata[order(cluster_change_data, decreasing = TRUE)], pch = 2, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
# Add a legend
legend(0, -0.025, legend=c("Data VT", "Model VT", "Null pro rata VT", "Data mixed","Model mixed","Null pro rata mixed","Data NVT", "Model NVT","Null pro rata NVT"),
       col=c("red","red","red", "orange","orange", "orange","black", "black","black"),pch = c(1,4,2), cex=1)

plot(sort(cluster_change_data, decreasing = TRUE), col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2,xaxt = "n", xlab = "Cluster")
axis(1, at = 1:length(cluster_change_data), labels = unique(PopPUNK_clusters$Cluster)[order(cluster_change_data, decreasing = TRUE)])
abline(h=0, lty = 2)
points(cluster_change_model[order(cluster_change_data, decreasing = TRUE)], pch = 4, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
points(cluster_change_model_null[order(cluster_change_data, decreasing = TRUE)], pch = 2, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
# Add a legend
legend(0, -0.025, legend=c("Data VT", "Model VT", "Null Model VT", "Data mixed","Model mixed","Null Model mixed","Data NVT", "Model NVT","Null Model NVT"),
       col=c("red","red","red", "orange","orange", "orange","black", "black","black"),pch = c(1,4,2), cex=1)


#plot(sort(cluster_change_data, decreasing = TRUE), col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)

plot(-(sort(cluster_change_data, decreasing = TRUE) - cluster_change_model[order(cluster_change_data, decreasing = TRUE)]), pch = 4, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2, ylim = c(-0.1, 0.1),xaxt = "n", xlab = "Cluster")
axis(1, at = 1:length(cluster_change_data), labels = unique(PopPUNK_clusters$Cluster)[order(cluster_change_data, decreasing = TRUE)])
abline(h=0, lty = 2)
points(-(sort(cluster_change_data, decreasing = TRUE) - cluster_change_nullprorata[order(cluster_change_data, decreasing = TRUE)]), pch = 2, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
# Add a legend
legend(0, 0.1, legend=c("Data VT", "Model VT", "Null pro rata VT", "Data mixed","Model mixed","Null pro rata mixed","Data NVT", "Model NVT","Null pro rata NVT"),
       col=c("red","red","red", "orange","orange", "orange","black", "black","black"),pch = c(1,4,2), cex=1)

# with my standard null model (not pro rata)
plot(-(sort(cluster_change_data, decreasing = TRUE) - cluster_change_model[order(cluster_change_data, decreasing = TRUE)]), pch = 4, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2, ylim = c(-0.1, 0.1),xaxt = "n", xlab = "Cluster")
axis(1, at = 1:length(cluster_change_data), labels = unique(PopPUNK_clusters$Cluster)[order(cluster_change_data, decreasing = TRUE)])
abline(h=0, lty = 2)
points(-(sort(cluster_change_data, decreasing = TRUE) - cluster_change_model_null[order(cluster_change_data, decreasing = TRUE)]), pch = 2, col = PPcluster_VTs_cols[order(cluster_change_data, decreasing = TRUE)], cex = 1.2)
# Add a legend
legend(0, 0.1, legend=c("Data VT", "Model VT", "Null pro rata VT", "Data mixed","Model mixed","Null pro rata mixed","Data NVT", "Model NVT","Null pro rata NVT"),
       col=c("red","red","red", "orange","orange", "orange","black", "black","black"),pch = c(1,4,2), cex=1)


# data and model sorted by model
plot(cluster_change_data[order(cluster_change_model, decreasing = TRUE)], col = PPcluster_VTs_cols[order(cluster_change_model, decreasing = TRUE)], cex = 1.2,xaxt = "n", xlab = "Cluster")
axis(1, at = 1:length(cluster_change_data), labels = unique(PopPUNK_clusters$Cluster)[order(cluster_change_model, decreasing = TRUE)])
abline(h=0, lty = 2)
points(cluster_change_model[order(cluster_change_model, decreasing = TRUE)], pch = 4, col = PPcluster_VTs_cols[order(cluster_change_model, decreasing = TRUE)], cex = 1.2)

# for null model
plot(cluster_change_data[order(cluster_change_model_null, decreasing = TRUE)], col = PPcluster_VTs_cols[order(cluster_change_model_null, decreasing = TRUE)], cex = 1.2,xaxt = "n", xlab = "Cluster")
axis(1, at = 1:length(cluster_change_data), labels = unique(PopPUNK_clusters$Cluster)[order(cluster_change_model_null, decreasing = TRUE)])
abline(h=0, lty = 2)
points(cluster_change_model_null[order(cluster_change_model_null, decreasing = TRUE)], pch = 2, col = PPcluster_VTs_cols[order(cluster_change_model_null, decreasing = TRUE)], cex = 1.2)
```



```{r}
# 1st fit Nepal GPS1+2
#Parameter fits
Nepal_mcmc2 <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_02/Nepal_1stFit/Nepal_ggCaller_PopPUNK_det_pmcmc_run2.rds")
Nepal_mcmc2mcmc <- coda::as.mcmc(cbind(Nepal_mcmc2$probabilities, Nepal_mcmc2$pars))
coda::effectiveSize(Nepal_mcmc2mcmc)
summary(coda::as.mcmc(Nepal_mcmc2mcmc))
library(bayestestR)
map_estimate(Nepal_mcmc2$pars)
# sigma_f -1.38e-03, prop_f 0.04, m -3.07, v 0.02
```

```{r}
#investigate fit of Sero model
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
  intermed_gene_presence_absence_consensus <- readRDS(file = "ggCsero_intermed_gene_presence_absence_consensus.rds")
  intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
  model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
  delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
  mass_cluster_freq_1 <- readRDS(file = "Sero_freq_1.rds")
  mass_cluster_freq_2 <- readRDS(file = "Sero_freq_2.rds")
  mass_cluster_freq_3 <- readRDS(file = "Sero_freq_3.rds")
  mass_VT <- readRDS(file = "Sero_mass_VT.rds")
  mass_clusters <- length(unique(seq_clusters$Serotype))
  avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
  output_filename <- "ggCaller_Serotype"
  peripost_mass_cluster_freq <- data.frame("year" = c(1, 2), rbind(mass_cluster_freq_2, mass_cluster_freq_3))
  names(peripost_mass_cluster_freq) <- c("year", as.character(1:mass_clusters))
  dt <- 1/36
  vacc_time <- 0
  Sero_freq_names <- readRDS(file = "Sero_freq_names.rds")
  
# fit from 04.10.2024
Sero_fit <- readRDS("/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_10_04/Comparison_BioinfTools_Mass/TAC_SerotypeModel/ggCaller_Serotype_det_pmcmc_run2.rds")
Sero_fit_mcmc <- coda::as.mcmc(cbind(Sero_fit$probabilities, Sero_fit$pars))
coda::effectiveSize(Sero_fit_mcmc)
summary(coda::as.mcmc(Sero_fit_mcmc))
library(bayestestR)
map_estimate(Sero_fit$pars)
# sigma_f -2.83, prop_f 0.14, m -5.67, v 0.08

fitSero_params <- list(dt = 1/36, species_no = mass_clusters, gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = -2.83, prop_f = 0.14, sigma_w = -1000, delta = delta_ranking, m = -5.67, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.08, vacc_time = 0)

WF_Sero <- odin.dust::odin_dust("NFDS_Model.R")
WFmodel_Sero <- WF_Sero$new(pars = fitSero_params,
                         time = 0,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanggCPP1_sero <- rowMeans(WFmodel_Sero$run(0)[-1,])
simMeanggCPP2_sero <- rowMeans(WFmodel_Sero$run(36)[-1,])
simMeanggCPP3_sero <- rowMeans(WFmodel_Sero$run(72)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_sero/sum(simMeanggCPP1_sero), mass_VT, SeroLabel = unique(seq_clusters$Serotype), VT_vec = mass_VT)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_2/sum(mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_sero/sum(simMeanggCPP2_sero), mass_VT, SeroLabel = unique(seq_clusters$Serotype), VT_vec = mass_VT)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_sero/sum(simMeanggCPP3_sero), mass_VT, SeroLabel = unique(seq_clusters$Serotype), VT_vec = mass_VT)

mass_VT_str <- sapply(mass_VT, function(x) if(x==1){"VT"}else{"NVT"})
# new lollipop plot version
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_1/sum(mass_cluster_freq_1), model_name_1 ="Model", model1 = simMeanggCPP1_sero/sum(simMeanggCPP1_sero), mass_VT, SeroLabel = unique(seq_clusters$Serotype), VT_vec = mass_VT_str)
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_2/sum(mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_sero/sum(simMeanggCPP2_sero), mass_VT, SeroLabel = unique(seq_clusters$Serotype), VT_vec = mass_VT_str)
lollipop_cluster_freqs_VTandNVT_labelSero_TAC(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = mass_cluster_freq_3/sum(mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_sero/sum(simMeanggCPP3_sero), mass_VT, SeroLabel = unique(seq_clusters$Serotype), VT_vec = mass_VT_str)

combined_compare(simMeanggCPP2_sero, mass_cluster_freq_2) + combined_compare(simMeanggCPP3_sero, mass_cluster_freq_3)
#[1] -179.7438
```

```{r}
#NB
# found a note from Dan Weinberger's talk (03.07.2024) in our lab: he said that the serotype prevalence stays the same pre/post vaccine
# i.e. the serotypes get swapped out but the most common is at a certain freq, the second at another, and so on
# Zipf's law?
plot(sort(PP_mass_sero_freq_1, decreasing = TRUE)/sum(PP_mass_sero_freq_1))
points(sort(PP_mass_sero_freq_2, decreasing = TRUE)/sum(PP_mass_sero_freq_2), col = "blue")
points(sort(PP_mass_sero_freq_3, decreasing = TRUE)/sum(PP_mass_sero_freq_3), col = "red")

# well, I don't know. maybe ish.
# could try that on other datasets
```

